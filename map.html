<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¹œêµ¬ ìœ„ì¹˜ ê³µìœ </title>
    
    <!-- 1. ê¾¸ë¯¸ê¸° ë„êµ¬ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ì§€ë„ ë„êµ¬ (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 3. ì•„ì´ì½˜ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* íŒŒìŠ¤í…” í†¤ ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ */
        .glass { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .hide { display: none !important; }
        
        /* ë§ˆì»¤ ìŠ¤íƒ€ì¼ (ì• í”Œ ì§€ë„ ëŠë‚Œì˜ ê¹”ë”í•œ í•€) */
        .custom-div-icon { background: transparent; border: none; }
        .emoji-marker { background-color: white; border-radius: 50%; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 26px; margin-left: -22px; margin-top: -22px; border: 2.5px solid white; transition: transform 0.2s; }
        .emoji-marker:active { transform: scale(0.9); }
        .marker-name { text-align: center; font-size: 11px; font-weight: bold; background: rgba(255,255,255,0.95); padding: 4px 8px; border-radius: 12px; margin-top: 6px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; transform: translateX(-5px); color: #333; border: 1px solid rgba(0,0,0,0.05); }
        
        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ì˜¨ë¼ì¸ ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ */
        .online-dot { width: 10px; height: 10px; background-color: #22c55e; border-radius: 50%; display: inline-block; border: 2px solid white; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); animation: pulse-green 2s infinite; }
        .offline-dot { width: 10px; height: 10px; background-color: #9ca3af; border-radius: 50%; display: inline-block; border: 2px solid white; }
        
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 4px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
    </style>
</head>
<!-- ë°°ê²½: ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…” ê·¸ë¼ë°ì´ì…˜ -->
<body class="bg-gradient-to-br from-[#E8F0FE] via-[#F3E8FF] to-[#E8F8F5] min-h-screen pb-24 overflow-x-hidden select-none">

    <!-- === ë¡œê·¸ì¸ í™”ë©´ (ëª¨ë‹¬) === -->
    <div id="login-modal" class="fixed inset-0 z-[999] bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-6 transition-opacity duration-300">
        <div class="bg-white/95 w-full max-w-sm rounded-[32px] p-8 shadow-2xl border border-white transform transition-all scale-100">
            <div class="flex flex-col items-center mb-6">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                    <i data-lucide="lock" class="text-blue-500 w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">ë‹¹ì‹ ì€ ëˆ„êµ¬ì‹­ë‹ˆê¹Œ?</h2>
                <p class="text-gray-500 text-sm mt-2 text-center">ìš°ë¦¬ 6ëª…ë§Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆì–´ìš”.<br>(ì „ì‹œê¸°, ì˜¤ìŠ¤í‹´, ì´ì§„ëˆ„, ì„±ì›ì œ, ë¥˜ì§±, í™ë°•ì‚¬)</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="login-input" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full bg-gray-100 border-none rounded-2xl px-5 py-4 text-center text-lg font-bold focus:ring-2 focus:ring-blue-500 outline-none placeholder-gray-400">
                <p id="login-error" class="text-red-500 text-xs text-center font-bold h-4"></p>
                <button onclick="tryLogin()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                    ì…ì¥í•˜ê¸° <i data-lucide="log-in" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- === ë©”ì¸ ì•± í™”ë©´ === -->
    <div id="app-content" class="hide animate-fade-in">
        
        <!-- í—¤ë” -->
        <div class="px-6 pt-12 pb-6 flex justify-between items-start">
            <div>
                <h1 id="page-title" class="text-2xl font-bold text-gray-800 leading-snug">ìš°ë¦¬ ì¹œêµ¬ë“¤,<br>ì§€ê¸ˆ ì–´ë”” ìˆë‚˜ìš”? ğŸŒ™</h1>
            </div>
            <div class="flex gap-2 mt-1">
                <div class="opacity-50 animate-pulse text-2xl">âœ¨</div>
            </div>
        </div>

        <div class="px-5 space-y-4">
            
            <!-- [MAP] íƒ­ (ê¸°ë³¸ í™”ë©´) -->
            <div id="view-map" class="space-y-4">
                <div class="h-[65vh] w-full rounded-[32px] overflow-hidden shadow-lg border border-white/60 relative z-0 bg-gray-100">
                    <div id="map" class="w-full h-full z-0"></div>
                </div>
                <!-- í•˜ë‹¨ ì •ë³´ ì¹´ë“œ -->
                <div class="glass rounded-[32px] p-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div id="map-count" class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">0</div>
                        <div class="flex flex-col">
                            <span class="font-bold text-sm text-gray-800">ì ‘ì† ì¤‘ì¸ ì¹œêµ¬</span>
                            <span class="text-[10px] text-gray-500">ì§€ë„ë¥¼ ì›€ì§ì—¬ ì¹œêµ¬ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</span>
                        </div>
                    </div>
                    <!-- ìˆ˜ë™ ê°±ì‹  ë²„íŠ¼ -->
                    <button onclick="updateLocation()" class="bg-gray-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-md active:scale-95 transition-transform flex items-center gap-1">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        <span id="refresh-text">ê°±ì‹ </span>
                    </button>
                </div>
            </div>

            <!-- [FRIENDS] íƒ­ (ì¹´í†¡ ìŠ¤íƒ€ì¼ ë¦¬ìŠ¤íŠ¸) -->
            <div id="view-friends" class="hide space-y-4">
                <div class="flex justify-between items-end px-1">
                    <h2 class="text-lg font-bold text-gray-800">ì¹œêµ¬ ëª©ë¡ (<span id="list-count">0</span>)</h2>
                    <span class="text-xs text-gray-400 mb-1">í„°ì¹˜í•˜ë©´ ìœ„ì¹˜ í™•ì¸</span>
                </div>
                <div id="friends-grid" class="space-y-3 pb-20">
                    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- [PROFILE] íƒ­ (ì„¤ì • í†µí•©) -->
            <div id="view-profile" class="hide space-y-4">
                <h2 class="text-lg font-bold text-gray-800">í”„ë¡œí•„ & ìƒíƒœ ì„¤ì •</h2>
                <div class="glass rounded-[32px] p-6 space-y-5">
                    
                    <!-- ì´ë¦„ -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">ë‚´ ì´ë¦„</label>
                        <div id="profile-name" class="w-full mt-1 bg-gray-100 rounded-xl px-4 py-3 text-sm text-gray-800 font-bold"></div>
                    </div>

                    <!-- ìƒíƒœ ë©”ì‹œì§€ -->
                    <div>
                        <div class="flex justify-between items-center ml-1 mb-1">
                            <label class="text-xs font-bold text-gray-500">ìƒíƒœ ë©”ì‹œì§€</label>
                            <span class="text-[10px] text-blue-500 font-bold">ì§€ë„ì— í‘œì‹œë¨</span>
                        </div>
                        <input type="text" id="status-msg" placeholder="ì¹œêµ¬ë“¤ì—ê²Œ ë‚¨ê¸¸ ë§ (ì˜ˆ: ì´ë™ì¤‘ ğŸš—)" class="w-full bg-blue-50/50 border border-blue-100 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-200 outline-none placeholder-gray-400 text-gray-700">
                    </div>

                    <!-- ì´ëª¨ì§€ -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 ml-1">ì´ëª¨ì§€ ì„ íƒ</label>
                        <div class="flex gap-2 mt-2 overflow-x-auto pb-2 no-scrollbar" id="emoji-list"></div>
                    </div>

                    <!-- ì €ì¥ ë²„íŠ¼ -->
                    <button onclick="updateLocation()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-all mt-4 flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> ì €ì¥í•˜ê³  ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    </button>

                    <!-- ë¡œê·¸ì•„ì›ƒ -->
                    <div class="pt-4 border-t border-gray-100">
                        <button onclick="logout()" class="w-full bg-gray-200 text-gray-600 font-bold py-3 rounded-xl active:scale-95 transition-all text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div id="bottom-nav" class="hide fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[95%] max-w-lg z-[500]">
        <div class="glass rounded-[28px] p-1 flex justify-between items-center h-[72px] border border-white/50 px-1">
            <button onclick="switchTab('map')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-900"><i data-lucide="map-pin" class="w-5 h-5 mb-1"></i><span class="text-[9px] font-bold">ì§€ë„</span></button>
            <button onclick="switchTab('friends')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400"><i data-lucide="users" class="w-5 h-5 mb-1"></i><span class="text-[9px] font-bold">ì¹œêµ¬</span></button>
            <div class="-mt-8 mx-1 cursor-pointer active:scale-90 transition-transform" onclick="updateLocation()">
                <div class="w-14 h-14 bg-gray-900 rounded-full shadow-xl flex items-center justify-center text-white ring-4 ring-white/50">
                    <i data-lucide="navigation" id="nav-icon" class="w-6 h-6"></i>
                </div>
            </div>
            <button onclick="switchTab('profile')" class="nav-btn flex-1 flex flex-col items-center justify-center text-gray-400"><i data-lucide="user-cog" class="w-5 h-5 mb-1"></i><span class="text-[9px] font-bold">í”„ë¡œí•„</span></button>
            <button onclick="exitApp()" class="nav-btn flex-1 flex flex-col items-center justify-center text-red-400"><i data-lucide="log-out" class="w-5 h-5 mb-1"></i><span class="text-[9px] font-bold">ë‚˜ê°€ê¸°</span></button>
        </div>
    </div>

    <!-- === ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDse4kjmrO-N8jqHV5sKHQ3T_UrS0eFpYo",
            authDomain: "friend-map-app.firebaseapp.com",
            projectId: "friend-map-app",
            storageBucket: "friend-map-app.firebasestorage.app",
            messagingSenderId: "366133879234",
            appId: "1:366133879234:web:70d61c54e8767b1a6ef65b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let myName = "";
        let myEmoji = "ğŸ¦Š";
        let friendsData = [];
        let map = null;
        let markers = {};

        const ALL_MEMBERS = ['ì „ì‹œê¸°', 'ì˜¤ìŠ¤í‹´', 'ì´ì§„ëˆ„', 'ì„±ì›ì œ', 'ë¥˜ì§±', 'í™ë°•ì‚¬'];
        const ALLOWED_ENCODED = ["7KC07Iuc6riw", "7Jik7Iqk7Yu0", "7J207KeE64iE", "7ISx7JuQ7KCc", "66WY7Kex", "7ZmN67CV7IKs"];

        window.onload = () => {
            lucide.createIcons();
            checkLogin();
            setupEmojiList();
        };

        // --- ë¡œê·¸ì¸ ---
        window.checkLogin = () => {
            const savedName = localStorage.getItem('friendMapUserName');
            if (savedName) {
                myName = savedName;
                signIn();
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        };

        window.tryLogin = () => {
            const input = document.getElementById('login-input').value.trim();
            const errorMsg = document.getElementById('login-error');
            try {
                const encoded = btoa(unescape(encodeURIComponent(input)));
                if (ALLOWED_ENCODED.includes(encoded)) {
                    localStorage.setItem('friendMapUserName', input);
                    myName = input;
                    signIn();
                } else {
                    errorMsg.innerText = "ë“±ë¡ëœ ë©¤ë²„ê°€ ì•„ë‹™ë‹ˆë‹¤.";
                }
            } catch(e) {
                errorMsg.innerText = "ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
        };

        function signIn() {
            signInAnonymously(auth).then(() => {
                document.getElementById('login-modal').classList.add('hide');
                document.getElementById('app-content').classList.remove('hide');
                document.getElementById('bottom-nav').classList.remove('hide');
                document.getElementById('profile-name').innerText = myName;
                startListening();
                switchTab('map');
            }).catch((error) => {
                alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + error.message);
            });
        }

        window.logout = () => {
            localStorage.removeItem('friendMapUserName');
            location.reload();
        };

        window.exitApp = () => {
            window.location.href = 'index.html';
        };

        // --- ìë™ ìœ„ì¹˜ ê³µìœ  ë° ë¦¬ìŠ¤ë„ˆ ---
        function startListening() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    updateLocation(true); 
                    setInterval(() => { updateLocation(true); }, 180000); 

                    const colRef = collection(db, 'friend_locations');
                    onSnapshot(colRef, (snapshot) => {
                        friendsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderFriends();
                        updateMapMarkers();
                    });
                }
            });
        }

        // --- ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ---
        window.updateLocation = (silent = false) => {
            if (!currentUser) return;
            
            const statusMsg = document.getElementById('status-msg').value;
            const navIcon = document.getElementById('nav-icon');
            const refreshText = document.getElementById('refresh-text');

            if (!silent) {
                navIcon.classList.add('animate-spin');
                if(refreshText) refreshText.innerText = "ê°±ì‹  ì¤‘...";
            }

            if (!navigator.geolocation) {
                if (!silent) alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
                return;
            }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                try {
                    await setDoc(doc(db, 'friend_locations', currentUser.uid), {
                        uid: currentUser.uid,
                        displayName: myName,
                        emoji: myEmoji,
                        statusMessage: statusMsg || "ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨! ğŸ€",
                        latitude,
                        longitude,
                        timestamp: serverTimestamp()
                    }, { merge: true });
                    
                    if (!silent) {
                        navIcon.classList.remove('animate-spin');
                        if(refreshText) refreshText.innerText = "ì™„ë£Œ";
                        setTimeout(() => { if(refreshText) refreshText.innerText = "ê°±ì‹ "; }, 2000);
                        alert("ë‚´ ìœ„ì¹˜ì™€ ìƒíƒœê°€ ì¹œêµ¬ë“¤ì—ê²Œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (e) {
                    console.error(e);
                    if (!silent) alert("ì „ì†¡ ì‹¤íŒ¨");
                }
            }, (err) => {
                console.error(err);
                if (!silent) {
                    alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                    navIcon.classList.remove('animate-spin');
                }
            });
        };

        // --- ë·° ë Œë”ë§ (ì¹´í†¡ ìŠ¤íƒ€ì¼ ë¦¬ìŠ¤íŠ¸) ---
        function renderFriends() {
            const grid = document.getElementById('friends-grid');
            const mapCount = document.getElementById('map-count');
            
            const now = new Date();
            const onlineCount = friendsData.filter(f => {
                if(!f.timestamp) return false;
                const diff = now - f.timestamp.toDate();
                return diff < 10 * 60 * 1000; 
            }).length;

            mapCount.innerText = onlineCount;
            if(document.getElementById('list-count')) document.getElementById('list-count').innerText = friendsData.length;
            grid.innerHTML = "";

            ALL_MEMBERS.forEach(name => {
                const friend = friendsData.find(f => f.displayName === name) || {};
                const isMe = friend.uid === currentUser?.uid || name === myName;
                
                const hasData = friend.latitude !== undefined;
                const emoji = friend.emoji || (isMe && myEmoji ? myEmoji : 'ğŸ‘¤');
                const statusMsg = friend.statusMessage || (hasData ? "ìƒíƒœ ë©”ì‹œì§€ ì—†ìŒ" : "ìœ„ì¹˜ ì •ë³´ ì—†ìŒ");
                
                let isOnline = false;
                let timeStr = "-";
                
                if (hasData && friend.timestamp) {
                    const date = friend.timestamp.toDate();
                    const diff = now - date;
                    isOnline = diff < 10 * 60 * 1000;
                    timeStr = date.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'});
                }

                // ì¹´í†¡ ìŠ¤íƒ€ì¼ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ
                grid.innerHTML += `
                <div class="w-full bg-white border border-gray-100 rounded-[20px] p-4 flex items-center gap-4 shadow-sm active:scale-[0.98] transition-transform" ${hasData ? `onclick="showOnMap(${friend.latitude}, ${friend.longitude})"` : ''}>
                    <div class="relative w-12 h-12 flex-shrink-0 bg-gray-50 rounded-[18px] flex items-center justify-center text-2xl border border-gray-100">
                        ${emoji}
                        <div class="absolute -bottom-1 -right-1 flex items-center justify-center">
                            ${isOnline ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>'}
                        </div>
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <h4 class="font-bold text-gray-900 text-base truncate">${name}</h4>
                            ${isMe ? '<span class="bg-blue-100 text-blue-600 text-[10px] font-bold px-1.5 py-0.5 rounded-md">ë‚˜</span>' : ''}
                        </div>
                        <p class="text-xs ${isOnline ? 'text-gray-600' : 'text-gray-400'} mt-0.5 truncate">${statusMsg}</p>
                    </div>

                    <div class="flex flex-col items-end justify-center gap-1">
                        ${hasData ? `<span class="text-[10px] text-gray-400 font-medium">${timeStr}</span>` : ''}
                        ${hasData ? `<div class="bg-gray-100 p-1.5 rounded-full text-gray-500"><i data-lucide="map-pin" class="w-3 h-3"></i></div>` : ''}
                    </div>
                </div>`;
            });
            lucide.createIcons();
        }

        window.switchTab = (tabName) => {
            ['map', 'friends', 'profile'].forEach(t => {
                const el = document.getElementById('view-' + t);
                if(t === tabName) {
                    el.classList.remove('hide');
                    el.classList.add('animate-in', 'fade-in', 'slide-in-from-bottom-4');
                } else {
                    el.classList.add('hide');
                }
            });
            const title = document.getElementById('page-title');
            if(tabName === 'map') {
                title.innerHTML = "ìš°ë¦¬ ì¹œêµ¬ë“¤,<br>ì§€ê¸ˆ ì–´ë”” ìˆë‚˜ìš”? ğŸ—ºï¸";
                setTimeout(initMap, 100);
            }
            if(tabName === 'friends') title.innerHTML = "ì¹œêµ¬ ëª©ë¡<br>ì‹¤ì‹œê°„ í˜„í™© ğŸ‘€";
            if(tabName === 'profile') title.innerHTML = "ë‚´ ì„¤ì •<br>í”„ë¡œí•„ ê¾¸ë¯¸ê¸° âš™ï¸";
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.replace('text-gray-900', 'text-gray-400'));
        };

        function initMap() {
            if (map) {
                map.invalidateSize();
                return;
            }
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([36.5, 127.8], 7);
            
            // [ì§€ë„ ë³€ê²½] êµ¬ê¸€ ì§€ë„ ì •ë°€ ëª¨ë“œ (ê¹”ë”í•œ ë²¡í„° ìŠ¤íƒ€ì¼)
            L.tileLayer('https://mt1.google.com/vt/lyrs=m&hl=ko&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                attribution: 'Google Maps'
            }).addTo(map);
            
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (!map) return;
            for(let id in markers) { map.removeLayer(markers[id]); }
            markers = {};
            
            friendsData.forEach(f => {
                if(f.latitude && f.longitude) {
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="emoji-marker">${f.emoji || 'ğŸ™‚'}</div><div class="marker-name">${f.displayName}</div>`
                    });
                    const marker = L.marker([f.latitude, f.longitude], {icon: icon}).addTo(map);
                    markers[f.id] = marker;
                }
            });
        }

        window.showOnMap = (lat, lng) => {
            switchTab('map');
            setTimeout(() => { if(map) map.setView([lat, lng], 16); }, 300);
        };

        function setupEmojiList() {
            const emojis = ["ğŸ¦Š", "ğŸ°", "ğŸ¸", "ğŸ¯", "ğŸ¶", "ğŸ±", "ğŸ¼", "ğŸ¨", "ğŸ¦„", "ğŸµ"];
            const container = document.getElementById('emoji-list');
            container.innerHTML = emojis.map(e => `<button onclick="setEmoji('${e}')" class="text-2xl p-3 rounded-xl bg-gray-50 hover:bg-blue-100 transition-colors">${e}</button>`).join('');
        }
        window.setEmoji = (e) => {
            myEmoji = e;
            alert(`ì´ëª¨ì§€ê°€ ${e}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        };
    </script>
</body>
</html>