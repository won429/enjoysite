<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enjoy - Toss Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- í°íŠ¸ ë° ì•„ì´ì½˜ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @font-face {
            font-family: 'TossFaceFontMac';
            src: url('https://cdn.jsdelivr.net/gh/toss/tossface/dist/tossface-font-mac.css');
        }

        body { 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background-color: #F2F4F6;
            color: #191F28;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: pan-y;
        }

        /* ìœ ë¦¬ ì¬ì§ˆ ê³µí†µ í´ë˜ìŠ¤ */
        .toss-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04); 
            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.1s;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }
        .toss-card:active {
            transform: scale(0.96);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.02);
            filter: brightness(0.95);
        }

        /* ì¼ì •/ëª¨ì„ í™”ë©´ìš© ìœ ë¦¬ ì¹´ë“œ */
        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border-radius: 24px;
            transition: transform 0.1s;
        }
        .glass-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.5);
        }

        /* ë¯¸ë‚©ììš© íŒŒìŠ¤í…” ë ˆë“œ ë¸”ë¡ */
        .glass-card-unpaid {
            background: rgba(254, 226, 226, 0.6);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(254, 202, 202, 0.6);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.05);
            border-radius: 24px;
        }

        /* ë¶€ê³¼ê¸ˆ ëŒ€ìƒì ê°•ì¡° ì¹´ë“œ (ìœ ë¦¬ ì¬ì§ˆ í†µì¼ + ë¶‰ì€ í‹´íŠ¸) */
        .glass-card-penalty {
            background: rgba(255, 241, 242, 0.5); /* íˆ¬ëª…ë„ ì¡°ì ˆ */
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.08); /* ë¶‰ì€ ê·¸ë¦¼ì */
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }
        /* í¬ì¸íŠ¸ ë¼ì¸ */
        .glass-card-penalty::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: #F43F5E;
        }

        /* ë¶€ê³¼ê¸ˆ ë‚´ë¶€ ì•„ì´í…œ ìœ ë¦¬ íš¨ê³¼ */
        .glass-item-penalty {
            background: rgba(254, 242, 242, 0.6); /* ì•„ì£¼ ì—°í•œ ë¶‰ì€ìƒ‰ */
            border: 1px solid rgba(254, 202, 202, 0.5);
            border-radius: 16px;
        }
        
        /* ë©´ì œê¶Œ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .glass-card-ticket {
            background: rgba(240, 253, 244, 0.5);
            backdrop-filter: blur(12px) saturate(120%);
            -webkit-backdrop-filter: blur(12px) saturate(120%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.08);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }
        .glass-card-ticket::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: #22C55E;
        }

        .text-main { color: #191F28; }
        .text-sub { color: #6B7684; }
        .text-blue { color: #3182F6; }
        .text-red { color: #F04452; }
        .text-holiday { color: #F04452 !important; font-weight: bold; }

        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .pt-safe { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-area { padding-bottom: env(safe-area-inset-bottom); } 
        
        .price-up { color: #F04452 !important; transition: color 0.3s; }
        .price-down { color: #3182F6 !important; transition: color 0.3s; }

        @keyframes floatEmoji {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        .bg-emoji {
            animation: floatEmoji 6s ease-in-out infinite;
            filter: blur(0px); 
            position: absolute;
            right: 0;
            bottom: -10px;
            z-index: 0;
            pointer-events: none; 
        }

        /* í•˜ë‹¨ ë©”ë‰´ ì¸ë””ì¼€ì´í„° ì• ë‹ˆë©”ì´ì…˜ */
        #nav-indicator {
            will-change: transform, width;
        }
        .nav-transition {
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="w-full h-[100dvh] flex flex-col overflow-hidden bg-gradient-to-br from-[#F2F4F6] via-[#E8ECF2] to-[#DEE2E6]" ontouchstart="">

    <!-- ë©”ì¸ ì»¨í…ì¸  (í™ˆ í™”ë©´) -->
    <main id="home-screen" class="flex-1 overflow-y-auto scrollbar-hide px-5 pt-safe pb-24 w-full max-w-md mx-auto relative min-h-full">
        <div class="mb-6 mt-4 fade-in-up relative h-24 flex flex-col justify-center overflow-visible">
            <div id="bg-emoji" class="bg-emoji text-[80px] opacity-20 select-none transform translate-x-2"></div>
            <div class="relative z-10">
                <h1 class="text-2xl font-bold text-main leading-tight mb-1">ì—”ì¡°ì´ ì—¬ëŸ¬ë¶„,</h1>
                <p id="time-msg" class="text-2xl font-bold text-main leading-tight opacity-90"></p>
            </div>
        </div>

        <!-- ì„¹ì…˜ 1: ìì‚°/ì£¼ì‹ -->
        <div class="toss-card p-6 mb-4 fade-in-up delay-100 group" onclick="window.haptic(); window.checkStock()">
            <div class="flex justify-between items-center mb-6 pointer-events-none">
                <h2 class="text-xl font-bold text-main">ì—”ì¡°ì´ ì¦ê¶Œ</h2>
                <i class="fa-solid fa-chevron-right text-sub text-xs group-hover:translate-x-1 transition-transform"></i>
            </div>
            <div class="flex items-center justify-between relative z-10 pb-2 pointer-events-none">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-blue-50/80 flex items-center justify-center text-blue-500 text-xl shadow-sm">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2">
                            <p class="text-sm font-medium text-sub">ì—”ì¡°ì´</p> 
                            <span id="market-badge" class="hidden text-[10px] font-bold bg-gray-100/80 text-gray-500 px-1.5 py-0.5 rounded-md">ë§ˆê°</span>
                        </div>
                        <div class="flex items-end gap-2">
                            <h3 id="ticker-price" class="text-2xl font-bold text-main tabular-nums tracking-tight">Loading...</h3>
                            <span id="ticker-change" class="text-sm font-medium text-sub mb-1 tabular-nums">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-0 right-0 w-[60%] h-[50%] opacity-20 pointer-events-none">
                 <svg id="mini-chart" viewBox="0 0 100 50" width="100%" height="100%" preserveAspectRatio="none" class="overflow-visible">
                    <defs>
                        <linearGradient id="chart-grad" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stop-color="#3182F6" stop-opacity="0.5"/>
                            <stop offset="100%" stop-color="#3182F6" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path id="chart-fill" d="" fill="url(#chart-grad)"></path>
                    <polyline id="chart-line" points="" fill="none" stroke="#3182F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                 </svg>
            </div>
        </div>

        <!-- ì„¹ì…˜ 2: ì—”ì¡°ì´ ì„œë¹„ìŠ¤ -->
        <h3 class="text-lg font-bold text-main mb-3 px-1 fade-in-up delay-200">ì—”ì¡°ì´ ì„œë¹„ìŠ¤</h3>
        
        <!-- 1. ë©”ì¸ ì„œë¹„ìŠ¤ (ìŒì•…) -->
        <div class="mb-3 fade-in-up delay-200">
            <button onclick="window.haptic(); window.goToMusic()" class="toss-card w-full p-6 flex flex-row-reverse items-center justify-between group overflow-hidden relative h-32 !bg-[#E8F3FF]/60 backdrop-blur-md border border-white/60">
                <div class="relative z-10 w-16 h-16 rounded-full bg-white/70 backdrop-blur-sm shadow-sm flex items-center justify-center text-blue-500 text-3xl group-hover:scale-110 transition-transform duration-300">
                    <i class="fa-solid fa-headphones"></i>
                </div>
                <div class="relative z-10 text-left flex-1 pr-4">
                    <div class="flex items-center gap-1.5 mb-1.5">
                        <span class="text-[10px] font-bold text-blue-500 bg-white/70 px-1.5 py-0.5 rounded-md">MUSIC</span>
                        <span class="bg-blue-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-md tracking-tight">UPDATE</span>
                    </div>
                    <h4 class="text-xl font-bold text-main leading-tight mb-1">ì—”ì¡°ì´ ë¸Œì´ë¡œê·¸ ì†<br>ìŒì•… ìŠ¤íŠ¸ë¦¬ë°</h4>
                </div>
            </button>
        </div>

        <!-- 2. ì„œë¸Œ ì„œë¹„ìŠ¤ (ê²Œì„, ì—¬í–‰) -->
        <div class="grid grid-cols-2 gap-3 mb-3 fade-in-up delay-200">
            <!-- ê²Œì„ -->
            <button onclick="window.haptic(); window.playGame()" class="toss-card p-5 h-44 flex flex-col justify-between text-left group !bg-[#FFF0F0]/60 backdrop-blur-md border border-white/60 hover:!bg-[#FFE5E5]/70 transition-colors">
                <div class="w-full flex justify-between items-start">
                    <div class="w-12 h-12 rounded-[18px] bg-white/60 backdrop-blur-sm flex items-center justify-center text-[#FF6B6B] text-xl group-hover:rotate-12 transition-transform duration-300 shadow-sm">
                        <i class="fa-solid fa-dice"></i>
                    </div>
                    <span class="bg-[#FF6B6B] text-white text-[9px] font-bold px-1.5 py-0.5 rounded-md tracking-tight">UPDATE</span>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-main mb-1">ì—”ì¡°ì´ ë³µë¶ˆë³µ</h4>
                    <p class="text-xs text-[#FF6B6B]/90 font-medium leading-snug">ì—”ì¡°ì´ì˜<br>ìš´ëª…ì€?</p>
                </div>
            </button>

            <!-- ì—¬í–‰ -->
            <button onclick="window.haptic(); window.goToTravel()" class="toss-card p-5 h-44 flex flex-col justify-between text-left group !bg-[#E3FAEB]/60 backdrop-blur-md border border-white/60 hover:!bg-[#D1F7DE]/70 transition-colors">
                <div class="w-full flex justify-between items-start">
                    <div class="w-12 h-12 rounded-[18px] bg-white/60 backdrop-blur-sm flex items-center justify-center text-[#00C77D] text-xl group-hover:scale-110 transition-transform duration-300 shadow-sm">
                        <i class="fa-solid fa-plane-departure"></i>
                    </div>
                    <span class="bg-[#00C77D] text-white text-[9px] font-bold px-1.5 py-0.5 rounded-md tracking-tight">NEW</span>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-main mb-1">ì—¬í–‰ ê¸°ë¡</h4>
                    <p class="text-xs text-[#00C77D]/90 font-medium leading-snug">ì§€ë‚œ ì¶”ì–µì„<br>ë– ì˜¬ë ¤ë´ìš”</p>
                </div>
            </button>
        </div>

        <!-- 3. ê¸°íƒ€ (ì¤€ë¹„ ì¤‘) -->
        <div class="mb-6 fade-in-up delay-200">
            <button onclick="window.haptic(); window.showSecretModal()" class="toss-card w-full p-5 flex items-center justify-between group !bg-white/40 backdrop-blur-md border border-white/60 hover:!bg-white/60 transition-all">
                <div class="flex items-center gap-4">
                    <div class="w-11 h-11 rounded-[18px] bg-gray-100/80 backdrop-blur-sm flex items-center justify-center text-gray-400 text-lg shadow-sm group-hover:scale-110 group-hover:text-blue-400 group-hover:bg-blue-50 transition-all duration-300">
                        <i class="fa-solid fa-gift"></i>
                    </div>
                    <div class="text-left">
                        <p class="text-base font-bold text-main leading-tight">ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘</p>
                        <p class="text-xs text-sub mt-1">ì–´ë–¤ ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë ê¹Œìš”?</p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-gray-300 group-hover:text-gray-500 group-hover:bg-white/50 transition-all">
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </div>
            </button>
        </div>

        <div class="pb-8"></div>
    </main>

    <!-- ğŸ“… ì¼ì • í™”ë©´ -->
    <div id="schedule-screen" class="hidden fixed top-0 bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md z-30 flex-col overflow-hidden bg-gradient-to-br from-[#F2F4F6] via-[#E8ECF2] to-[#DEE2E6]">
        <header class="flex-none pt-safe px-6 pb-4 flex justify-between items-center bg-white/30 backdrop-blur-md border-b border-white/20 z-10 sticky top-0">
            <h2 class="text-2xl font-bold text-main drop-shadow-sm">ì¼ì •</h2>
            <div class="flex gap-2">
                <button onclick="window.haptic(); window.changeMonth(-1)" class="w-8 h-8 rounded-full bg-white/40 hover:bg-white/60 backdrop-blur-sm flex items-center justify-center text-gray-700 shadow-sm transition-colors active:scale-90"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="cal-title" class="text-lg font-bold text-main tabular-nums flex items-center drop-shadow-sm">2024.05</span>
                <button onclick="window.haptic(); window.changeMonth(1)" class="w-8 h-8 rounded-full bg-white/40 hover:bg-white/60 backdrop-blur-sm flex items-center justify-center text-gray-700 shadow-sm transition-colors active:scale-90"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto scrollbar-hide px-4 pt-4 w-full max-w-md mx-auto">
            <!-- ë‹¬ë ¥ ì»¨í…Œì´ë„ˆ -->
            <div class="bg-white/40 backdrop-blur-md border border-white/40 rounded-[32px] shadow-lg mb-6 pb-6 ring-1 ring-white/30">
                <div class="grid grid-cols-7 text-center mb-2 px-4 pt-4">
                    <div class="text-xs text-red-500 font-bold py-2">ì¼</div>
                    <div class="text-xs text-gray-600 font-medium py-2">ì›”</div>
                    <div class="text-xs text-gray-600 font-medium py-2">í™”</div>
                    <div class="text-xs text-gray-600 font-medium py-2">ìˆ˜</div>
                    <div class="text-xs text-gray-600 font-medium py-2">ëª©</div>
                    <div class="text-xs text-gray-600 font-medium py-2">ê¸ˆ</div>
                    <div class="text-xs text-gray-600 font-medium py-2">í† </div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 text-center px-4 gap-y-1"></div>
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ -->
            <div class="pb-24"> 
                <div class="flex justify-between items-end mb-3 px-1">
                    <h3 class="text-lg font-bold text-main drop-shadow-sm" id="selected-date-title">ì´ë‹¬ì˜ ì¼ì •</h3>
                    <button onclick="window.haptic(); window.openAddScheduleModal()" class="flex items-center gap-1 bg-white/60 hover:bg-white/80 text-blue-600 px-3 py-1.5 rounded-full text-xs font-bold transition-colors shadow-sm backdrop-blur-sm cursor-pointer z-20 active:scale-95">
                        <i class="fa-solid fa-plus"></i> ì¶”ê°€
                    </button>
                </div>
                <div id="event-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- ğŸ’° ëª¨ì„í†µì¥ í™”ë©´ -->
    <div id="meeting-screen" class="hidden fixed top-0 bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md z-30 flex-col overflow-hidden bg-gradient-to-br from-[#F2F4F6] via-[#E8ECF2] to-[#DEE2E6]">
        <header class="flex-none pt-safe px-6 pb-4 flex justify-between items-center bg-white/30 backdrop-blur-md border-b border-white/20 z-10 sticky top-0">
            <h2 class="text-2xl font-bold text-main drop-shadow-sm">ëª¨ì„í†µì¥</h2>
            <button onclick="window.haptic(); window.openPasswordModal()" class="text-sm font-medium text-gray-500 hover:text-gray-800 transition-colors cursor-pointer z-20 p-2">ê´€ë¦¬</button>
        </header>

        <div class="flex-1 overflow-y-auto scrollbar-hide px-5 pt-4">
            
            <!-- ê³„ì¢Œ ì¹´ë“œ -->
            <div class="glass-card p-5 mb-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-blue-400/20 rounded-full blur-2xl pointer-events-none"></div>
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-full bg-white/60 flex items-center justify-center text-lg">ğŸ’°</div>
                        <span class="text-sm font-bold text-gray-600">ì—”ì¡°ì´ íšŒë¹„</span>
                    </div>
                </div>
                <div class="mt-6 mb-2">
                    <h3 id="total-balance" class="text-3xl font-bold text-main tabular-nums tracking-tight">448,999ì›</h3>
                </div>
            </div>
            
            <!-- í˜„í™© ê·¸ë¦¬ë“œ (ë¶€ê³¼ê¸ˆ / ë©´ì œê¶Œ) -->
            <div class="grid grid-cols-2 gap-3 mb-4">
                <!-- ë¶€ê³¼ê¸ˆ ëŒ€ìƒì ë°•ìŠ¤ (ì •ì‚¬ê°í˜• í˜•íƒœ) -->
                <div class="glass-card-penalty p-4 flex flex-col h-40">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xs font-bold text-red-500 flex items-center gap-1.5">
                            <i class="fa-solid fa-bell animate-pulse"></i> ë¶€ê³¼ê¸ˆ ëŒ€ìƒì í˜„í™©
                        </h3>
                        <span class="text-[9px] bg-red-100 text-red-500 px-1.5 py-0.5 rounded-full font-medium">NEW</span>
                    </div>
                    <div id="penalty-list-mini" class="flex-1 overflow-y-auto scrollbar-hide space-y-1.5">
                        <!-- JSë¡œ ë Œë”ë§ -->
                        <div class="h-full flex items-center justify-center text-xs text-red-300">ì—†ìŒ</div>
                    </div>
                </div>

                <!-- ë¶€ê³¼ê¸ˆ ë©´ì œê¶Œ ë°•ìŠ¤ -->
                <div class="glass-card-ticket p-4 flex flex-col h-40 relative">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xs font-bold text-emerald-600 flex items-center gap-1.5">
                            <i class="fa-solid fa-ticket"></i> ë©´ì œê¶Œ ëŒ€ìƒì í˜„í™©
                        </h3>
                    </div>
                    <div id="ticket-list-mini" class="flex-1 overflow-y-auto scrollbar-hide space-y-1.5">
                         <!-- JSë¡œ ë Œë”ë§ -->
                    </div>
                </div>
            </div>

            <!-- íšŒë¹„ ë‚©ë¶€ í˜„í™© -->
            <div class="pb-24">
                <div class="flex justify-between items-center mb-3 px-1">
                    <h3 class="text-lg font-bold text-main drop-shadow-sm">íšŒë¹„ ë‚©ë¶€ í˜„í™©</h3>
                    <div class="flex items-center gap-2 bg-white/40 rounded-full px-2 py-1 backdrop-blur-sm shadow-sm border border-white/30">
                        <button onclick="window.haptic(); window.changeDuesMonth(-1)" class="w-6 h-6 rounded-full hover:bg-white/50 flex items-center justify-center text-gray-600 transition-colors active:scale-90"><i class="fa-solid fa-chevron-left text-xs"></i></button>
                        <span id="dues-month-title" class="text-xs font-bold text-main tabular-nums">12ì›” ê¸°ì¤€</span>
                        <button onclick="window.haptic(); window.changeDuesMonth(1)" class="w-6 h-6 rounded-full hover:bg-white/50 flex items-center justify-center text-gray-600 transition-colors active:scale-90"><i class="fa-solid fa-chevron-right text-xs"></i></button>
                    </div>
                </div>
                <div id="dues-list" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <!-- ğŸŒ ë‚´ë¶€ ë¸Œë¼ìš°ì € (ì•± ë‚´ ì›¹ë·° ëŠë‚Œ - ì „ì²´í™”ë©´, ë‹«ê¸° ë²„íŠ¼ ì œê±°ë¨) -->
    <div id="browser-screen" class="hidden fixed inset-0 z-[100] flex-col bg-white">
        <!-- iframe Container (Full Screen) -->
        <div class="flex-1 relative w-full h-full bg-white">
            <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
            <div id="browser-loader" class="absolute inset-0 flex items-center justify-center text-blue-500 z-0 bg-white">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
            </div>
            
            <!-- iframe -->
            <iframe id="internal-browser-frame" class="w-full h-full border-0 relative z-10 bg-transparent" allow="autoplay; encrypted-media" onload="document.getElementById('browser-loader').style.display='none'"></iframe>
        </div>
    </div>

    <!-- í•˜ë‹¨ í”Œë¡œíŒ… ë©”ë‰´ -->
    <nav id="bottom-nav" class="fixed bottom-3 left-1/2 -translate-x-1/2 z-50 w-auto touch-pan-x select-none cursor-grab active:cursor-grabbing">
        <div class="flex items-center bg-white/10 backdrop-blur-[4px] backdrop-saturate-[180%] shadow-[0_8px_32px_0_rgba(31,38,135,0.15)] border border-white/20 rounded-full p-1.5 gap-1 ring-1 ring-white/30 relative">
            <div id="nav-indicator" class="absolute top-1 bottom-1 bg-white/50 shadow-[inset_0_1px_1px_rgba(255,255,255,0.8)] rounded-full backdrop-blur-[2px] border border-white/20 z-0 nav-transition" style="left: 6px; width: 64px;"></div>
            <button id="nav-home" class="relative px-5 py-2 rounded-full group min-w-[64px] z-10 active:scale-95 transition-transform" onclick="window.haptic(); window.goHome()">
                <div class="flex flex-col items-center gap-0.5 pointer-events-none">
                    <i class="fa-solid fa-house text-base text-[#191F28] drop-shadow-sm"></i>
                    <span class="text-[10px] font-bold text-[#191F28] drop-shadow-sm whitespace-nowrap">í™ˆ</span>
                </div>
            </button>
            <button id="nav-calendar" class="relative px-5 py-2 rounded-full group min-w-[64px] z-10 active:scale-95 transition-transform" onclick="window.haptic(); window.goSchedule()">
                <div class="flex flex-col items-center gap-0.5 pointer-events-none">
                    <i class="fa-regular fa-calendar-days text-base text-[#4E5968] group-hover:text-gray-900 transition-colors drop-shadow-sm"></i>
                    <span class="text-[10px] font-medium text-[#4E5968] group-hover:text-gray-900 transition-colors drop-shadow-sm whitespace-nowrap">ì¼ì •</span>
                </div>
            </button>
            <button id="nav-meeting" class="relative px-5 py-2 rounded-full group min-w-[64px] z-10 active:scale-95 transition-transform" onclick="window.haptic(); window.goMeeting()">
                <div class="flex flex-col items-center gap-0.5 pointer-events-none">
                    <i class="fa-solid fa-users text-base text-[#4E5968] group-hover:text-gray-900 transition-colors drop-shadow-sm"></i>
                    <span class="text-[10px] font-medium text-[#4E5968] group-hover:text-gray-900 transition-colors drop-shadow-sm whitespace-nowrap">ëª¨ì„í†µì¥</span>
                </div>
            </button>
        </div>
    </nav>

    <!-- Modals -->
    <div id="password-modal" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl scale-in text-center relative">
            <h3 class="text-lg font-bold text-main mb-4">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
            <input type="password" id="admin-password-input" class="w-full bg-gray-100 border-none rounded-xl px-4 py-3 text-center text-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" maxlength="4">
            <div class="flex gap-2">
                <button onclick="window.haptic(); window.closeModal('password-modal')" class="flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl active:bg-gray-200">ì·¨ì†Œ</button>
                <button onclick="window.haptic(); window.checkPassword()" class="flex-1 bg-blue-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-blue-600 active:bg-blue-700">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl scale-in relative overflow-hidden max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-main">íšŒë¹„ ê´€ë¦¬ (<span id="admin-month-title"></span>)</h3>
                <button onclick="window.haptic(); window.closeModal('admin-modal')" class="text-gray-400 hover:text-gray-600 active:scale-90"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="overflow-y-auto flex-1 pr-1">
                <div class="mb-6">
                    <label class="block text-xs text-gray-500 font-bold mb-1">ì´ íšŒë¹„ ì”ì•¡</label>
                    <input type="number" id="admin-total-balance" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 font-bold text-lg text-main focus:outline-none focus:border-blue-500 transition-colors" placeholder="ê¸ˆì•¡ ì…ë ¥">
                </div>
                <div class="mb-6">
                    <label class="block text-xs text-gray-500 font-bold mb-2">ë©¤ë²„ë³„ ë‚©ë¶€ ìƒíƒœ</label>
                    <div id="admin-member-list" class="space-y-2"></div>
                </div>
                <div>
                    <label class="block text-xs text-emerald-600 font-bold mb-2">ë©´ì œê¶Œ ê´€ë¦¬</label>
                    <div id="admin-ticket-list" class="space-y-2"></div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
                <button onclick="window.haptic(); window.saveAdminData()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl transition-colors shadow-md active:bg-blue-700">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="schedule-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl scale-in relative overflow-hidden flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-main" id="sch-modal-title">ì¼ì • ì¶”ê°€</h3>
                <button onclick="window.haptic(); window.closeModal('schedule-modal')" class="text-gray-400 hover:text-gray-600 active:scale-90"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="sch-edit-date-key">
                <input type="hidden" id="sch-edit-index">
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1.5">ì¹´í…Œê³ ë¦¬</label>
                    <select id="add-sch-category" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-main focus:outline-none focus:border-blue-500 transition-colors">
                        <option value="meet">ì •ê¸° ëª¨ì„</option>
                        <option value="personal">ê°œì¸ ì¼ì •</option>
                        <option value="school">í•™êµ/ì¢…ê°•</option>
                        <option value="bday">ìƒì¼</option>
                        <option value="etc">ê¸°íƒ€</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1.5">ë‚ ì§œ</label>
                    <input type="date" id="add-sch-date" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-main focus:outline-none focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1.5">ì‹œê°„</label>
                    <input type="text" id="add-sch-time" placeholder="ì˜ˆ: 19:00, í•˜ë£¨ ì¢…ì¼" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-main focus:outline-none focus:border-blue-500 transition-colors">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 font-bold mb-1.5">ì¼ì • ì´ë¦„</label>
                    <input type="text" id="add-sch-title" placeholder="ì¼ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-main focus:outline-none focus:border-blue-500 transition-colors">
                </div>
            </div>
            <div class="mt-6 pt-2 flex gap-2">
                <button id="sch-delete-btn" onclick="window.haptic(); window.deleteSchedule()" class="hidden flex-1 bg-red-100 hover:bg-red-200 text-red-600 font-bold py-3.5 rounded-xl transition-colors shadow-sm active:bg-red-300">ì‚­ì œ</button>
                <button id="sch-save-btn" onclick="window.haptic(); window.saveScheduleToFirebase()" class="flex-[2] bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-xl transition-colors shadow-md active:bg-blue-700">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="common-modal" class="fixed inset-0 z-[70] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl scale-in text-center">
            <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-xl" id="modal-icon-bg">
                <i id="modal-icon" class=""></i>
            </div>
            <h3 class="text-lg font-bold text-main mb-2" id="modal-title">ì œëª©</h3>
            <p class="text-[#4E5968] text-sm mb-6 leading-relaxed break-keep" id="modal-desc">ë‚´ìš©</p>
            <button onclick="window.haptic(); window.closeModal('common-modal')" class="w-full bg-[#3182F6] text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 transition-colors shadow-md shadow-blue-500/20 active:scale-95">í™•ì¸</button>
        </div>
    </div>

    <div id="startup-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl scale-in text-left relative overflow-hidden">
            <h3 class="text-xl font-bold text-main mb-4 mt-1 text-center">ì—…ë°ì´íŠ¸ ì†Œì‹ ğŸ””</h3>
            
            <div class="space-y-3 mb-6">
                <div class="bg-blue-50 p-3.5 rounded-2xl border border-blue-100">
                    <p class="text-sm font-bold text-blue-600 mb-1 flex items-center gap-1.5">
                        <i class="fa-solid fa-shapes"></i> ì¸í„°í˜ì´ìŠ¤ & ì„œë¹„ìŠ¤
                    </p>
                    <p class="text-xs text-gray-600 leading-relaxed pl-0.5">
                        <span class="font-bold text-gray-800">ìƒˆë¡œìš´ ì¸í„°í˜ì´ìŠ¤ UI ì ìš©!</span><br>
                        ì—¬í–‰ê¸°ë¡, ì¼ì •, ëª¨ì„í†µì¥ ì„œë¹„ìŠ¤ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”.
                    </p>
                </div>
                
                <div class="bg-red-50 p-3.5 rounded-2xl border border-red-100">
                    <p class="text-sm font-bold text-red-500 mb-1 flex items-center gap-1.5">
                        <i class="fa-solid fa-dice"></i> ì—”ì¡°ì´ ë³µë¶ˆë³µ
                    </p>
                    <ul class="text-xs text-gray-600 leading-relaxed pl-4 list-disc marker:text-red-300">
                        <li>ë©¤ë²„ 1ëª… ì¶”ê°€ ë“±ë¡ ì™„ë£Œ</li>
                        <li>ì°¨ëŸ‰ ëŒ€ìˆ˜ ì„ íƒ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸</li>
                    </ul>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="window.haptic(); window.closeModal('startup-modal')" class="flex-1 bg-[#F2F4F6] text-[#4E5968] font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors active:scale-95">ë‹«ê¸°</button>
                <button onclick="window.haptic(); window.closeModal('startup-modal')" class="flex-1 bg-[#3182F6] text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 transition-colors shadow-md shadow-blue-500/20 active:scale-95">í™•ì¸í–ˆì–´ìš”</button>
            </div>
        </div>
    </div>

    <!-- ì¼ë°˜ ìŠ¤í¬ë¦½íŠ¸ (UI Logic) - ë¨¼ì € ë¡œë“œ -->
    <script>
        // Global Variables
        window.meetingData = null;
        window.currentDuesMonth = 12;
        window.dynamicEvents = {};
        window.viewYear = new Date().getFullYear();
        window.viewMonth = new Date().getMonth();
        window.activeTabIndex = 0;

        // Helper Functions
        window.haptic = function() { if (navigator.vibrate) navigator.vibrate(10); }
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
        window.showModal = (id) => { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex'); };
        
        // ë‚´ë¶€ ë¸Œë¼ìš°ì € ì œì–´ í•¨ìˆ˜
        window.openBrowser = function(url) {
            const screen = document.getElementById('browser-screen');
            const frame = document.getElementById('internal-browser-frame');
            const loader = document.getElementById('browser-loader');
            
            // ë¸Œë¼ìš°ì € íˆìŠ¤í† ë¦¬ ìƒíƒœ ì¶”ê°€ (ë’¤ë¡œê°€ê¸° ë²„íŠ¼ìœ¼ë¡œ ë‹«ì„ ìˆ˜ ìˆê²Œ í•¨)
            window.history.pushState({modal: 'browser'}, '', '');

            // UI ì„¸íŒ…
            loader.style.display = 'flex'; // ë¡œë”© í‘œì‹œ
            frame.src = url;
            
            // í™”ë©´ í‘œì‹œ
            screen.classList.remove('hidden');
            screen.classList.add('flex');
            
            // í•˜ë‹¨ íƒ­ ìˆ¨ê¸°ê¸°
            document.getElementById('bottom-nav').classList.add('hidden');
        };

        window.closeBrowser = function() {
            const screen = document.getElementById('browser-screen');
            const frame = document.getElementById('internal-browser-frame');
            
            // í™”ë©´ ìˆ¨ê¸°ê¸°
            screen.classList.add('hidden');
            screen.classList.remove('flex');
            
            // iframe ì´ˆê¸°í™”
            frame.src = '';
            
            // í•˜ë‹¨ íƒ­ ë‹¤ì‹œ ë³´ì´ê¸°
            document.getElementById('bottom-nav').classList.remove('hidden');
        };

        // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸° ì´ë²¤íŠ¸ ê°ì§€ (ì•± ë‚´ ëª¨ë‹¬ ë‹«ê¸°)
        window.onpopstate = function(event) {
            const screen = document.getElementById('browser-screen');
            if (screen && !screen.classList.contains('hidden')) {
                window.closeBrowser();
            }
        };

        window.setGreeting = function() {
            const hour = new Date().getHours();
            const msgEl = document.getElementById('time-msg');
            const emojiEl = document.getElementById('bg-emoji');
            let msg = '', emoji = '';
            if (hour >= 0 && hour < 5) { msg = 'ê³ ìš”í•œ ìƒˆë²½ì´ë„¤ìš” ğŸŒ™'; emoji = 'ğŸŒŒ'; }
            else if (hour >= 5 && hour < 9) { msg = 'ìƒì¾Œí•œ ì•„ì¹¨ì´ì—ìš” â˜€ï¸'; emoji = 'ğŸŒ…'; }
            else if (hour >= 9 && hour < 12) { msg = 'í™œê¸°ì°¬ ì˜¤ì „ ë³´ë‚´ì„¸ìš” â˜˜ï¸'; emoji = 'ğŸŒ¤ï¸'; }
            else if (hour >= 12 && hour < 14) { msg = 'ë§›ìˆëŠ” ì ì‹¬ ë“œì„¸ìš” ğŸ±'; emoji = 'ğŸ½ï¸'; }
            else if (hour >= 14 && hour < 18) { msg = 'ë‚˜ë¥¸í•œ ì˜¤í›„, í˜ë‚´ì„¸ìš” â˜•ï¸'; emoji = 'ğŸ¥'; }
            else if (hour >= 18 && hour < 22) { msg = 'í¸ì•ˆí•œ ì €ë… ë˜ì„¸ìš” ğŸŒ†'; emoji = 'ğŸ·'; }
            else { msg = 'ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í–ˆì–´ìš” ğŸŒ™'; emoji = 'âœ¨'; }
            if(msgEl) msgEl.innerHTML = msg;
            if(emojiEl) emojiEl.innerHTML = emoji;
        }

        window.showTravelModal = () => { const m = document.getElementById('common-modal'); document.getElementById('modal-title').innerText = 'Coming Soon'; document.getElementById('modal-desc').innerHTML = 'ì—¬í–‰ ê¸°ë¡ ì„œë¹„ìŠ¤ëŠ”<br>ê³§ ì„œë¹„ìŠ¤ê°€ ë  ì˜ˆì •ì´ì—ìš” âœˆï¸'; document.getElementById('modal-icon').className = 'fa-solid fa-plane'; document.getElementById('modal-icon-bg').className = 'w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-xl bg-emerald-50 text-emerald-500'; m.classList.remove('hidden'); m.classList.add('flex'); };
        window.showSecretModal = () => { const m = document.getElementById('common-modal'); document.getElementById('modal-title').innerText = 'ë‹¤ìŒ ì„œë¹„ìŠ¤ëŠ”?'; document.getElementById('modal-desc').innerHTML = 'ì–´ë–¤ ì„œë¹„ìŠ¤ê°€<br>ìƒˆë¡œ ë‚˜ì˜¬ê¹Œìš”? ğŸ'; document.getElementById('modal-icon').className = 'fa-solid fa-gift'; document.getElementById('modal-icon-bg').className = 'w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4 text-xl bg-gray-100 text-gray-400'; m.classList.remove('hidden'); m.classList.add('flex'); };
        window.openPasswordModal = function() { document.getElementById('admin-password-input').value = ''; document.getElementById('password-modal').classList.remove('hidden'); document.getElementById('password-modal').classList.add('flex'); };
        window.checkPassword = function() { const pw = document.getElementById('admin-password-input').value; if (pw === '0920') { window.closeModal('password-modal'); window.openAdminModalReal(); } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); } };
        
        window.openAdminModalReal = function() { 
            if (!window.meetingData) window.meetingData = getInitialMeetingData(); 
            const modal = document.getElementById('admin-modal'); modal.classList.remove('hidden'); modal.classList.add('flex'); 
            document.getElementById('admin-month-title').innerText = `${window.currentDuesMonth}ì›”`; 
            document.getElementById('admin-total-balance').value = window.meetingData.totalBalance || 0; 
            
            // ë©¤ë²„ ë‚©ë¶€ ìƒíƒœ ë Œë”ë§
            const list = document.getElementById('admin-member-list'); list.innerHTML = ''; 
            if (!window.meetingData.records[window.currentDuesMonth]) window.meetingData.records[window.currentDuesMonth] = createEmptyMonthData(); 
            const records = window.meetingData.records[window.currentDuesMonth]; 
            records.forEach((m, i) => { const isPaid = m.status === 'paid'; list.innerHTML += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl"><span class="font-bold text-sm text-main">${m.name}</span><div class="flex items-center gap-2"><input type="number" id="edit-amt-${i}" class="w-20 text-right text-xs p-1 border rounded" value="${m.amount}"><button onclick="window.togglePay(${i})" class="text-xs font-bold px-3 py-1.5 rounded-lg transition-colors ${isPaid ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}">${isPaid ? 'ë‚©ë¶€' : 'ë¯¸ë‚©'}</button></div></div>`; }); 
            
            // ë©´ì œê¶Œ ê´€ë¦¬ ë Œë”ë§ (ê¸°ë³¸ê°’ ì²˜ë¦¬ ì¶”ê°€)
            const ticketList = document.getElementById('admin-ticket-list'); ticketList.innerHTML = '';
            const members = ['í™ë°•ì‚¬', 'ë¥˜ì§±', 'ì˜¤ìŠ¤í‹´', 'ì „ì‹œê¸°', 'ì´ì§„ëˆ„', 'ì„±ì›ì œ'];
            const exemptions = window.meetingData.exemptions || { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 };
            members.forEach((name, i) => {
                const count = exemptions[name] || 0;
                ticketList.innerHTML += `<div class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl"><span class="font-bold text-sm text-main">${name}</span><div class="flex items-center gap-2"><button onclick="window.updateExemption('${name}', -1)" class="w-7 h-7 rounded-full bg-white text-emerald-600 flex items-center justify-center font-bold shadow-sm active:scale-90">-</button><span id="admin-ticket-${name}" class="font-bold text-sm w-4 text-center">${count}</span><button onclick="window.updateExemption('${name}', 1)" class="w-7 h-7 rounded-full bg-white text-emerald-600 flex items-center justify-center font-bold shadow-sm active:scale-90">+</button></div></div>`;
            });
        };
        
        window.updateExemption = function(name, delta) {
            const el = document.getElementById(`admin-ticket-${name}`);
            let val = parseInt(el.innerText);
            val += delta;
            if(val < 0) val = 0;
            el.innerText = val;
            
            if(!window.meetingData.exemptions) window.meetingData.exemptions = { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 };
            window.meetingData.exemptions[name] = val;
        }

        window.togglePay = function(idx) { const records = window.meetingData.records[window.currentDuesMonth]; if(records && records[idx]) { const m = records[idx]; if(m.status === 'paid') { m.status = 'unpaid'; m.amount = 0; } else { m.status = 'paid'; m.amount = 15000; } const row = document.getElementById('admin-member-list').children[idx]; row.querySelector('input').value = m.amount; const btn = row.querySelector('button'); btn.className = `text-xs font-bold px-3 py-1.5 rounded-lg transition-colors ${m.status === 'paid' ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}`; btn.innerText = m.status === 'paid' ? 'ë‚©ë¶€' : 'ë¯¸ë‚©'; } };
        window.saveAdminData = async function() { 
            if (!window.meetingData || !window.meetingDb) { alert("DB ì—°ê²° ì•ˆë¨"); return; } 
            const bal = parseInt(document.getElementById('admin-total-balance').value) || 0; 
            window.meetingData.totalBalance = bal; 
            const records = window.meetingData.records[window.currentDuesMonth]; 
            if(records) { records.forEach((m, i) => { const val = document.getElementById(`edit-amt-${i}`).value; m.amount = parseInt(val) || 0; }); } 
            
            // ë©´ì œê¶Œ ë°ì´í„°ëŠ” updateExemptionì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì²´ì— ë°˜ì˜ë¨
            if(!window.meetingData.exemptions) window.meetingData.exemptions = { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 };

            try { await window.setDoc(window.doc(window.meetingDb, ...window.MEETING_PATH), window.meetingData); alert('ì €ì¥ ì™„ë£Œ! âœ…'); window.closeModal('admin-modal'); } catch (e) { console.error(e); alert('ì €ì¥ ì‹¤íŒ¨'); } 
        };
        window.saveScheduleToFirebase = async function() { if (!window.meetingDb) { alert('DB ì—°ê²° í™•ì¸ ì¤‘...'); return; } const category = document.getElementById('add-sch-category').value; const date = document.getElementById('add-sch-date').value; const time = document.getElementById('add-sch-time').value || 'í•˜ë£¨ ì¢…ì¼'; const title = document.getElementById('add-sch-title').value; const editKey = document.getElementById('sch-edit-date-key').value; const editIdx = document.getElementById('sch-edit-index').value; const isEdit = (editKey && editIdx !== ''); if (!date || !title) { alert('ë‚ ì§œì™€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; } const newEvent = { type: category, title: title, time: time }; try { if(isEdit) { const docSnap = await window.getDoc(window.doc(window.meetingDb, ...window.SCHEDULE_PATH)); if(docSnap.exists()) { const data = docSnap.data(); if(editKey !== date) { const oldList = data[editKey]; if(oldList) { oldList.splice(editIdx, 1); if(oldList.length === 0) delete data[editKey]; else data[editKey] = oldList; } const newList = data[date] || []; newList.push(newEvent); data[date] = newList; } else { const list = data[date]; if(list) { list[editIdx] = newEvent; } } await window.setDoc(window.doc(window.meetingDb, ...window.SCHEDULE_PATH), data); } } else { await window.setDoc(window.doc(window.meetingDb, ...window.SCHEDULE_PATH), { [date]: window.arrayUnion(newEvent) }, { merge: true }); } alert(isEdit ? 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!'); window.closeModal('schedule-modal'); } catch (e) { console.error(e); alert('ì²˜ë¦¬ ì‹¤íŒ¨'); } };
        window.deleteSchedule = async function() { if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; const dateKey = document.getElementById('sch-edit-date-key').value; const index = document.getElementById('sch-edit-index').value; try { const docSnap = await window.getDoc(window.doc(window.meetingDb, ...window.SCHEDULE_PATH)); if(docSnap.exists()) { const data = docSnap.data(); const list = data[dateKey]; if(list) { list.splice(index, 1); if(list.length === 0) delete data[dateKey]; else data[dateKey] = list; await window.setDoc(window.doc(window.meetingDb, ...window.SCHEDULE_PATH), data); alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); window.closeModal('schedule-modal'); } } } catch(e) { console.error(e); alert('ì‚­ì œ ì‹¤íŒ¨'); } }
        window.changeDuesMonth = function(delta) { window.currentDuesMonth += delta; if (window.currentDuesMonth < 1) window.currentDuesMonth = 1; if (window.currentDuesMonth > 12) window.currentDuesMonth = 12; window.renderDues(window.currentDuesMonth); }
        
        // [Modified] updateMeetingUI: DB ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ì§€ë…¸ -> ì´ì§„ëˆ„ ìë™ ë³€í™˜)
        window.updateMeetingUI = function(data) { 
            // 1. ê¸°ì¡´ ë°ì´í„° ë‚´ 'ì§€ë…¸'ë¥¼ 'ì´ì§„ëˆ„'ë¡œ ì‹¤ì‹œê°„ ë³€í™˜
            if (data.records) {
                Object.keys(data.records).forEach(month => {
                    data.records[month].forEach(member => {
                        if (member.name === 'ì§€ë…¸') member.name = 'ì´ì§„ëˆ„';
                    });
                });
            }
            if (data.exemptions && data.exemptions['ì§€ë…¸'] !== undefined) {
                data.exemptions['ì´ì§„ëˆ„'] = (data.exemptions['ì´ì§„ëˆ„'] || 0) + data.exemptions['ì§€ë…¸'];
                delete data.exemptions['ì§€ë…¸'];
            }

            window.meetingData = data; 
            
            // ë°ì´í„° ì—†ì„ ì‹œ ê¸°ë³¸ê°’ ì£¼ì…
            if (!window.meetingData.exemptions) {
                window.meetingData.exemptions = { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 };
            }
            const balanceEl = document.getElementById('total-balance'); 
            if (balanceEl) balanceEl.innerText = (data.totalBalance || 0).toLocaleString() + "ì›"; 
            window.renderDues(window.currentDuesMonth); 
        };
        
        window.openAddScheduleModal = () => { document.getElementById('sch-modal-title').innerText = 'ì¼ì • ì¶”ê°€'; document.getElementById('sch-delete-btn').classList.add('hidden'); document.getElementById('sch-save-btn').innerText = 'ë“±ë¡í•˜ê¸°'; document.getElementById('sch-edit-date-key').value = ''; document.getElementById('sch-edit-index').value = ''; document.getElementById('add-sch-title').value = ''; document.getElementById('add-sch-time').value = ''; document.getElementById('add-sch-date').value = ''; document.getElementById('schedule-modal').classList.remove('hidden'); document.getElementById('schedule-modal').classList.add('flex'); };
        window.openEditScheduleModal = (dateStr, index) => { if (!dateStr) { window.openAddScheduleModal(); return; } document.getElementById('sch-modal-title').innerText = 'ì¼ì • ìˆ˜ì •'; document.getElementById('sch-delete-btn').classList.remove('hidden'); document.getElementById('sch-save-btn').innerText = 'ìˆ˜ì •í•˜ê¸°'; document.getElementById('sch-edit-date-key').value = dateStr; document.getElementById('sch-edit-index').value = index; const list = window.dynamicEvents[dateStr]; if(list && list[index]) { const event = list[index]; document.getElementById('add-sch-category').value = event.type; document.getElementById('add-sch-date').value = dateStr; document.getElementById('add-sch-time').value = event.time; document.getElementById('add-sch-title').value = event.title; } document.getElementById('schedule-modal').classList.remove('hidden'); document.getElementById('schedule-modal').classList.add('flex'); };
        window.checkStock = () => { window.location.href = "stock.html"; };
        
        // ë§í¬ ì—°ê²° ë°©ì‹ ë³€ê²½ (iframe ì‚¬ìš©)
        window.goToMusic = () => window.openBrowser("https://won429.github.io/enjoy/");
        window.playGame = () => window.location.href = "game.html";
        window.goToTravel = () => window.openBrowser("https://won429.github.io/enjoy_trip/");
        
        window.goHome = () => { window.activeTabIndex = 0; window.updateTabUI(0); }
        window.goSchedule = () => { window.activeTabIndex = 1; window.updateTabUI(1); }
        window.goMeeting = () => { window.activeTabIndex = 2; window.updateTabUI(2); }
        window.changeMonth = (delta) => { window.viewMonth += delta; if (window.viewMonth < 0) { window.viewYear--; window.viewMonth = 11; } else if (window.viewMonth > 11) { window.viewYear++; window.viewMonth = 0; } window.renderCalendar(window.viewYear, window.viewMonth); }

        // Data Helpers
        function createEmptyMonthData() { const members = ['í™ë°•ì‚¬', 'ë¥˜ì§±', 'ì˜¤ìŠ¤í‹´', 'ì „ì‹œê¸°', 'ì´ì§„ëˆ„', 'ì„±ì›ì œ']; return members.map(name => ({ name: name, status: 'unpaid', amount: 0, isLeader: name === 'ì „ì‹œê¸°' })); }
        function getInitialMeetingData() { 
            return { 
                totalBalance: 448999, 
                exemptions: { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 },
                records: { 
                    10: [ { name: 'ì˜¤ìŠ¤í‹´', status: 'unpaid', amount: 0, penalty: 'ë¯¸ë‚©ë¶€ë¡œ ì¸í•œ ë¶€ê³¼ê¸ˆ 10,000ì› ë°œìƒ' }, { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'paid', amount: 15000 }, { name: 'ì „ì‹œê¸°', status: 'paid', amount: 15000, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'paid', amount: 15000 }, { name: 'ì„±ì›ì œ', status: 'paid', amount: 15000 } ], 
                    11: [ { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'paid', amount: 16000 }, { name: 'ì˜¤ìŠ¤í‹´', status: 'paid', amount: 15000 }, { name: 'ì „ì‹œê¸°', status: 'paid', amount: 15000, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'paid', amount: 15000 }, { name: 'ì„±ì›ì œ', status: 'paid', amount: 15000 } ], 
                    12: [ { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'unpaid', amount: 0 }, { name: 'ì˜¤ìŠ¤í‹´', status: 'unpaid', amount: 0 }, { name: 'ì „ì‹œê¸°', status: 'unpaid', amount: 0, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'unpaid', amount: 0 }, { name: 'ì„±ì›ì œ', status: 'unpaid', amount: 0 } ] 
                } 
            }; 
        }
        
        const memberColors = { 'í™ë°•ì‚¬': { bg: 'bg-blue-100/80', text: 'text-blue-600', char: 'í™' }, 'ë¥˜ì§±': { bg: 'bg-purple-100/80', text: 'text-purple-600', char: 'ë¥˜' }, 'ì˜¤ìŠ¤í‹´': { bg: 'bg-emerald-100/80', text: 'text-emerald-600', char: 'ì˜¤' }, 'ì „ì‹œê¸°': { bg: 'bg-orange-100/80', text: 'text-orange-600', char: 'ì „' }, 'ì´ì§„ëˆ„': { bg: 'bg-indigo-100/80', text: 'text-indigo-600', char: 'ì´' }, 'ì„±ì›ì œ': { bg: 'bg-pink-100/80', text: 'text-pink-600', char: 'ì„±' } };
        
        window.renderMeetingStatus = function() {
            // ë¶€ê³¼ê¸ˆ ë Œë”ë§
            const penaltyListMini = document.getElementById('penalty-list-mini');
            const ticketListMini = document.getElementById('ticket-list-mini');
            
            if (!penaltyListMini || !ticketListMini) return;

            // [ì¶”ê°€ëœ ì•ˆì „ì¥ì¹˜] ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°ê°’ ì‚¬ìš©
            if (!window.meetingData) window.meetingData = getInitialMeetingData();
            
            // 1. ë¶€ê³¼ê¸ˆ ë¡œì§
            const now = new Date(); const currentRealMonth = now.getMonth() + 1;
            let htmlPenalty = ''; let hasPenalty = false;
            
            if (window.meetingData && window.meetingData.records) {
                for(let m=1; m < currentRealMonth; m++) {
                    const records = window.meetingData.records[m] || [];
                    records.forEach(mem => {
                        if(mem.status === 'unpaid') {
                             hasPenalty = true; 
                             htmlPenalty += `
                             <div class="flex flex-col mb-2 border-b border-red-100/50 pb-2 last:border-0 last:mb-0 last:pb-0">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-1.5">
                                        <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                        <span class="text-xs font-bold text-main">${mem.name}</span>
                                    </div>
                                    <span class="text-[10px] text-red-500 font-medium">${m}ì›” ë¯¸ë‚©</span>
                                </div>
                                <div class="text-right">
                                    <p class="text-[9px] text-gray-400 tracking-tight">15,000(ì›ê¸ˆ) + 10,000(ë¶€ê³¼ê¸ˆ) =</p>
                                    <p class="text-[10px] font-bold text-red-500">25,000ì›</p>
                                </div>
                             </div>`;
                        }
                    });
                }
            }
            if (!hasPenalty) htmlPenalty = `<div class="h-full flex items-center justify-center text-xs text-red-300">ì—†ìŒ</div>`;
            penaltyListMini.innerHTML = htmlPenalty;

            // 2. ë©´ì œê¶Œ ë¡œì§
            let htmlTicket = '';
            // Fix: Use defaults if missing in fetched data
            const exemptions = window.meetingData.exemptions || { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 };
            let hasTicket = false;
            for (const [name, count] of Object.entries(exemptions)) {
                if (count > 0) {
                    hasTicket = true;
                    htmlTicket += `<div class="flex items-center justify-between"><div class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span class="text-xs font-bold text-main">${name}</span></div><span class="text-[10px] bg-emerald-100 text-emerald-600 px-1.5 rounded font-bold">${count}ê°œ</span></div>`;
                }
            }
            if (!hasTicket) htmlTicket = `<div class="h-full flex items-center justify-center text-xs text-emerald-300/80">ì—†ìŒ</div>`;
            ticketListMini.innerHTML = htmlTicket;
        }

        window.renderDues = function(month) {
            const list = document.getElementById('dues-list'); const title = document.getElementById('dues-month-title'); if(!list) return; title.innerText = `${month}ì›” ê¸°ì¤€`; list.innerHTML = '';
            
            // [ì¶”ê°€ëœ ì•ˆì „ì¥ì¹˜] ë°ì´í„° ë¡œë“œ ì „ í˜¸ì¶œ ì‹œ ì´ˆê¸° ë°ì´í„° í• ë‹¹
            if (!window.meetingData) window.meetingData = getInitialMeetingData();

            // íƒ­ì´ ëª¨ì„í†µì¥ì¼ ë•Œ í˜„í™©íŒ ì—…ë°ì´íŠ¸
            if(window.activeTabIndex === 2) window.renderMeetingStatus();
            
            let records = []; if (window.meetingData && window.meetingData.records) { records = window.meetingData.records[month] || []; }
            if (records.length === 0) { list.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
            records.forEach((m, i) => {
                const c = memberColors[m.name] || { bg: 'bg-gray-100', text: 'text-gray-600', char: '?' }; const isPaid = m.status === 'paid'; const cardClass = isPaid ? 'glass-card' : 'glass-card-unpaid'; const amtClass = isPaid ? 'text-blue-500' : 'text-red-500'; const penalty = m.penalty ? `<p class="text-[10px] text-red-500 font-bold mt-1">âš ï¸ ${m.penalty}</p>` : ''; const badge = m.isLeader ? `<span class="ml-1 bg-yellow-100 text-yellow-700 text-[10px] px-1 rounded border border-yellow-200">íšŒì¥ ğŸ‘‘</span>` : '';
                list.innerHTML += `<div class="${cardClass} p-4 flex justify-between items-center animate-[fadeInUp_0.3s_ease-out]" style="animation-delay: ${i*0.05}s"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full ${c.bg} flex items-center justify-center text-sm font-bold ${c.text}">${c.char}</div><div><div class="flex items-center"><p class="text-sm font-bold text-main">${m.name}</p>${badge}</div><p class="text-xs text-gray-500">${isPaid ? 'ë‚©ë¶€ ì™„ë£Œ' : 'ë¯¸ë‚©'}</p>${penalty}</div></div><span class="text-sm font-bold ${amtClass}">${isPaid ? m.amount.toLocaleString()+'ì›' : 'ë¯¸ë‚©'}</span></div>`;
            });
        };
        
        // ê¸°ì¡´ checkAndRenderPenalty í•¨ìˆ˜ëŠ” renderMeetingStatusë¡œ ëŒ€ì²´ë˜ì—ˆìœ¼ë¯€ë¡œ ì œê±°í•˜ê±°ë‚˜ ë¹„ì›Œë‘ 
        window.checkAndRenderPenalty = function() {}; 

        window.getHolidays = function(y, m) {
            const e = {}; const p = `${y}-${String(m).padStart(2,'0')}`;
            if(m===1) e[`${p}-01`] = [{type:'holiday', title:'ì‹ ì •', time:'ê³µíœ´ì¼'}];
            if(m===3) e[`${p}-01`] = [{type:'holiday', title:'ì‚¼ì¼ì ˆ', time:'êµ­ê²½ì¼'}];
            if(m===5) e[`${p}-05`] = [{type:'holiday', title:'ì–´ë¦°ì´ë‚ ', time:'ê³µíœ´ì¼'}];
            if(m===6) e[`${p}-06`] = [{type:'holiday', title:'í˜„ì¶©ì¼', time:'ê³µíœ´ì¼'}];
            if(m===7) e[`${p}-17`] = [{type:'holiday', title:'ì œí—Œì ˆ', time:'êµ­ê²½ì¼'}]; 
            if(m===8) e[`${p}-15`] = [{type:'holiday', title:'ê´‘ë³µì ˆ', time:'êµ­ê²½ì¼'}];
            if(m===10) { e[`${p}-03`] = (e[`${p}-03`]||[]).concat([{type:'holiday', title:'ê°œì²œì ˆ', time:'êµ­ê²½ì¼'}]); e[`${p}-09`] = (e[`${p}-09`]||[]).concat([{type:'holiday', title:'í•œê¸€ë‚ ', time:'êµ­ê²½ì¼'}]); }
            if(m===12) e[`${p}-25`] = [{type:'holiday', title:'ì„±íƒ„ì ˆ', time:'ê³µíœ´ì¼'}];
            
            const lunarHolidays = {
                2024: { 2: {9:'ì„¤ë‚  ì—°íœ´', 10:'ì„¤ë‚ ', 11:'ì„¤ë‚  ì—°íœ´', 12:'ëŒ€ì²´ê³µíœ´ì¼'}, 4:{10:'êµ­íšŒì˜ì› ì„ ê±°'}, 5:{6:'ëŒ€ì²´ê³µíœ´ì¼', 15:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '}, 9:{16:'ì¶”ì„ ì—°íœ´', 17:'ì¶”ì„', 18:'ì¶”ì„ ì—°íœ´'} },
                2025: { 1: {28:'ì„¤ë‚  ì—°íœ´', 29:'ì„¤ë‚ ', 30:'ì„¤ë‚  ì—°íœ´'}, 3:{3:'ëŒ€ì²´ê³µíœ´ì¼'}, 5:{5:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', 6:'ëŒ€ì²´ê³µíœ´ì¼'}, 10:{3:'ê°œì²œì ˆ', 5:'ì¶”ì„ ì—°íœ´', 6:'ì¶”ì„', 7:'ì¶”ì„ ì—°íœ´', 8:'ëŒ€ì²´ê³µíœ´ì¼', 9:'í•œê¸€ë‚ '} },
                2026: { 2: {16:'ì„¤ë‚  ì—°íœ´', 17:'ì„¤ë‚ ', 18:'ì„¤ë‚  ì—°íœ´'}, 5:{24:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', 25:'ëŒ€ì²´ê³µíœ´ì¼'}, 9:{24:'ì¶”ì„ ì—°íœ´', 25:'ì¶”ì„', 26:'ì¶”ì„ ì—°íœ´'} },
                2027: { 2: {6:'ì„¤ë‚  ì—°íœ´', 7:'ì„¤ë‚ ', 8:'ì„¤ë‚  ì—°íœ´', 9:'ëŒ€ì²´ê³µíœ´ì¼'}, 5:{13:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '}, 9:{14:'ì¶”ì„ ì—°íœ´', 15:'ì¶”ì„', 16:'ì¶”ì„ ì—°íœ´'} },
                2028: { 1: {26:'ì„¤ë‚  ì—°íœ´', 27:'ì„¤ë‚ ', 28:'ì„¤ë‚  ì—°íœ´'}, 5:{2:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '}, 10:{2:'ì¶”ì„ ì—°íœ´', 3:'ì¶”ì„', 4:'ì¶”ì„ ì—°íœ´'} },
                2029: { 2: {12:'ì„¤ë‚  ì—°íœ´', 13:'ì„¤ë‚ ', 14:'ì„¤ë‚  ì—°íœ´'}, 5:{20:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '}, 9:{21:'ì¶”ì„ ì—°íœ´', 22:'ì¶”ì„', 23:'ì¶”ì„ ì—°íœ´'} },
                2030: { 2: {2:'ì„¤ë‚  ì—°íœ´', 3:'ì„¤ë‚ ', 4:'ì„¤ë‚  ì—°íœ´', 5:'ëŒ€ì²´ê³µíœ´ì¼'}, 5:{9:'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ '}, 9:{12:'ì¶”ì„ ì—°íœ´', 13:'ì¶”ì„', 14:'ì¶”ì„ ì—°íœ´'} }
            };

            const yearData = lunarHolidays[y];
            if (yearData && yearData[m]) {
                Object.keys(yearData[m]).forEach(day => {
                    const dayKey = `${p}-${String(day).padStart(2,'0')}`;
                    const title = yearData[m][day];
                    e[dayKey] = (e[dayKey] || []).concat([{type:'holiday', title: title, time: title.includes('ëŒ€ì²´')?'ëŒ€ì²´íœ´ì¼':'ëª…ì ˆ'}]);
                });
            }
            return e;
        }

        window.getMergedEvents = function(year, month) {
            const events = {}; const keyPrefix = `${year}-${String(month).padStart(2, '0')}`;
            const holidays = window.getHolidays(year, month); Object.keys(holidays).forEach(k => { events[k] = (events[k] || []).concat(holidays[k]); });
            events[`${keyPrefix}-06`] = (events[`${keyPrefix}-06`]||[]).concat([{ type: 'dues', title: 'íšŒë¹„ ë‚©ë¶€ì¼ ğŸ’°', time: '15,000ì›' }]);
            const birthdays = { '01-02': 'ì „ì‹œê¸° ìƒì¼ ğŸ‚', '03-22': 'ì´ì§„ëˆ„ ìƒì¼ ğŸ‚', '04-01': 'ì˜¤ìŠ¤í‹´ ìƒì¼ ğŸ‚', '06-05': 'í™ë°•ì‚¬ ìƒì¼ ğŸ‚', '06-12': 'ë¥˜ì§± ìƒì¼ ğŸ‚', '10-15': 'ì„±ì›ì œ ìƒì¼ ğŸ‚' }; Object.entries(birthdays).forEach(([d, t]) => { const [m, day] = d.split('-'); if (parseInt(m) === month) { const k = `${keyPrefix}-${day}`; events[k] = (events[k] || []).concat([{ type: 'bday', title: t, time: 'í•˜ë£¨ ì¢…ì¼' }]); } });
            if(month===6) { const l = new Date(year, month, 0).getDate(); const a = year - 2024; for(let i=1; i<=l; i++) { const k = `${keyPrefix}-${String(i).padStart(2,'0')}`; events[k] = (events[k]||[]).concat([{type:'anniv', title:`ì—”ì¡°ì´ ${a}ì£¼ë…„ ğŸ‰`, time:'í•˜ë£¨ì¢…ì¼'}]); } }
            if (year === 2025 && month === 12) { events[`${keyPrefix}-12`] = (events[`${keyPrefix}-12`]||[]).concat([{type:'school', title:'ìš°ì†¡ëŒ€(ì „ì‹œê¸°) ì¢…ê°•', time:'ì¼ì •'}]); events[`${keyPrefix}-20`] = (events[`${keyPrefix}-20`]||[]).concat([{type:'school', title:'ì•ˆë™ëŒ€(ì„±ì›ì œ) ì¢…ê°•', time:'ì¼ì •'}]); }
            if (year === 2025 && month === 2) { ['05', '06', '07'].forEach(day => { const k = `${keyPrefix}-${day}`; events[k] = (events[k]||[]).concat([{type:'meet', title:'ê²½ë¶ì¹ ê³¡, ëŒ€êµ¬ ì—¬í–‰ ğŸš…', time:'ì •ê¸°ëª¨ì„'}]); }); }
            if (year === 2025 && month === 8) { ['29', '30'].forEach(day => { const k = `${keyPrefix}-${day}`; events[k] = (events[k]||[]).concat([{type:'meet', title:'ì§„ì£¼ ì—¬í–‰ ğŸ°', time:'ì •ê¸°ëª¨ì„'}]); }); }
            const lastDay = new Date(year, month, 0).getDate(); for(let i=1; i<=lastDay; i++) { const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(i).padStart(2, '0')}`; const currentDate = new Date(dateStr); const sanghoonStart = new Date('2025-12-23'); const sanghoonEnd = new Date('2026-01-22'); if (currentDate >= sanghoonStart && currentDate <= sanghoonEnd) { if(i===1 || currentDate.getTime() === sanghoonStart.getTime()) { events[dateStr] = (events[dateStr]||[]).concat([{type:'personal', title:'ìƒí›ˆì´ ê°œì¸ ì¼ì • ğŸ ', time:'ì¥ê¸° ì¼ì •'}]); } else { events[dateStr] = (events[dateStr]||[]).concat([{type:'personal_dot', title:'ìƒí›ˆì´ ê°œì¸ ì¼ì •', time:''}]); } } }
            if (window.dynamicEvents) { Object.keys(window.dynamicEvents).forEach(k => { const [dy, dm, dd] = k.split('-').map(Number); if (dy === year && dm === month) { const list = window.dynamicEvents[k]; if(Array.isArray(list)) { const taggedList = list.map(e => ({...e, isFirebase: true})); events[k] = (events[k] || []).concat(taggedList); } } }); }
            return events;
        }

        window.renderCalendar = function(year, month) { const grid = document.getElementById('calendar-grid'); const title = document.getElementById('cal-title'); const list = document.getElementById('event-list'); if(!grid) return; title.innerText = `${year}.${String(month + 1).padStart(2, '0')}`; grid.innerHTML = ''; list.innerHTML = ''; const firstDay = new Date(year, month, 1).getDay(); const lastDate = new Date(year, month + 1, 0).getDate(); const events = window.getMergedEvents(year, month + 1); for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`; let hasEvents = false; let renderedLongTermEvents = new Set(); for(let i=1; i<=lastDate; i++) { const dKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`; const dayEvts = events[dKey]; const isToday = (i === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear()); let dots = ''; if(dayEvts) { hasEvents = true; dayEvts.forEach(e => { let c = 'bg-blue-500'; if(e.type==='holiday') c='bg-red-500'; else if(e.type==='dues') c='bg-emerald-500'; else if(e.type==='bday') c='bg-orange-400'; else if(e.type==='meet') c='bg-purple-500'; else if(e.type==='anniv') c='bg-red-500'; else if(e.type==='personal') c='bg-gray-400'; else if(e.type==='personal_dot') c='bg-gray-300'; if(e.type!=='holiday') dots += `<div class="w-1.5 h-1.5 rounded-full ${c}"></div>`; }); } let dateClass = 'text-gray-700'; const dayOfWeek = new Date(year, month, i).getDay(); if (dayOfWeek === 0) dateClass = 'text-holiday'; if(dayEvts && dayEvts.some(e => e.type === 'holiday')) dateClass = 'text-holiday'; if(isToday) dateClass = 'text-blue-600 font-bold'; grid.innerHTML += `<div class="h-14 flex flex-col items-center pt-1 rounded-xl hover:bg-white/20 transition-colors ${isToday ? 'bg-white/50 shadow-sm' : ''}"><span class="text-sm ${dateClass}">${i}</span><div class="flex gap-0.5 mt-1 flex-wrap justify-center px-1">${dots}</div></div>`; if(dayEvts) { dayEvts.forEach((e, idx) => { let onclickAttr = ''; let showPen = false; if (e.isFirebase) { const dynList = window.dynamicEvents[dKey] || []; const dynIdx = dynList.findIndex(de => de.title === e.title && de.time === e.time); if(dynIdx !== -1) { onclickAttr = `onclick="window.haptic(); window.openEditScheduleModal('${dKey}', ${dynIdx})"`; showPen = true; } } else { onclickAttr = `onclick="window.haptic(); alert('${e.type==='holiday'?e.title+'ì€ ê³µíœ´ì¼ì´ì—ìš” ğŸ‡°ğŸ‡·':'ê¸°ë³¸ ì¼ì •ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ì–´ìš” ğŸ”’'}')"`; } if(e.type === 'anniv' && month === 5) { if(!renderedLongTermEvents.has('anniv_6')) { renderedLongTermEvents.add('anniv_6'); list.innerHTML = `<div class="glass-card p-5 flex items-center gap-4 mb-2 animate-[fadeInUp_0.3s_ease-out]"><div class="w-12 h-12 rounded-full bg-white/70 flex items-center justify-center text-2xl shrink-0 shadow-sm text-red-500"><i class="fa-solid fa-cake-candles"></i></div><div><p class="text-xs text-red-500/80 mb-0.5 font-bold">6ì›” 1ì¼ ~ 6ì›” 30ì¼</p><p class="text-lg font-bold text-red-600">${e.title}</p><p class="text-xs text-red-500/80 mt-1">í•œ ë‹¬ ë‚´ë‚´ ì¶•í•˜í•´ìš”!</p></div></div>` + list.innerHTML; } } else if(e.type === 'personal' && !e.isFirebase) { if(!renderedLongTermEvents.has(e.title)) { renderedLongTermEvents.add(e.title); list.innerHTML += `<div class="glass-card p-5 flex items-center gap-4 animate-[fadeInUp_0.3s_ease-out]"><div class="w-12 h-12 rounded-full bg-white/70 flex items-center justify-center text-xl shrink-0 shadow-sm text-gray-500"><i class="fa-solid fa-house-user"></i></div><div><p class="text-xs text-gray-500 mb-0.5 font-bold">12.23 ~ 01.22</p><p class="text-base font-bold text-gray-800">${e.title}</p><p class="text-xs text-gray-500 mt-0.5">ì¥ê¸° ì¼ì •ì…ë‹ˆë‹¤</p></div></div>`; } } else if(e.type === 'personal_dot') { } else { let icon = 'fa-check text-gray-500', bg = 'bg-gray-100'; if(e.type === 'dues') { icon = 'fa-coins text-emerald-500'; bg = 'bg-emerald-100'; } else if(e.type === 'bday') { icon = 'fa-cake-candles text-orange-500'; bg = 'bg-orange-100'; } else if(e.type === 'meet') { icon = 'fa-suitcase text-purple-500'; bg = 'bg-purple-100'; } else if(e.type === 'school') { icon = 'fa-school text-blue-500'; bg = 'bg-blue-100'; } else if(e.type === 'holiday') { icon = 'fa-flag text-red-500'; bg = 'bg-red-100'; } else if(e.type === 'personal') { icon = 'fa-user text-indigo-500'; bg = 'bg-indigo-100'; } const dateStr = `${month + 1}ì›” ${i}ì¼`; const activeClass = onclickAttr ? 'active:scale-95 cursor-pointer hover:bg-white/60' : 'active:scale-95 cursor-pointer'; const penHtml = showPen ? `<i class="fa-solid fa-pen text-gray-300 text-xs ml-auto"></i>` : ''; list.innerHTML += `<div class="glass-card p-4 flex items-center gap-4 animate-[fadeInUp_0.3s_ease-out] ${activeClass}" ${onclickAttr}><div class="w-12 h-12 rounded-full ${bg} flex items-center justify-center text-xl shadow-sm"><i class="fa-solid ${icon}"></i></div><div class="flex-1"><p class="text-xs text-gray-500 font-bold">${dateStr} Â· ${e.time}</p><p class="text-base font-bold text-gray-800">${e.title}</p></div>${penHtml}</div>`; } }); } } if(!hasEvents) list.innerHTML = `<div class="text-center py-10 text-gray-400"><p class="text-sm">ì¼ì •ì´ ì—†ì–´ìš”</p></div>`; };

        window.updateTabUI = function(index) {
            window.activeTabIndex = index;
            const home = document.getElementById('home-screen');
            const sched = document.getElementById('schedule-screen');
            const meet = document.getElementById('meeting-screen');
            
            home.classList.add('hidden'); sched.classList.add('hidden'); meet.classList.add('hidden');
            sched.classList.remove('flex'); meet.classList.remove('flex');

            if(index===0) home.classList.remove('hidden');
            else if(index===1) { sched.classList.remove('hidden'); sched.classList.add('flex'); window.renderCalendar(window.viewYear, window.viewMonth); }
            else if(index===2) { meet.classList.remove('hidden'); meet.classList.add('flex'); window.renderDues(window.currentDuesMonth); }

            const ind = document.getElementById('nav-indicator');
            const btns = [document.getElementById('nav-home'), document.getElementById('nav-calendar'), document.getElementById('nav-meeting')];
            if(btns[index] && ind) {
                ind.classList.add('nav-transition');
                ind.style.width = `${btns[index].offsetWidth}px`;
                ind.style.transform = `translateX(${btns[index].offsetLeft - 6}px)`;
            }
        };

        window.onload = () => {
            setTimeout(() => { document.getElementById('startup-modal').classList.remove('hidden'); document.getElementById('startup-modal').classList.add('flex'); }, 500);
            window.setGreeting();
            window.renderCalendar(window.viewYear, window.viewMonth);
            window.updateTabUI(0);
        };

    </script>

    <!-- Firebase Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.getDoc = getDoc; 
        window.doc = doc;
        window.setDoc = setDoc;
        window.arrayUnion = arrayUnion;
        window.MEETING_PATH = ['meeting_account', 'dues_status'];
        window.SCHEDULE_PATH = ['meeting_account', 'schedules'];

        const stockConfig = { apiKey: "AIzaSyABn9xi7a-3LyLpvS6HT03gJUGTlQkgHmk", authDomain: "enjoystock.firebaseapp.com", projectId: "enjoystock", storageBucket: "enjoystock.firebasestorage.app", messagingSenderId: "981969177924", appId: "1:981969177924:web:51b0093a0d1b001ead9b11" };
        const meetingConfig = { apiKey: "AIzaSyAVQ_WdMXKuU2CgTgvSHqLKuAVGPeeDuOQ", authDomain: "enjoy-meeting-account.firebaseapp.com", projectId: "enjoy-meeting-account", storageBucket: "enjoy-meeting-account.firebasestorage.app", messagingSenderId: "956113498506", appId: "1:956113498506:web:b520f2b77fdb3295cb9873" };
        const STOCK_PATH = ['artifacts', 'enjoy-stock-live', 'public', 'data', 'stock_data', 'enjoy_ticker'];

        let meetingDb = null;

        async function init() {
            try {
                const stockApp = initializeApp(stockConfig, 'stockApp');
                const stockDb = getFirestore(stockApp);
                await signInAnonymously(getAuth(stockApp)).catch(()=>{});
                onSnapshot(doc(stockDb, ...STOCK_PATH), (s) => { if(s.exists()) updateStockUI(s.data()); });

                const meetingApp = initializeApp(meetingConfig, 'meetingApp');
                const meetingAuth = getAuth(meetingApp);
                window.meetingDb = getFirestore(meetingApp);

                await signInAnonymously(meetingAuth).catch((e) => console.warn('Meeting Auth Failed', e));

                onSnapshot(doc(window.meetingDb, ...window.MEETING_PATH), (docSnap) => {
                    if (docSnap.exists()) { window.updateMeetingUI(docSnap.data()); } 
                    else { const initialData = getInitialMeetingData(); setDoc(doc(window.meetingDb, ...window.MEETING_PATH), initialData); }
                });

                onSnapshot(doc(window.meetingDb, ...window.SCHEDULE_PATH), (docSnap) => {
                    if (docSnap.exists()) { window.dynamicEvents = docSnap.data(); window.renderCalendar(window.viewYear, window.viewMonth); } 
                    else { setDoc(doc(window.meetingDb, ...window.SCHEDULE_PATH), {}); }
                });
            } catch(e) { console.error("Firebase Init Error:", e); }
        }

        function updateStockUI(data) {
            const priceEl = document.getElementById('ticker-price'); const changeEl = document.getElementById('ticker-change');
            const base = data.basePrice || 1250; const currentPrice = data.currentPrice;
            
            // 1. ê°€ê²© ë° ë“±ë½ë¥  ì—…ë°ì´íŠ¸
            priceEl.innerText = currentPrice.toLocaleString() + "ì›";
            const diff = currentPrice - base; const rate = ((diff / base) * 100).toFixed(1); const sign = diff > 0 ? '+' : '';
            
            const isUp = diff > 0;
            const isDown = diff < 0;
            const colorClass = isUp ? 'text-red-500' : (isDown ? 'text-blue-500' : 'text-gray-400');
            const colorHex = isUp ? '#F04452' : '#3182F6'; // ìƒìŠ¹: ë¹¨ê°•, í•˜ë½/ë³´í•©: íŒŒë‘

            if (isUp) { 
                priceEl.className = `text-2xl font-bold tabular-nums tracking-tight ${colorClass} price-up`; 
                changeEl.className = `text-sm font-bold tabular-nums ${colorClass} mb-0.5`; 
                changeEl.innerText = `${sign}${rate}%`; 
            } else if (isDown) { 
                priceEl.className = `text-2xl font-bold tabular-nums tracking-tight ${colorClass} price-down`; 
                changeEl.className = `text-sm font-bold tabular-nums ${colorClass} mb-0.5`; 
                changeEl.innerText = `${rate}%`; 
            } else { 
                priceEl.className = `text-2xl font-bold tabular-nums tracking-tight text-main`;
                changeEl.className = "text-sm font-bold tabular-nums text-gray-400 mb-0.5"; 
                changeEl.innerText = "0.0%"; 
            }

            // 2. ì°¨íŠ¸ ê·¸ë¦¬ê¸° (SVG)
            const history = data.history || [];
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ì¤€ê°€ì™€ í˜„ì¬ê°€ë¡œ ë‹¨ìˆœ ì§ì„  ìƒì„±
            const chartData = history.length > 0 ? history : [base, currentPrice];
            
            const svg = document.getElementById('mini-chart');
            if (svg && chartData.length > 1) {
                const min = Math.min(...chartData);
                const max = Math.max(...chartData);
                const range = max - min || 1; // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
                
                // ì¢Œí‘œ ê³„ì‚° (SVG viewBox 0 0 100 50 ê¸°ì¤€)
                // x: 0 ~ 100
                // y: 0 ~ 50 (ê°’ì´ í´ìˆ˜ë¡ yëŠ” ì‘ì•„ì•¼ í•¨ - ìœ„ë¡œ ì˜¬ë¼ê°)
                const points = chartData.map((val, i) => {
                    const x = (i / (chartData.length - 1)) * 100;
                    const y = 50 - ((val - min) / range) * 50; 
                    return `${x},${y}`;
                }).join(' ');

                const line = document.getElementById('chart-line');
                const fill = document.getElementById('chart-fill');
                const gradStops = document.getElementById('chart-grad').children;

                // ë¼ì¸ ë° ì±„ìš°ê¸° ì—…ë°ì´íŠ¸
                if (line) {
                    line.setAttribute('points', points);
                    line.setAttribute('stroke', colorHex);
                }
                if (fill) {
                    // ì‹œì‘ì ê³¼ ëì ì„ ë°”ë‹¥(y=60)ìœ¼ë¡œ ë‚´ë ¤ì„œ ë‹«íŒ ë„í˜• ë§Œë“¤ê¸°
                    const firstX = points.split(' ')[0].split(',')[0];
                    const lastX = points.split(' ')[points.split(' ').length-1].split(',')[0];
                    fill.setAttribute('d', `M ${points} L ${lastX},60 L ${firstX},60 Z`);
                }
                
                // ê·¸ë¼ë””ì–¸íŠ¸ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                if (gradStops && gradStops.length >= 2) {
                    gradStops[0].setAttribute('stop-color', colorHex);
                    gradStops[1].setAttribute('stop-color', colorHex);
                }
            }
        }

        function getInitialMeetingData() {
            return {
                totalBalance: 448999,
                exemptions: { 'ë¥˜ì§±': 1, 'ì„±ì›ì œ': 1, 'ì „ì‹œê¸°': 1 },
                records: {
                    10: [ { name: 'ì˜¤ìŠ¤í‹´', status: 'unpaid', amount: 0, penalty: 'ë¯¸ë‚©ë¶€ë¡œ ì¸í•œ ë¶€ê³¼ê¸ˆ 10,000ì› ë°œìƒ' }, { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'paid', amount: 15000 }, { name: 'ì „ì‹œê¸°', status: 'paid', amount: 15000, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'paid', amount: 15000 }, { name: 'ì„±ì›ì œ', status: 'paid', amount: 15000 } ],
                    11: [ { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'paid', amount: 16000 }, { name: 'ì˜¤ìŠ¤í‹´', status: 'paid', amount: 15000 }, { name: 'ì „ì‹œê¸°', status: 'paid', amount: 15000, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'paid', amount: 15000 }, { name: 'ì„±ì›ì œ', status: 'paid', amount: 15000 } ],
                    12: [ { name: 'í™ë°•ì‚¬', status: 'paid', amount: 15000 }, { name: 'ë¥˜ì§±', status: 'unpaid', amount: 0 }, { name: 'ì˜¤ìŠ¤í‹´', status: 'unpaid', amount: 0 }, { name: 'ì „ì‹œê¸°', status: 'unpaid', amount: 0, isLeader: true }, { name: 'ì´ì§„ëˆ„', status: 'unpaid', amount: 0 }, { name: 'ì„±ì›ì œ', status: 'unpaid', amount: 0 } ]
                }
            };
        }

        init();
    </script>
</body>
</html>