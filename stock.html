<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Enjoy Stock - Shared Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" type="text/css"/>
    <!-- ì•„ì´ì½˜ ì‚¬ìš©ì„ ìœ„í•œ FontAwesome ì¶”ê°€ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyABn9xi7a-3LyLpvS6HT03gJUGTlQkgHmk",
            authDomain: "enjoystock.firebaseapp.com",
            projectId: "enjoystock",
            storageBucket: "enjoystock.firebasestorage.app",
            messagingSenderId: "981969177924",
            appId: "1:981969177924:web:51b0093a0d1b001ead9b11"
        };

        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "") {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = 'enjoy-stock-live';

            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.isFirebaseInitialized = true;
        } else {
            window.isFirebaseInitialized = false;
        }

        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.getDoc = getDoc;
        window.runTransaction = runTransaction;
        
        document.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { 
            font-family: "Pretendard", -apple-system, sans-serif;
            background-color: #ffffff;
            color: #191f28;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* íƒ­ ë©”ë‰´ */
        .tab-item { position: relative; color: #8b95a1; font-weight: 600; cursor: pointer; transition: color 0.2s; white-space: nowrap; }
        .tab-item.active { color: #191f28; }
        .tab-item.active::after { content: ''; position: absolute; bottom: -11px; left: 0; right: 0; height: 2px; background-color: #191f28; }

        /* í˜¸ê°€ì°½ */
        .order-row { display: grid; grid-template-columns: 1fr 1.2fr 1fr; height: 40px; align-items: center; border-bottom: 1px solid #f2f4f6; position: relative; }
        .order-cell { position: relative; height: 100%; display: flex; align-items: center; z-index: 10; padding: 0 8px; }
        .cell-ask-vol { justify-content: flex-end; color: #333; font-weight: 500; font-size: 12px; }
        .cell-price { justify-content: center; font-weight: 700; border-left: 1px solid #f2f4f6; border-right: 1px solid #f2f4f6; font-size: 13px; }
        .cell-bid-vol { justify-content: flex-start; color: #333; font-weight: 500; font-size: 12px; }

        .bg-ask { background-color: #f4f9ff; } .text-ask { color: #3182f6; }
        .bg-bid { background-color: #fff4f4; } .text-bid { color: #f04452; }
        .text-up { color: #f04452; } .text-down { color: #3182f6; }
        
        .vol-bar { height: 100%; position: absolute; top: 0; z-index: 0; opacity: 0.15; }
        .vol-bar-ask { right: 0; background-color: #3182f6; } .vol-bar-bid { left: 0; background-color: #f04452; } 

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-msg { animation: slideDown 0.3s ease-out forwards; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3182f6; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #market-closed-overlay { backdrop-filter: blur(2px); }
        .divider-section { border-top: 8px solid #f2f4f6; margin-top: 20px; padding-top: 20px; }
        .trade-bar { box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }

        /* ì£¼ë¬¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .log-item { font-size: 12px; padding: 8px 0; border-bottom: 1px solid #f2f4f6; display: flex; justify-content: space-between; align-items: center; }
        .log-item:last-child { border-bottom: none; }
        .log-time { color: #8b95a1; font-size: 10px; margin-right: 8px; }
        .log-tag { padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; margin-right: 6px; }
        .log-buy { background-color: #fff4f4; color: #f04452; }
        .log-sell { background-color: #f4f9ff; color: #3182f6; }
        .log-deposit { background-color: #f2f4f6; color: #333; }
        .log-wait { background-color: #f2f4f6; color: #6b7684; }

        /* Stepper Input Style */
        .stepper-btn { width: 52px; height: 52px; border-radius: 12px; background: #f2f4f6; color: #333; font-weight: bold; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .stepper-btn:active { background: #d1d6db; transform: scale(0.95); }
        
        /* ì¼ë³„ ì‹œì„¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (ì™„ì „ ì›ìƒ ë³µêµ¬) */
        .daily-table { width: 100%; font-size: 13px; border-collapse: collapse; table-layout: fixed; }
        .daily-table th { padding: 12px 0; color: #8b95a1; font-weight: 500; border-bottom: 1px solid #f2f4f6; text-align: right; white-space: nowrap; }
        .daily-table th:first-child { text-align: left; }
        .daily-table td { padding: 14px 0; border-bottom: 1px solid #f2f4f6; text-align: right; color: #333; white-space: nowrap; }
        .daily-table td:first-child { text-align: left; color: #8b95a1; font-size: 12px; }
        .daily-table .text-up { color: #f04452; }
        .daily-table .text-down { color: #3182f6; }
        .daily-table .text-gray { color: #333; }

        /* ì°¨íŠ¸ í† ê¸€ */
        .chart-toggle-btn { 
            padding: 4px 10px; 
            font-size: 11px; 
            font-weight: 600; 
            border-radius: 20px; 
            color: #8b95a1; 
            background-color: #f2f4f6; 
            transition: all 0.2s;
        }
        .chart-toggle-btn.active { 
            background-color: #333; 
            color: white; 
        }

        /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
        .pulse-dot {
            width: 8px; height: 8px; border-radius: 50%;
            position: absolute; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        .pulse-ring {
            content: ''; width: 100%; height: 100%;
            border-radius: 50%; position: absolute; top: 0; left: 0;
            opacity: 0; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(3.5); opacity: 0; }
        }
        
        /* íˆ¬ìì ë™í–¥ ë°” ìŠ¤íƒ€ì¼ */
        .trend-bar-bg { background-color: #f2f4f6; border-radius: 4px; height: 6px; width: 100%; overflow: hidden; position: relative; }
        .trend-bar-fill { height: 100%; border-radius: 4px; position: absolute; top: 0; left: 0; transition: width 0.5s ease; }
    </style>
</head>
<body class="flex flex-col h-[100dvh] w-screen relative">

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast-container" class="absolute top-4 left-0 right-0 flex justify-center z-[70] pointer-events-none"></div>
    
    <!-- ì„¤ì • í•„ìš” ì•ˆë‚´ ì˜¤ë²„ë ˆì´ -->
    <div id="config-overlay" class="fixed inset-0 bg-black/90 z-[110] hidden flex flex-col items-center justify-center text-white p-6 text-center backdrop-blur-sm">
        <h2 class="text-2xl font-bold mb-3">Firebase ì„¤ì • í•„ìš”</h2>
        <p class="text-gray-300 mb-6 text-sm">firebaseConfig ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
    </div>

    <!-- ë¡œë”© -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <p class="text-sm text-gray-500">ì‹œì„¸ ë™ê¸°í™” ì¤‘...</p>
    </div>

    <!-- ê³µì§€ì‚¬í•­ ë°°ë„ˆ -->
    <div class="w-full bg-[#f2f4f6] text-[#6b7684] text-[11px] font-bold py-2.5 px-4 text-center z-30 relative border-b border-gray-200">
        ğŸ“¢ ì„œë²„ í•˜ë£¨ í• ë‹¹ëŸ‰ìœ¼ë¡œ ì¸í•œ 10ë¶„ ì£¼ê¸° ì—…ë°ì´íŠ¸ë¡œ ì œí•œí•©ë‹ˆë‹¤.
    </div>

    <!-- ì¥ ë§ˆê° ì˜¤ë²„ë ˆì´ -->
    <div id="market-closed-overlay" class="absolute top-28 left-0 right-0 bottom-0 bg-white/50 z-40 hidden flex items-center justify-center pointer-events-none">
        <div class="bg-black/80 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg" id="market-msg">
            ğŸŒ™ ì¥ ë§ˆê° (08:00 ~ 23:30)
        </div>
    </div>

    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="fixed inset-0 bg-black/50 z-[70] hidden flex items-center justify-center px-6 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">ê´€ë¦¬ì ë¡œê·¸ì¸</h3>
            <input type="password" id="admin-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full bg-gray-100 rounded-xl px-4 py-3 mb-4 outline-none" inputmode="numeric">
            <div class="flex gap-2">
                <button id="btn-login-cancel" class="flex-1 py-3 rounded-xl font-bold text-gray-500 hover:bg-gray-100">ì·¨ì†Œ</button>
                <button id="btn-login-confirm" class="flex-1 py-3 rounded-xl font-bold bg-[#3182f6] text-white">í™•ì¸</button>
            </div>
        </div>
    </div>

    <!-- [NEW] ì¼ë°˜ ì•Œë¦¼ íŒì—… (í† ìŠ¤íŠ¸ ëŒ€ì²´ìš©) -->
    <div id="notice-modal" class="fixed inset-0 z-[90] bg-black/50 hidden flex items-center justify-center px-6 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-[24px] p-6 w-full max-w-xs shadow-2xl transform scale-100 transition-transform duration-300 flex flex-col items-center text-center">
            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mb-4 text-2xl">ğŸ“¢</div>
            <h3 id="notice-title" class="text-xl font-bold mb-2 text-[#191f28]">ì•Œë¦¼</h3>
            <p id="notice-msg" class="text-sm text-[#4e5968] mb-6 leading-relaxed break-keep"></p>
            <button onclick="document.getElementById('notice-modal').classList.add('hidden')" class="w-full bg-[#3182f6] text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 transition-colors shadow-md active:scale-95">í™•ì¸</button>
        </div>
    </div>

    <!-- [NEW] ì¥ ì¼ì‹œì •ì§€ ì•ˆë‚´ íŒì—… (ì‚¬ì§„ ìŠ¤íƒ€ì¼) -->
    <div id="paused-startup-modal" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl scale-in text-left relative overflow-hidden">
            <h3 class="text-xl font-bold text-[#191f28] mb-4 mt-1 text-center">ì„œë¹„ìŠ¤ ì ê²€ ì•ˆë‚´ ğŸ””</h3>
            
            <div class="space-y-3 mb-6">
                <!-- íŒŒë€ ë°•ìŠ¤ -->
                <div class="bg-blue-50 p-3.5 rounded-2xl border border-blue-100">
                    <p class="text-sm font-bold text-blue-600 mb-1 flex items-center gap-1.5">
                        <i class="fa-solid fa-circle-info"></i> í˜„ì¬ ì¥ì´ ì¼ì‹œ ì •ì§€ë¨
                    </p>
                    <p class="text-xs text-gray-600 leading-relaxed pl-0.5">
                        <span class="font-bold text-gray-800">ì ì‹œ ê±°ë˜ê°€ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</span><br>
                        ê´€ë¦¬ì ì„¤ì • ë˜ëŠ” ì„œë²„ ì ê²€ìœ¼ë¡œ ì¸í•´<br>ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œë©ë‹ˆë‹¤.
                    </p>
                </div>
                
                <!-- ë¹¨ê°„ ë°•ìŠ¤ -->
                <div class="bg-red-50 p-3.5 rounded-2xl border border-red-100">
                    <p class="text-sm font-bold text-red-500 mb-1 flex items-center gap-1.5">
                        <i class="fa-solid fa-ban"></i> ê±°ë˜ ë¶ˆê°€ ì•ˆë‚´
                    </p>
                    <ul class="text-xs text-gray-600 leading-relaxed pl-4 list-disc marker:text-red-300">
                        <li>ë§¤ìˆ˜ / ë§¤ë„ ì£¼ë¬¸ ë¶ˆê°€</li>
                        <li>ì‹¤ì‹œê°„ ì‹œì„¸ ë³€ë™ ì¤‘ë‹¨</li>
                    </ul>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('paused-startup-modal').classList.add('hidden')" class="flex-1 bg-[#F2F4F6] text-[#4E5968] font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors active:scale-95">ë‹«ê¸°</button>
                <button onclick="document.getElementById('paused-startup-modal').classList.add('hidden')" class="flex-1 bg-[#3182F6] text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 transition-colors shadow-md shadow-blue-500/20 active:scale-95">í™•ì¸í–ˆì–´ìš”</button>
            </div>
        </div>
    </div>

    <!-- [NEW] ì¥ ì¬ê°œ ì•ˆë‚´ íŒì—… (ì¶”ê°€ë¨) -->
    <div id="resumed-startup-modal" class="fixed inset-0 z-[95] bg-black/60 backdrop-blur-sm hidden flex items-center justify-center px-6">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl scale-in text-left relative overflow-hidden">
            <h3 class="text-xl font-bold text-[#191f28] mb-4 mt-1 text-center">ì„œë¹„ìŠ¤ ì¬ê°œ ì•ˆë‚´ ğŸ””</h3>
            
            <div class="space-y-3 mb-6">
                <!-- ì´ˆë¡ ë°•ìŠ¤ -->
                <div class="bg-emerald-50 p-3.5 rounded-2xl border border-emerald-100">
                    <p class="text-sm font-bold text-emerald-600 mb-1 flex items-center gap-1.5">
                        <i class="fa-solid fa-circle-check"></i> ì •ìƒ ê±°ë˜ ê°€ëŠ¥
                    </p>
                    <p class="text-xs text-gray-600 leading-relaxed pl-0.5">
                        <span class="font-bold text-gray-800">ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤.</span><br>
                        ê¸°ë‹¤ë ¤ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ì§€ê¸ˆ ë°”ë¡œ ê±°ë˜ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!
                    </p>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('resumed-startup-modal').classList.add('hidden')" class="flex-1 bg-[#3182F6] text-white font-bold py-3.5 rounded-xl hover:bg-blue-600 transition-colors shadow-md shadow-blue-500/20 active:scale-95">ê±°ë˜ ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì§€ë‚œ ë°°ë‹¹ ë³´ê¸° ëª¨ë‹¬ -->
    <div id="dividend-modal" class="fixed inset-0 bg-black/50 z-[80] hidden flex items-end justify-center backdrop-blur-sm">
        <div class="bg-white rounded-t-3xl w-full max-w-md p-6 shadow-2xl slide-up h-[60vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-[#191f28]">ì§€ë‚œ ë°°ë‹¹ ë‚´ì—­</h3>
                <button id="btn-dividend-close" class="p-2 text-gray-400 hover:text-gray-600">ë‹«ê¸°</button>
            </div>
            <div id="dividend-list-content" class="flex-1 overflow-y-auto scrollbar-hide">
                <!-- ë°°ë‹¹ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ -->
            </div>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ëª¨ë‹¬ -->
    <div id="trade-modal" class="fixed inset-0 bg-black/50 z-[60] hidden flex items-end justify-center backdrop-blur-sm">
        <div class="bg-white rounded-t-3xl w-full max-w-md p-6 shadow-2xl slide-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold" id="trade-modal-title">ë§¤ìˆ˜í•˜ê¸°</h3>
                <button id="btn-trade-close" class="p-2 text-gray-400 hover:text-gray-600">ë‹«ê¸°</button>
            </div>
            <div class="mb-5">
                <label class="block text-xs font-bold text-gray-500 mb-2">ê°€ê²© (ì›)</label>
                <div class="flex items-center gap-3">
                    <button class="stepper-btn" id="btn-price-down">-</button>
                    <div class="flex-1 h-[52px] bg-gray-50 rounded-xl border border-gray-100 flex items-center justify-center">
                        <input type="number" id="input-price" class="w-full text-center text-xl font-bold bg-transparent outline-none" value="0">
                    </div>
                    <button class="stepper-btn" id="btn-price-up">+</button>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-500 mb-2">ìˆ˜ëŸ‰ (ì£¼)</label>
                <div class="flex items-center gap-3">
                    <button class="stepper-btn" id="btn-qty-down">-</button>
                    <div class="flex-1 h-[52px] bg-gray-50 rounded-xl border border-gray-100 flex items-center justify-center">
                        <input type="number" id="input-qty" class="w-full text-center text-xl font-bold bg-transparent outline-none" value="1">
                    </div>
                    <button class="stepper-btn" id="btn-qty-up">+</button>
                </div>
            </div>
            <div class="bg-gray-50 rounded-xl p-4 mb-4 flex justify-between items-center">
                <span class="text-sm font-bold text-gray-500">ì´ ì£¼ë¬¸ ê¸ˆì•¡</span>
                <span class="text-lg font-bold text-[#191f28]"><span id="trade-total-amount">0</span>ì›</span>
            </div>
            <button id="btn-trade-confirm" class="w-full py-4 rounded-xl font-bold text-white text-lg bg-[#3182f6] shadow-lg active:scale-95 transition-transform">ì£¼ë¬¸í•˜ê¸°</button>
        </div>
    </div>

    <!-- í—¤ë” -->
    <header class="px-5 pt-6 pb-2 bg-white z-20">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <button id="btn-home" class="w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors flex-shrink-0 text-[#191f28]">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <h1 class="text-2xl font-bold tracking-tight text-[#191f28] flex items-center gap-2">
                    ì—”ì¡°ì´
                    <span class="text-[10px] font-bold text-white bg-[#f04452] px-1.5 py-0.5 rounded-full tracking-tight shadow-sm leading-tight">KOSPI</span>
                    <span id="sync-status" class="w-2 h-2 rounded-full bg-gray-300 ml-1 flex-shrink-0" title="ì„œë²„ ì—°ê²° ìƒíƒœ"></span>
                    <span id="market-mood-badge" class="text-[10px] px-2 py-0.5 rounded-full font-bold ml-1 hidden cursor-default tracking-tight"></span>
                </h1>
            </div>
            <div class="flex items-center gap-2">
                <button id="btn-profile" class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 flex items-center justify-center transition-colors border border-gray-100 flex-shrink-0">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#8b95a1" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </button>
            </div>
        </div>
        <div class="flex items-end gap-2 mb-1">
            <span id="current-price" class="text-3xl font-bold text-[#191f28]">-</span>
            <span class="text-xl font-bold text-[#191f28]">ì›</span>
        </div>
        <div class="flex items-center gap-1.5 text-sm font-medium">
            <span id="diff-label" class="text-[#8b95a1]">ì‹œì‘ê°€ë³´ë‹¤</span>
            <span id="price-diff-box" class="flex items-center gap-1 text-[#8b95a1]"><span id="price-diff">-</span><span id="price-rate"></span></span>
        </div>
    </header>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="flex items-center px-5 border-b border-[#f2f4f6] gap-5 text-[15px] mb-6 bg-white z-10 overflow-x-auto scrollbar-hide">
        <button id="tab-chart" class="tab-item active py-2.5 flex-shrink-0">ì°¨íŠ¸</button>
        <button id="tab-order" class="tab-item py-2.5 flex-shrink-0">í˜¸ê°€</button>
        <button id="tab-daily" class="tab-item py-2.5 flex-shrink-0">ì‹œì„¸</button>
        <button id="tab-account" class="tab-item py-2.5 flex-shrink-0">ê³„ì¢Œ</button>
        <button id="tab-wallet" class="tab-item py-2.5 flex-shrink-0">ë³´ìœ ìì‚°</button>
        <button id="tab-info" class="tab-item py-2.5 flex-shrink-0">ì¢…ëª©ì •ë³´</button>
        <button id="tab-hours" class="tab-item py-2.5 flex-shrink-0">ìš´ì˜ì‹œê°„</button>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="flex-1 flex flex-col relative overflow-y-auto bg-white pb-36 scrollbar-hide"> 
        
        <!-- ì°¨íŠ¸ ë·° -->
        <div id="view-chart" class="flex flex-col w-full relative">
            <div id="market-msg-container" class="absolute top-10 left-0 right-0 z-40 flex justify-center pointer-events-none hidden">
                <div class="bg-black/70 backdrop-blur-sm text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm flex items-center gap-2" id="market-msg-badge">ğŸŒ™ ì¥ ë§ˆê°</div>
            </div>

            <div class="px-5 flex flex-col mt-4 mb-2">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-1">
                        <div class="w-1.5 h-1.5 rounded-full bg-[#3182f6] animate-pulse" id="live-dot"></div>
                        <span class="text-xs font-medium text-[#8b95a1]" id="chart-status-text">ì¥ ìš´ì˜ì¤‘ (08:00~23:30)</span>
                    </div>
                    <div class="flex gap-1">
                        <button id="btn-chart-line" class="chart-toggle-btn active">ì„ í˜•</button>
                        <button id="btn-chart-candle" class="chart-toggle-btn">ìº”ë“¤</button>
                    </div>
                </div>
            </div>
            
            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="w-full h-[280px] relative mt-2" id="chart-container">
                <canvas id="chart-canvas" class="w-full h-full block"></canvas>
                
                <!-- í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì  -->
                <div id="chart-pulse-dot" class="pulse-dot hidden" style="background-color: #3182f6;">
                    <div class="pulse-ring" style="background-color: #3182f6;"></div>
                </div>

                <div id="label-high" class="absolute text-[11px] text-[#3182f6] font-medium opacity-0">ìµœê³  <span id="val-high"></span></div>
                <div id="label-low" class="absolute text-[11px] text-[#3182f6] font-medium opacity-0">ìµœì € <span id="val-low"></span></div>
                <!-- ì‹œê°„ ì¶• ë¼ë²¨ -->
                <div class="absolute bottom-1 left-2 text-[10px] text-gray-400">08:00</div>
                <div class="absolute bottom-1 right-2 text-[10px] text-gray-400">23:30</div>
                <div class="absolute left-0 right-0 border-t border-dashed border-[#e5e8eb]" style="top: 50%;" id="base-line"></div>
            </div>
            
            <div class="divider-section mx-5">
                <p class="text-[10px] text-gray-300 mb-2">ì°¨íŠ¸ëŠ” ì˜¤ëŠ˜ í•˜ë£¨ì˜ ì „ì²´ íë¦„(08:00~23:30)ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
            </div>

            <!-- íˆ¬ìì ë™í–¥ (ì°¨íŠ¸ ë·°) -->
            <div class="px-5 mt-6 mb-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-[#191f28]">íˆ¬ìì ë™í–¥</h3>
                    <span class="text-xs text-[#8b95a1] flex items-center gap-1">ì˜¤ëŠ˜ <span class="w-3.5 h-3.5 border border-gray-300 rounded-full flex items-center justify-center text-[9px] text-gray-400">?</span></span>
                </div>
                <!-- ê°œì¸ -->
                <div class="flex items-center justify-between mb-3 text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ê°œì¸</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-chart-ind-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-chart-ind-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
                <!-- ì™¸êµ­ì¸ -->
                <div class="flex items-center justify-between mb-3 text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ì™¸êµ­ì¸</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-chart-for-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-chart-for-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
                <!-- ê¸°ê´€ -->
                <div class="flex items-center justify-between text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ê¸°ê´€</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-chart-ins-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-chart-ins-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
            </div>
        </div>

        <!-- í˜¸ê°€, ì‹œì„¸, ê³„ì¢Œ, ìì‚°, ì •ë³´ ë·° -->
        <div id="view-order" class="hidden flex-col w-full pb-10">
            <div class="grid grid-cols-[1fr_1.2fr_1fr] text-xs text-[#8b95a1] border-b border-[#f2f4f6] pb-2 px-0 bg-white sticky top-0 z-10">
                <div class="text-center">ë§¤ë„ì”ëŸ‰</div><div class="text-center">í˜¸ê°€</div><div class="text-center">ë§¤ìˆ˜ì”ëŸ‰</div>
            </div>
            <div id="order-book-list" class="flex flex-col w-full"></div>
        </div>
        <div id="view-daily" class="hidden flex-col w-full px-5 pb-10">
             <table class="daily-table"><thead><tr><th>ì¼ì</th><th>ì¢…ê°€</th><th>ë“±ë½ë¥ </th><th>ê±°ë˜ëŸ‰</th><th style="padding-right: 0;">ê±°ë˜ëŒ€ê¸ˆ</th></tr></thead><tbody id="daily-quote-list"></tbody></table>
        </div>
        
        <!-- ê³„ì¢Œ ë·° -->
        <div id="view-account" class="hidden flex-col w-full px-5 pt-4">
            <!-- ë‚´ ìì‚° ì„¹ì…˜ -->
            <div class="bg-[#f9fafb] rounded-2xl p-6 border border-[#f2f4f6] shadow-sm">
                <p class="text-sm text-[#8b95a1] mb-1 flex items-center gap-1">ğŸ¤ ìš°ë¦¬ë“¤ì˜ ê³µìš© ê³„ì¢Œ ì”ê³ </p>
                <h2 class="text-3xl font-bold text-[#191f28] mb-4"><span id="my-cash">0</span>ì›</h2>
                <div class="flex gap-4 border-t border-[#e5e8eb] pt-4">
                    <div class="flex-1">
                        <span class="block text-xs text-[#8b95a1] mb-1">ë³´ìœ  ì—”ì¡°ì´</span>
                        <span class="block text-lg font-bold text-[#191f28]"><span id="my-stock-cnt">0</span>ì£¼</span>
                    </div>
                    <div class="flex-1 text-right">
                        <span class="block text-xs text-[#8b95a1] mb-1">ìˆ˜ìµë¥  (í‰ë‹¨ <span id="my-avg-price">0</span>)</span>
                        <span class="block text-lg font-bold" id="my-return-rate">0%</span>
                    </div>
                </div>
            </div>
            <div class="mt-8 mb-8">
                <h3 class="text-sm font-bold text-[#191f28] mb-3">ğŸ“‹ ì‹¤ì‹œê°„ ì…ê¸ˆ ë‚´ì—­</h3>
                <div id="deposit-history-list" class="flex flex-col"></div>
            </div>
        </div>

        <div id="view-wallet" class="hidden flex-col w-full px-6 pt-10">
            <div class="mb-8"><p class="text-sm font-medium text-gray-500 mb-1">1ì£¼ í‰ê· ê¸ˆì•¡</p><div class="flex items-end gap-1"><h2 class="text-4xl font-bold text-[#191f28] tracking-tight"><span id="w-avg-price-big">0</span>ì›</h2></div></div>
            <div class="flex flex-col divide-y divide-gray-100 border-t border-b border-gray-100">
                <div class="flex justify-between items-center py-5"><span class="text-gray-500 font-medium">ë³´ìœ  ìˆ˜ëŸ‰</span><span class="text-[#191f28] font-bold text-lg"><span id="w-stock-qty">0</span>ì£¼</span></div>
                <div class="flex justify-between items-start py-5"><span class="text-gray-500 font-medium mt-1">ì´ í‰ê°€ê¸ˆì•¡</span><div class="text-right"><div class="text-[#191f28] font-bold text-lg mb-0.5"><span id="w-total-val">0</span>ì›</div><div class="text-sm font-medium" id="w-pl-info">0 (0.0%)</div></div></div>
                <div class="flex justify-between items-center py-5"><span class="text-gray-500 font-medium">íˆ¬ì ì›ê¸ˆ</span><span class="text-[#191f28] font-bold text-lg"><span id="w-principal">0</span>ì›</span></div>
                <div class="flex justify-between items-center py-5"><span class="text-gray-500 font-medium">ë³´ìœ  í˜„ê¸ˆ</span><span class="text-[#191f28] font-bold text-lg"><span id="w-cash-row">0</span>ì›</span></div>
            </div>
            <div class="mt-10"><h3 class="text-sm font-bold text-[#191f28] mb-3 flex items-center gap-2">â³ ë¯¸ì²´ê²° ì£¼ë¬¸ <span id="pending-count" class="bg-gray-100 text-gray-600 text-[10px] px-1.5 py-0.5 rounded-full">0</span></h3><div id="pending-order-list" class="flex flex-col space-y-2"></div></div>
            <div class="mt-8 mb-20"><h3 class="text-sm font-bold text-[#191f28] mb-3">ğŸ“‹ ì‹¤ì‹œê°„ ì²´ê²° ë‚´ì—­</h3><div id="w-trade-history-list" class="flex flex-col"></div></div>
        </div>
        <div id="view-info" class="hidden flex-col w-full px-5 pt-4">
            <div class="bg-[#f9fafb] p-5 rounded-2xl border border-[#f2f4f6] mb-6">
                <h3 class="font-bold text-lg mb-2">ê¸°ì—… ê°œìš”</h3>
                <div class="text-sm text-[#6b7684] space-y-2"><p><span class="font-bold text-[#333]">ì¢…ëª©ëª…</span> ì—”ì¡°ì´ (Enjoy)</p><p><span class="font-bold text-[#333]">ìƒì¥ì¼</span> 2025.11.23</p><p><span class="font-bold text-[#333]">ì‹œì‘ê°€</span> 100ì›</p></div>
            </div>

            <!-- ì£¼ê°€ ì •ë³´ (ì •ë³´ ë·°) -->
            <div class="mb-10">
                <h3 class="font-bold text-lg text-[#191f28] mb-4">ì£¼ê°€ ì •ë³´</h3>
                <!-- Day Range -->
                <div class="mb-4">
                    <div class="relative h-2 bg-[#f2f4f6] rounded-full mb-2">
                       <div class="absolute top-0 bottom-0 left-0 right-0 bg-[#f2f4f6] rounded-full"></div>
                       <div id="price-bar-day-dot" class="absolute top-1/2 -mt-1.5 w-3 h-3 bg-[#3182f6] rounded-full border-2 border-white shadow-sm z-10 transition-all duration-500 -translate-x-1/2" style="left: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <div class="text-left">
                            <span class="block text-[#8b95a1] mb-0.5">1ì¼ ìµœì €ê°€</span>
                            <span class="block font-bold text-[#191f28]" id="info-day-low">0ì›</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[#8b95a1] mb-0.5">1ì¼ ìµœê³ ê°€</span>
                            <span class="block font-bold text-[#191f28]" id="info-day-high">0ì›</span>
                        </div>
                    </div>
                </div>

                <!-- 52 Week Range -->
                <div>
                    <div class="relative h-2 bg-[#f2f4f6] rounded-full mb-2">
                       <div id="price-bar-year-dot" class="absolute top-1/2 -mt-1.5 w-3 h-3 bg-[#3182f6] rounded-full border-2 border-white shadow-sm z-10 transition-all duration-500 -translate-x-1/2" style="left: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs">
                        <div class="text-left">
                            <span class="block text-[#8b95a1] mb-0.5">1ë…„ ìµœì €ê°€</span>
                            <span class="block font-bold text-[#191f28]">1ì›</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-[#8b95a1] mb-0.5">1ë…„ ìµœê³ ê°€</span>
                            <span class="block font-bold text-[#191f28]" id="info-year-high">124,547ì›</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- íˆ¬ìì ë™í–¥ (ì •ë³´ ë·°) -->
            <div class="investor-trend-box mb-10">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-[#191f28]">íˆ¬ìì ë™í–¥</h3>
                    <span class="text-xs text-[#8b95a1] flex items-center gap-1">ì˜¤ëŠ˜ <span class="w-3.5 h-3.5 border border-gray-300 rounded-full flex items-center justify-center text-[9px] text-gray-400">?</span></span>
                </div>
                <!-- ê°œì¸ -->
                <div class="flex items-center justify-between mb-3 text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ê°œì¸</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-info-ind-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-info-ind-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
                <!-- ì™¸êµ­ì¸ -->
                <div class="flex items-center justify-between mb-3 text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ì™¸êµ­ì¸</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-info-for-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-info-for-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
                <!-- ê¸°ê´€ -->
                <div class="flex items-center justify-between text-sm">
                    <span class="text-[#6b7684] w-12 font-medium">ê¸°ê´€</span>
                    <span class="text-[#191f28] font-bold w-16 text-right tabular-nums tracking-tight" id="it-info-ins-val">0</span>
                    <div class="flex-1 ml-3 trend-bar-bg"><div id="it-info-ins-bar" class="trend-bar-fill bg-[#d1d6db]" style="width: 0%"></div></div>
                </div>
            </div>

            <!-- íˆ¬ì ì§€í‘œ (ì •ë³´ ë·°) -->
            <div class="mt-6 mb-10">
                <h3 class="font-bold text-lg text-[#191f28] mb-4">íˆ¬ì ì§€í‘œ</h3>
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">ì‹œê°€ì´ì•¡</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-market-cap">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">ë°°ë‹¹ìˆ˜ìµë¥ </span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-dividend-yield">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">PBR</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-pbr">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">PER</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-per">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">ROE</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-roe">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">PSR</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-psr">-</span>
                    </div>
                    <div class="bg-[#f9fafb] rounded-xl py-4 px-2 flex flex-col items-center justify-center text-center">
                        <span class="text-xs text-[#8b95a1] mb-1">ì™¸êµ­ì¸ì†Œì§„ìœ¨</span>
                        <span class="text-sm font-bold text-[#191f28]" id="info-foreign">-</span>
                    </div>
                </div>
            </div>

            <!-- ë°°ë‹¹ ì†Œì‹ (ì •ë³´ ë·°) -->
            <div class="mb-10">
                <div class="flex justify-between items-baseline mb-4">
                    <h3 class="font-bold text-lg text-[#191f28]">ë°°ë‹¹ ì†Œì‹</h3>
                    <span class="text-xs text-[#8b95a1]">ìµœê·¼ 12ê°œì›”</span>
                </div>
                <div class="space-y-6">
                    <div class="flex justify-between items-start">
                        <span class="text-sm text-[#6b7684]">ì§€ê¸‰í•œ íšŸìˆ˜</span>
                        <div class="text-right">
                            <div class="font-bold text-[#191f28] text-base"><span id="info-div-count">0</span>ë²ˆ</div>
                            <div class="text-xs text-[#8b95a1] mt-0.5" id="info-div-months">-</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-[#6b7684]">1ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ</span>
                        <div class="font-bold text-[#191f28] text-base"><span id="info-div-per-share">0</span>ì›</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-[#6b7684]">ë°°ë‹¹ ìˆ˜ìµë¥ </span>
                        <div class="font-bold text-[#191f28] text-base" id="info-div-yield-2">0.00%</div>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="btn-view-dividends" class="text-sm text-[#6b7684] font-medium flex items-center justify-center w-full py-2 hover:bg-gray-50 rounded-lg transition-colors">ì§€ë‚œ ë°°ë‹¹ ë³´ê¸° <svg class="w-4 h-4 ml-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                </div>
            </div>
        </div>

        <!-- ìš´ì˜ì‹œê°„ ë·° (ì¶”ê°€ë¨) -->
        <div id="view-hours" class="hidden flex-col w-full px-5 pt-4">
            <div class="bg-[#f9fafb] p-6 rounded-2xl border border-[#f2f4f6] flex flex-col items-center justify-center text-center h-40">
                <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mb-3 text-blue-500 text-xl">
                    <i class="fa-regular fa-clock"></i>
                </div>
                <h3 class="font-bold text-lg text-[#191f28] mb-1">ë§¤ì¼ ìš´ì˜</h3>
                <p class="text-sm text-[#6b7684] font-medium">ì˜¤ì „ 08ì‹œ ~ ë°¤ 11ì‹œ 30ë¶„</p>
            </div>
        </div>
    </main>

    <!-- í•˜ë‹¨ ë§¤ìˆ˜/ë§¤ë„ ë²„íŠ¼ -->
    <div class="fixed bottom-0 left-0 right-0 bg-white px-4 py-3 trade-bar z-40 flex gap-3 pb-safe">
        <button id="btn-sell" class="flex-1 bg-[#e8f3ff] text-[#3182f6] font-bold py-3.5 rounded-xl text-lg active:scale-95 transition-transform">ë§¤ë„</button>
        <button id="btn-buy" class="flex-1 bg-[#f04452] text-white font-bold py-3.5 rounded-xl text-lg active:scale-95 transition-transform shadow-lg shadow-red-200">ë§¤ìˆ˜</button>
    </div>

    <!-- ê´€ë¦¬ì íŒ¨ë„ -->
    <div id="admin-panel" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-50 hidden shadow-[0_-5px_20px_rgba(0,0,0,0.1)] slide-up max-h-[60vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-3"><div class="flex items-center gap-2"><h4 class="font-bold text-[#191f28] text-sm">ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ</h4><span id="admin-timer" class="text-xs text-red-500 font-mono hidden bg-red-100 px-2 py-0.5 rounded-full">00:30</span></div></div>
        <div class="grid grid-cols-2 gap-3 mb-3"><button id="btn-admin-surge" class="bg-red-600 text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">ğŸš€ ê¸‰ë“± (10~20%)</button><button id="btn-admin-crash" class="bg-blue-600 text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">ğŸ“‰ ê¸‰ë½ (10~20%)</button></div>
        <div class="grid grid-cols-2 gap-3 mb-3"><button id="btn-admin-up" class="bg-[#f04452] text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">ğŸ“ˆ ìƒìŠ¹ (30ì´ˆ)</button><button id="btn-admin-down" class="bg-[#3182f6] text-white font-bold py-3 rounded-xl active:scale-95 transition-transform">ğŸ“‰ í•˜ë½ (30ì´ˆ)</button></div>
        <div class="grid grid-cols-2 gap-3 mb-3"><button id="btn-market-resume" class="bg-green-500 text-white font-bold py-2 rounded-xl active:scale-95 transition-transform text-sm">ğŸ”” ì¥ ì¬ê°œ</button><button id="btn-market-pause" class="bg-gray-700 text-white font-bold py-2 rounded-xl active:scale-95 transition-transform text-sm">â¸ ì¥ ì¼ì‹œì •ì§€</button></div>
        
        <!-- [NEW] ì‹œì„¸ ê°•ì œ ê¸°ë¡ ë²„íŠ¼ ì¶”ê°€ -->
        <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-200">
            <p class="text-xs font-bold text-gray-500 mb-2">ğŸ“Š ì‹œì„¸ ê´€ë¦¬ (23:30 ìë™ ì €ì¥ë¨)</p>
            <button id="btn-admin-record-daily" class="w-full bg-[#333] text-white font-bold py-2 rounded-lg text-sm active:scale-95 transition-transform">ì˜¤ëŠ˜ ì¢…ê°€ ê¸°ë¡í•˜ê¸° (ê°•ì œ)</button>
        </div>

        <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-200"><p class="text-xs font-bold text-gray-500 mb-2">ğŸ’° ê¸°ì¤€ê°€ ìˆ˜ë™ ì„¤ì •</p><div class="flex gap-2"><input type="number" id="base-price-input" placeholder="ê°€ê²©" class="flex-1 bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none"><button id="btn-admin-base-price" class="bg-[#333] text-white font-bold px-4 rounded-lg text-sm">ì„¤ì •</button></div></div>
        <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-200"><p class="text-xs font-bold text-gray-500 mb-2">ğŸ’° ê³µìš© ì…ê¸ˆ</p><div class="flex gap-2"><input type="number" id="deposit-input" placeholder="ê¸ˆì•¡" class="flex-1 bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm outline-none"><button id="btn-admin-deposit" class="bg-[#333] text-white font-bold px-4 rounded-lg text-sm">ì…ê¸ˆ</button></div></div>
        <button id="btn-logout" class="w-full bg-gray-100 text-gray-500 font-bold py-2 rounded-xl active:scale-95 transition-transform text-xs">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <script>
        document.addEventListener('firebase-ready', () => {
            const els = {
                // ... existing elements ...
                price: document.getElementById('current-price'), diffBox: document.getElementById('price-diff-box'),
                diffLabel: document.getElementById('diff-label'), diffVal: document.getElementById('price-diff'), rate: document.getElementById('price-rate'),
                chartContainer: document.getElementById('chart-container'), canvas: document.getElementById('chart-canvas'),
                labelHigh: document.getElementById('label-high'), labelLow: document.getElementById('label-low'), valHigh: document.getElementById('val-high'), valLow: document.getElementById('val-low'),
                baseLine: document.getElementById('base-line'), liveDot: document.getElementById('live-dot'),
                btnHome: document.getElementById('btn-home'),
                marketMoodBadge: document.getElementById('market-mood-badge'), orderList: document.getElementById('order-book-list'),
                viewChart: document.getElementById('view-chart'), viewOrder: document.getElementById('view-order'), viewInfo: document.getElementById('view-info'), viewWallet: document.getElementById('view-wallet'), viewDaily: document.getElementById('view-daily'), viewAccount: document.getElementById('view-account'), viewHours: document.getElementById('view-hours'),
                tabChart: document.getElementById('tab-chart'), tabOrder: document.getElementById('tab-order'), tabInfo: document.getElementById('tab-info'), tabWallet: document.getElementById('tab-wallet'), tabDaily: document.getElementById('tab-daily'), tabAccount: document.getElementById('tab-account'), tabHours: document.getElementById('tab-hours'),
                toastContainer: document.getElementById('toast-container'), loadingOverlay: document.getElementById('loading-overlay'), syncStatus: document.getElementById('sync-status'),
                btnProfile: document.getElementById('btn-profile'),
                loginModal: document.getElementById('login-modal'), inputPw: document.getElementById('admin-pw'),
                btnLoginConfirm: document.getElementById('btn-login-confirm'), btnLoginCancel: document.getElementById('btn-login-cancel'),
                adminPanel: document.getElementById('admin-panel'), btnAdminUp: document.getElementById('btn-admin-up'), btnAdminDown: document.getElementById('btn-admin-down'), btnLogout: document.getElementById('btn-logout'), adminTimer: document.getElementById('admin-timer'),
                btnMarketResume: document.getElementById('btn-market-resume'), btnMarketPause: document.getElementById('btn-market-pause'),
                btnAdminSurge: document.getElementById('btn-admin-surge'), btnAdminCrash: document.getElementById('btn-admin-crash'),
                marketMsgContainer: document.getElementById('market-msg-container'), marketMsgBadge: document.getElementById('market-msg-badge'), chartStatus: document.getElementById('chart-status-text'),
                myCash: document.getElementById('my-cash'), myStockCnt: document.getElementById('my-stock-cnt'), myAvgPrice: document.getElementById('my-avg-price'), myReturnRate: document.getElementById('my-return-rate'),
                wAvgPriceBig: document.getElementById('w-avg-price-big'), wStockQty: document.getElementById('w-stock-qty'), wTotalVal: document.getElementById('w-total-val'), wPlInfo: document.getElementById('w-pl-info'), wPrincipal: document.getElementById('w-principal'), wCashRow: document.getElementById('w-cash-row'),
                btnBuy: document.getElementById('btn-buy'), btnSell: document.getElementById('btn-sell'), 
                depositInput: document.getElementById('deposit-input'), btnAdminDeposit: document.getElementById('btn-admin-deposit'),
                basePriceInput: document.getElementById('base-price-input'), btnAdminBasePrice: document.getElementById('btn-admin-base-price'), 
                btnAdminRecordDaily: document.getElementById('btn-admin-record-daily'), // [NEW] ë²„íŠ¼ ì—˜ë¦¬ë¨¼íŠ¸ ì¶”ê°€
                historyList: document.getElementById('trade-history-list'), 
                wHistoryList: document.getElementById('w-trade-history-list'), 
                depositList: document.getElementById('deposit-history-list'), 
                dailyQuoteList: document.getElementById('daily-quote-list'),
                pendingList: document.getElementById('pending-order-list'), pendingCount: document.getElementById('pending-count'),
                tradeModal: document.getElementById('trade-modal'), tradeTitle: document.getElementById('trade-modal-title'),
                inputPrice: document.getElementById('input-price'), inputQty: document.getElementById('input-qty'),
                btnPriceUp: document.getElementById('btn-price-up'), btnPriceDown: document.getElementById('btn-price-down'),
                btnQtyUp: document.getElementById('btn-qty-up'), btnQtyDown: document.getElementById('btn-qty-down'),
                btnTradeConfirm: document.getElementById('btn-trade-confirm'), btnTradeClose: document.getElementById('btn-trade-close'),
                tradeTotalAmount: document.getElementById('trade-total-amount'),
                btnChartLine: document.getElementById('btn-chart-line'), btnChartCandle: document.getElementById('btn-chart-candle'), configOverlay: document.getElementById('config-overlay'),
                chartPulseDot: document.getElementById('chart-pulse-dot'),
                itChartIndVal: document.getElementById('it-chart-ind-val'), itChartIndBar: document.getElementById('it-chart-ind-bar'),
                itChartForVal: document.getElementById('it-chart-for-val'), itChartForBar: document.getElementById('it-chart-for-bar'),
                itChartInsVal: document.getElementById('it-chart-ins-val'), itChartInsBar: document.getElementById('it-chart-ins-bar'),
                itInfoIndVal: document.getElementById('it-info-ind-val'), itInfoIndBar: document.getElementById('it-info-ind-bar'),
                itInfoForVal: document.getElementById('it-info-for-val'), itInfoForBar: document.getElementById('it-info-for-bar'),
                itInfoInsVal: document.getElementById('it-info-ins-val'), itInfoInsBar: document.getElementById('it-info-ins-bar'),
                infoMarketCap: document.getElementById('info-market-cap'), infoDividendYield: document.getElementById('info-dividend-yield'),
                infoPbr: document.getElementById('info-pbr'), infoPer: document.getElementById('info-per'),
                infoRoe: document.getElementById('info-roe'), infoPsr: document.getElementById('info-psr'),
                infoForeign: document.getElementById('info-foreign'),
                infoDivCount: document.getElementById('info-div-count'), infoDivMonths: document.getElementById('info-div-months'),
                infoDivPerShare: document.getElementById('info-div-per-share'), infoDivYield2: document.getElementById('info-div-yield-2'),
                btnViewDividends: document.getElementById('btn-view-dividends'),
                dividendModal: document.getElementById('dividend-modal'),
                btnDividendClose: document.getElementById('btn-dividend-close'),
                dividendListContent: document.getElementById('dividend-list-content'),
                infoDayLow: document.getElementById('info-day-low'), infoDayHigh: document.getElementById('info-day-high'),
                infoYearHigh: document.getElementById('info-year-high'),
                priceBarDayDot: document.getElementById('price-bar-day-dot'), priceBarYearDot: document.getElementById('price-bar-year-dot')
            };

            if (!window.isFirebaseInitialized) { els.loadingOverlay.style.display = 'none'; els.configOverlay.classList.remove('hidden'); return; }

            const fmt = n => n.toLocaleString();
            const fmtAmt = n => { if(n >= 100000000) return (n/100000000).toFixed(1) + "ì–µ"; if(n >= 10000) return (n/10000).toFixed(0) + "ë§Œ"; return fmt(n); };
            const showToast = (msg) => { const toast = document.createElement('div'); toast.className = 'toast-msg bg-[#333] text-white text-xs px-4 py-2 rounded-full shadow-lg mb-2 pointer-events-auto'; toast.innerText = msg; els.toastContainer.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; setTimeout(() => toast.remove(), 500); }, 2000); };
            
            // New Notification Modal Helper
            function showNoticeModal(title, msg) {
                const modal = document.getElementById('notice-modal');
                const titleEl = document.getElementById('notice-title');
                const msgEl = document.getElementById('notice-msg');
                if (modal && titleEl && msgEl) {
                    titleEl.innerText = title;
                    msgEl.innerHTML = msg; // Allow HTML for line breaks
                    modal.classList.remove('hidden');
                }
            }

            // ğŸ”¹ ì´ˆê¸°ê°’ (1885ì› ì„¤ì •: ì‚¬ìš©ìì˜ ìš”ì²­ëŒ€ë¡œ 1271ì„ ë” ì´ìƒ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
            let state = {
                currentPrice: 1885, basePrice: 1885, basePriceLabel: "ì‹œì‘ê°€ë³´ë‹¤", history: [1885], tab: 'chart',
                lastUpdated: 0, isConnected: false, adminTrend: null, adminTrendUntil: 0, manualPause: false, isAdmin: false,
                chartOffset: 0, isDragging: false, lastX: 0, marketMood: 'neutral', nextMoodChange: 0,
                walletCash: 0, walletStocks: 0, walletAvgPrice: 0, pendingOrders: [], tradeLogs: [], tradeType: 'line',
                dailyHistory: [], todayVolume: 0, todayTradeAmount: 0,
                chartType: 'line', droppedTicks: 0, zoomScale: 1.0,
                investor: { individual: 0, foreigner: 0, institution: 0 },
                prevManualPause: null, 
                isFirstLoad: true, 
                lastProcessedResumeTime: 0,
                isUpdating: false // [NEW] ì¤‘ë³µ ì—…ë°ì´íŠ¸ ë°©ì§€ í”Œë˜ê·¸
            };

            const MARKET_START_HOUR = 8;
            const MARKET_START_MIN = 0;
            const MARKET_END_HOUR = 23;
            const MARKET_END_MIN = 30;
            const TOTAL_TICKS = 94; 

            const ctx = els.canvas.getContext('2d');
            let size = { w: 0, h: 0 };
            
            const resize = () => { const rect = els.chartContainer.getBoundingClientRect(); if(rect.width === 0) return; els.canvas.width = rect.width * window.devicePixelRatio; els.canvas.height = rect.height * window.devicePixelRatio; ctx.scale(window.devicePixelRatio, window.devicePixelRatio); size = { w: rect.width, h: rect.height }; };
            window.addEventListener('resize', resize);
            
            function checkMarketStatus() { 
                const now = new Date(); 
                const currentTimeVal = now.getHours() * 60 + now.getMinutes(); 
                const startVal = MARKET_START_HOUR * 60 + MARKET_START_MIN;
                const endVal = MARKET_END_HOUR * 60 + MARKET_END_MIN; 
                return (currentTimeVal >= startVal && currentTimeVal < endVal) && !state.manualPause; 
            }

            function calculatePriceChange(price) {
                let change = 0; 
                const randomChance = Math.random(); 
                const isRandomEvent = randomChance < 0.017;
                
                if (isRandomEvent) { 
                    const factor = 0.10 + (Math.random() * 0.10); 
                    const isSurge = Math.random() > 0.5; 
                    change = Math.floor(price * factor); 
                    if (!isSurge) change = -change; 
                } else { 
                    if (state.adminTrend && state.adminTrendUntil > Date.now()) { 
                        if (state.adminTrend === 'up') change = Math.floor(Math.random() * 6) + 2; 
                        else change = Math.floor(Math.random() * -6) - 2; 
                    } else { 
                        if (state.marketMood === 'bull') change = Math.floor(Math.random() * 10) - 3; 
                        else if (state.marketMood === 'bear') change = Math.floor(Math.random() * 10) - 6; 
                        else change = Math.floor(Math.random() * 11) - 5; 
                        if (change === 0) change = Math.random() > 0.5 ? 1 : -1; 
                    } 
                }
                return change;
            }

            // ---- [Function Definitions Moved Up for Hoisting Safety] ----

            function drawChart() { 
                if(state.tab !== 'chart') return; 
                const { w, h } = size; if(w === 0) { resize(); return; } 
                ctx.clearRect(0, 0, w, h); 
                const fullHistory = state.history; if (fullHistory.length === 0) return; 
                
                let minVal = Math.min(...fullHistory); let maxVal = Math.max(...fullHistory); 
                minVal = Math.min(minVal, state.basePrice); maxVal = Math.max(maxVal, state.basePrice); 
                if (maxVal === minVal) { maxVal += 10; minVal -= 10; } else { const padding = (maxVal - minVal) * 0.1; maxVal += padding; minVal -= padding; } 
                const range = maxVal - minVal; 
                const baseY = h - ((state.basePrice - minVal) / range) * h; 
                els.baseLine.style.top = `${(baseY / h) * 100}%`; els.baseLine.classList.remove('hidden'); 
                
                const xStep = (w - 40) / (TOTAL_TICKS - 1); 
                let lastPoint = { x: 0, y: 0 }; 
                
                if (state.chartType === 'line') { 
                    const lastVal = fullHistory[fullHistory.length - 1]; const isUp = lastVal >= state.basePrice; const color = isUp ? '#f04452' : '#3182f6'; 
                    els.labelHigh.style.color = color; els.labelLow.style.color = color; els.liveDot.style.backgroundColor = color; 
                    els.chartPulseDot.style.backgroundColor = color; els.chartPulseDot.querySelector('.pulse-ring').style.backgroundColor = color; 
                    
                    ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2.5; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
                    fullHistory.forEach((p, i) => { 
                        const x = 20 + i * xStep; const y = h - ((p - minVal) / range) * h; 
                        if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
                        if (i === fullHistory.length - 1) { lastPoint = { x, y }; } 
                    }); 
                    ctx.stroke(); 
                    
                    if (fullHistory.length > 0) { 
                        const lastX = 20 + (fullHistory.length - 1) * xStep; 
                        ctx.lineTo(lastX, h); ctx.lineTo(20, h); ctx.closePath(); 
                        const grad = ctx.createLinearGradient(0, 0, 0, h); 
                        grad.addColorStop(0, isUp ? 'rgba(240, 68, 82, 0.05)' : 'rgba(49, 130, 246, 0.05)'); 
                        grad.addColorStop(1, 'rgba(255, 255, 255, 0)'); 
                        ctx.fillStyle = grad; ctx.fill(); 
                        const lastY = h - ((lastVal - minVal) / range) * h; 
                        ctx.beginPath(); ctx.fillStyle = color; ctx.arc(lastX, lastY, 4, 0, Math.PI * 2); ctx.fill(); 
                    } 
                    
                    if (checkMarketStatus()) { els.chartPulseDot.classList.remove('hidden'); els.chartPulseDot.style.left = `${lastPoint.x}px`; els.chartPulseDot.style.top = `${lastPoint.y}px`; } else { els.chartPulseDot.classList.add('hidden'); } 
                    
                    const maxValData = Math.max(...fullHistory); const minValData = Math.min(...fullHistory); 
                    els.valHigh.innerText = Math.round(maxValData); els.valLow.innerText = Math.round(minValData); 
                    const maxIdx = fullHistory.lastIndexOf(maxValData); const minIdx = fullHistory.lastIndexOf(minValData); 
                    const maxPos = { x: 20 + maxIdx * xStep, y: h - ((maxValData - minVal) / range) * h }; 
                    const minPos = { x: 20 + minIdx * xStep, y: h - ((minValData - minVal) / range) * h }; 
                    const labelX_Max = Math.min(Math.max(maxPos.x, 30), w - 30); const labelX_Min = Math.min(Math.max(minPos.x, 30), w - 30); 
                    els.labelHigh.style.opacity = 1; els.labelHigh.style.left = `${labelX_Max}px`; els.labelHigh.style.top = `${maxPos.y - 25}px`; 
                    els.labelLow.style.opacity = 1; els.labelLow.style.left = `${labelX_Min}px`; els.labelLow.style.top = `${minPos.y + 10}px`; 
                    [maxPos, minPos].forEach(pos => { ctx.beginPath(); ctx.fillStyle = 'white'; ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.arc(pos.x, pos.y, 3, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); }); 
                } else { 
                    const candleWidth = xStep * 0.6; els.chartPulseDot.classList.add('hidden'); 
                    fullHistory.forEach((p, i) => { 
                        const prev = i > 0 ? fullHistory[i-1] : state.basePrice; const x = 20 + i * xStep; 
                        const yClose = h - ((p - minVal) / range) * h; const yOpen = h - ((prev - minVal) / range) * h; 
                        const isUp = p >= prev; const color = isUp ? '#f04452' : '#3182f6'; ctx.fillStyle = color; 
                        let bodyHeight = Math.abs(yClose - yOpen); if (bodyHeight < 1) bodyHeight = 1; const bodyY = Math.min(yOpen, yClose); 
                        ctx.fillRect(x - candleWidth/2, bodyY, candleWidth, bodyHeight); 
                        ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 1; 
                        const highY = Math.min(yOpen, yClose) - (Math.random() * 5); const lowY = Math.max(yOpen, yClose) + (Math.random() * 5); 
                        ctx.moveTo(x, highY); ctx.lineTo(x, lowY); ctx.stroke(); 
                    }); 
                } 
            }

            function updateUI() { 
                els.price.innerText = fmt(state.currentPrice); els.diffLabel.innerText = state.basePriceLabel; 
                const diff = state.currentPrice - state.basePrice; 
                const rate = ((diff / state.basePrice) * 100).toFixed(1); 
                const sign = diff > 0 ? '+' : ''; const isUp = diff >= 0; 
                els.diffVal.innerText = `${sign}${diff}ì›`; els.rate.innerText = `(${sign}${rate}%)`; 
                els.diffBox.className = `flex items-center gap-1 ${isUp ? 'text-up' : 'text-down'}`; 
                const isMarketOpen = checkMarketStatus(); 
                
                // ì¥ ìƒíƒœ í‘œì‹œ ë¡œì§ ìˆ˜ì •
                if (!isMarketOpen) { 
                    els.marketMsgContainer.classList.remove('hidden'); 
                    els.liveDot.classList.remove('animate-pulse'); 
                    els.liveDot.classList.replace('bg-[#3182f6]', 'bg-gray-400'); 
                    
                    if (state.manualPause) {
                        els.chartStatus.innerText = "ì¼ì‹œì •ì§€ë¨";
                        els.marketMsgBadge.innerText = "â¸ ì¥ ì¼ì‹œì •ì§€ë¨";
                    } else {
                        els.chartStatus.innerText = "ì¥ ì¢…ë£Œ";
                        els.marketMsgBadge.innerText = "ğŸŒ™ ì¥ ì¢…ë£Œ (08:00 ~ 23:30)";
                    }
                } else { 
                    els.marketMsgContainer.classList.add('hidden'); 
                    els.liveDot.classList.add('animate-pulse'); 
                    els.liveDot.classList.replace('bg-gray-400', 'bg-[#3182f6]'); 
                    els.chartStatus.innerText = "ì¥ ìš´ì˜ì¤‘ (08:00~23:30)"; 
                } 
                
                if (state.isAdmin && state.adminTrend && state.adminTrendUntil > Date.now()) { const timeLeft = Math.ceil((state.adminTrendUntil - Date.now()) / 1000); if (timeLeft > 0) { const mins = Math.floor(timeLeft / 60); const secs = timeLeft % 60; els.adminTimer.innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`; els.adminTimer.classList.remove('hidden'); } else els.adminTimer.classList.add('hidden'); } else els.adminTimer.classList.add('hidden'); 
                if(state.tab === 'chart') drawChart(); else if(state.tab === 'order') renderOrderBook(); 
                updateInvestorTrendUI();
            }

            function renderDailyQuotes() { 
                if (state.dailyHistory.length === 0) { els.dailyQuoteList.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">ê¸°ë¡ëœ ì‹œì„¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; } 
                els.dailyQuoteList.innerHTML = state.dailyHistory.map(item => { 
                    const isUp = item.diff > 0; const isZero = item.diff == 0; const colorClass = isUp ? 'text-up' : (isZero ? 'text-gray' : 'text-down'); const sign = isUp ? '+' : ''; 
                    return `<tr><td>${item.date}</td><td class="font-bold ${colorClass}">${fmt(item.close)}</td><td class="${colorClass}">${sign}${item.rate}%</td><td>${fmt(item.vol)}</td><td style="padding-right: 0;">${fmtAmt(item.amt)}</td></tr>`; 
                }).join(''); 
            }

            function renderHistory() { 
                const generateHTML = (logs) => {
                    if (logs.length === 0) return '<div class="text-center py-4 text-xs text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return logs.map(log => { 
                        const date = new Date(log.time); const timeStr = `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}:${String(date.getSeconds()).padStart(2,'0')}`; 
                        let tagClass = 'log-deposit'; let tagText = 'ì•Œë¦¼'; 
                        if (log.type === 'buy') { tagClass = 'log-buy'; tagText = 'ë§¤ìˆ˜'; } 
                        else if (log.type === 'sell') { tagClass = 'log-sell'; tagText = 'ë§¤ë„'; } 
                        else if (log.type === 'deposit') { tagClass = 'log-deposit'; tagText = 'ì…ê¸ˆ'; } 
                        return `<div class="log-item"><div class="flex items-center"><span class="log-time">${timeStr}</span><span class="log-tag ${tagClass}">${tagText}</span><span class="text-[#333]">${log.detail}</span></div></div>`; 
                    }).join('');
                };

                // Wallet Tab: Show all logs
                els.wHistoryList.innerHTML = generateHTML(state.tradeLogs);

                // Account Tab: Show only deposit logs
                const depositLogs = state.tradeLogs.filter(log => log.type === 'deposit');
                if (els.depositList) {
                    if (depositLogs.length === 0) els.depositList.innerHTML = '<div class="text-center py-4 text-xs text-gray-400">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    else els.depositList.innerHTML = generateHTML(depositLogs);
                }
                
                updateInvestorTrendUI(); // Re-calculate yield when history updates
            }

            function updateWalletUI() { 
                const txtCash = fmt(state.walletCash); const txtStocks = fmt(state.walletStocks); const txtAvg = fmt(Math.round(state.walletAvgPrice)); 
                let returnRate = 0; let plValue = 0; let plRateStr = "0%"; let plClass = "text-gray-400"; 
                if (state.walletStocks > 0 && state.walletAvgPrice > 0) { 
                    const currentVal = state.currentPrice * state.walletStocks; const principal = state.walletAvgPrice * state.walletStocks; plValue = currentVal - principal; returnRate = (plValue / principal) * 100; plRateStr = `${returnRate > 0 ? '+' : ''}${returnRate.toFixed(1)}%`; plClass = returnRate >= 0 ? 'text-[#f04452]' : 'text-[#3182f6]'; 
                } 
                els.myCash.innerText = txtCash; els.myStockCnt.innerText = txtStocks; els.myAvgPrice.innerText = txtAvg; els.myReturnRate.innerText = plRateStr; els.myReturnRate.className = `text-xs font-bold ${plClass}`; 
                els.wAvgPriceBig.innerText = txtAvg; els.wStockQty.innerText = txtStocks; 
                const totalStockVal = state.walletStocks * state.currentPrice; els.wTotalVal.innerText = fmt(totalStockVal); 
                const plSign = plValue > 0 ? '+' : ''; els.wPlInfo.innerHTML = `<span class="${plClass}">${plSign}${fmt(plValue)} (${plRateStr})</span>`; 
                const principalVal = Math.round(state.walletAvgPrice * state.walletStocks); els.wPrincipal.innerText = fmt(principalVal); els.wCashRow.innerText = txtCash; 
                renderPendingOrders(); 
                updateInvestorTrendUI(); // Re-calculate yield when wallet updates
            }

            function renderPendingOrders() { 
                els.pendingCount.innerText = state.pendingOrders.length; 
                if (state.pendingOrders.length === 0) { els.pendingList.innerHTML = '<div class="text-center py-4 text-xs text-gray-400">ë¯¸ì²´ê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } 
                els.pendingList.innerHTML = state.pendingOrders.map(order => { 
                    const typeText = order.type === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'; const typeClass = order.type === 'buy' ? 'text-[#f04452]' : 'text-[#3182f6]'; const itemBg = order.type === 'buy' ? 'bg-[#fff4f4]' : 'bg-[#f4f9ff]'; 
                    return `<div class="flex justify-between items-center p-3 rounded-xl ${itemBg}"><div class="flex items-center gap-2"><span class="font-bold text-xs ${typeClass}">${typeText}</span><span class="font-bold text-sm text-[#333]">${fmt(order.price)}ì›</span><span class="text-xs text-gray-500">${order.qty}ì£¼</span></div><button class="text-xs text-gray-400 underline p-1" onclick="window.cancelOrder('${order.id}')">ì·¨ì†Œ</button></div>`; 
                }).join(''); 
            }

            async function cancelOrder(orderId) { 
                const walletDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'shared_wallet'); 
                await window.runTransaction(window.db, async (transaction) => { 
                    const doc = await transaction.get(walletDocRef); if (!doc.exists()) return; const data = doc.data(); const pending = data.pendingOrders || []; const orderIndex = pending.findIndex(o => o.id === orderId); if (orderIndex === -1) return; const order = pending[orderIndex]; let newCash = data.cash || 0; let newStocks = data.stocks || 0; if (order.type === 'buy') { newCash += (order.price * order.qty); } else { newStocks += order.qty; } pending.splice(orderIndex, 1); transaction.update(walletDocRef, { cash: newCash, stocks: newStocks, pendingOrders: pending }); 
                }); 
                showToast("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); 
            };

            function updateMoodUI() { 
                els.marketMoodBadge.classList.remove('hidden', 'bg-red-100', 'text-red-600', 'bg-blue-100', 'text-blue-600', 'bg-gray-100', 'text-gray-600'); 
                if (state.marketMood === 'bull') { els.marketMoodBadge.innerText = "í˜¸ì¬"; els.marketMoodBadge.classList.add('bg-red-100', 'text-red-600'); } 
                else if (state.marketMood === 'bear') { els.marketMoodBadge.innerText = "ì•…ì¬"; els.marketMoodBadge.classList.add('bg-blue-100', 'text-blue-600'); } 
                else { els.marketMoodBadge.innerText = "í‰ë²”"; els.marketMoodBadge.classList.add('bg-gray-100', 'text-gray-600'); } 
            }

            function updateInvestorTrendUI() {
                const inv = state.investor;
                const updateRow = (prefix, val) => {
                    const absVal = Math.abs(val);
                    let valStr = absVal === 0 ? "0" : fmt(absVal);
                    if (absVal >= 10000) valStr = (absVal / 10000).toFixed(0) + "ë§Œ";
                    if (val < 0) valStr = "-" + valStr;
                    
                    const elVal = document.getElementById(`${prefix}-val`);
                    const elBar = document.getElementById(`${prefix}-bar`);
                    
                    if (elVal) {
                        elVal.innerText = valStr;
                        elVal.className = `text-right w-16 font-bold tabular-nums tracking-tight ${val > 0 ? 'text-[#f04452]' : (val < 0 ? 'text-[#3182f6]' : 'text-[#191f28]')}`;
                    }
                    if (elBar) {
                        const max = Math.max(Math.abs(inv.individual), Math.abs(inv.foreigner), Math.abs(inv.institution), 1);
                        const width = (Math.abs(val) / max) * 100;
                        elBar.style.width = `${width}%`;
                        elBar.className = `trend-bar-fill ${val > 0 ? 'bg-[#f04452]' : (val < 0 ? 'bg-[#3182f6]' : 'bg-[#d1d6db]')}`;
                    }
                };

                updateRow('it-chart-ind', inv.individual);
                updateRow('it-chart-for', inv.foreigner);
                updateRow('it-chart-ins', inv.institution);
                
                updateRow('it-info-ind', inv.individual);
                updateRow('it-info-for', inv.foreigner);
                updateRow('it-info-ins', inv.institution);

                // --- íˆ¬ì ì§€í‘œ ì—…ë°ì´íŠ¸ ë¡œì§ (ë™ì  ê³„ì‚°) ---
                if (els.infoMarketCap) {
                    // ì‹œê°€ì´ì•¡: í˜„ì¬ê°€ * 1,000ì£¼ ê°€ì • (ë°±ë§Œì› ë‹¨ìœ„)
                    const marketCap = state.currentPrice * 1000;
                    els.infoMarketCap.innerText = fmtAmt(marketCap) + "ì›";

                    // ë°°ë‹¹ìˆ˜ìµë¥ : (ì´ ì…ê¸ˆì•¡ / ë³´ìœ ì£¼ì‹ìˆ˜) / í˜„ì¬ê°€ * 100
                    let yieldStr = "0.00%";
                    let dpsVal = 0;
                    const depositLogs = state.tradeLogs.filter(l => l.type === 'deposit');
                    
                    if (state.walletStocks > 0) {
                        const totalDeposit = depositLogs.reduce((sum, log) => {
                            const match = log.detail.match(/([\d,]+)ì›/);
                            if (match) return sum + parseInt(match[1].replace(/,/g, ''));
                            return sum;
                        }, 0);
                        dpsVal = Math.floor(totalDeposit / state.walletStocks); // ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ(ê°€ì •)
                        if (state.currentPrice > 0) {
                            const yieldVal = (dpsVal / state.currentPrice) * 100;
                            yieldStr = yieldVal.toFixed(2) + "%";
                        }
                    } else {
                        // ë³´ìœ  ì£¼ì‹ì´ ì—†ìœ¼ë©´ ë°°ë‹¹ìˆ˜ìµë¥  0 ì´ˆê¸°í™”
                        dpsVal = 0;
                        yieldStr = "0.00%";
                    }
                    els.infoDividendYield.innerText = yieldStr;

                    // PBR, PER, ROE, PSR, ì™¸êµ­ì¸ì†Œì§„ìœ¨ (í˜„ì¬ê°€ ê¸°ë°˜ ê°€ìƒ ê³„ì‚°)
                    const per = (state.currentPrice / 100).toFixed(1);
                    const pbr = (state.currentPrice / 1000).toFixed(1);
                    const psr = (state.currentPrice / 300).toFixed(1);
                    // ì™¸êµ­ì¸ì†Œì§„ìœ¨: ê¸°ë³¸ 30% + íŠ¸ë Œë“œ ë°˜ì˜
                    const foreignRate = (30 + (state.investor.foreigner / 10000)).toFixed(2);
                    
                    els.infoPer.innerText = per + "ë°°";
                    els.infoPbr.innerText = pbr + "ë°°";
                    els.infoPsr.innerText = psr + "ë°°";
                    els.infoRoe.innerText = "15.5%"; // ê³ ì •ê°’
                    els.infoForeign.innerText = foreignRate + "%";

                    // --- ë°°ë‹¹ ì†Œì‹ ì—…ë°ì´íŠ¸ ---
                    if(els.infoDivCount) {
                        els.infoDivCount.innerText = depositLogs.length;
                        
                        // Extract unique months
                        const months = [...new Set(depositLogs.map(l => new Date(l.time).getMonth() + 1))].sort((a,b) => a-b);
                        els.infoDivMonths.innerText = months.length > 0 ? months.map(m => `${m}ì›”`).join(', ') : '-';
                        
                        // Per share
                        els.infoDivPerShare.innerText = "ì—° " + fmt(dpsVal);
                        
                        // Yield (reuse yieldStr)
                        els.infoDivYield2.innerText = "ì—° " + yieldStr;
                    }

                    // --- ì£¼ê°€ ì •ë³´ ì—…ë°ì´íŠ¸ ---
                    if (els.infoDayLow && state.history.length > 0) {
                        const dayLow = Math.min(...state.history);
                        const dayHigh = Math.max(...state.history);
                        
                        els.infoDayLow.innerText = fmt(dayLow) + "ì›";
                        els.infoDayHigh.innerText = fmt(dayHigh) + "ì›";

                        // Calculate day bar dot position
                        let dayPercent = 0;
                        if (dayHigh > dayLow) {
                            dayPercent = ((state.currentPrice - dayLow) / (dayHigh - dayLow)) * 100;
                        } else {
                            dayPercent = 50; // If high == low
                        }
                        dayPercent = Math.max(0, Math.min(100, dayPercent));
                        els.priceBarDayDot.style.left = `${dayPercent}%`;

                        // Year Range: Low = 1, High = dayHigh (User Request)
                        const yearLow = 1;
                        const yearHigh = dayHigh; 
                        
                        if (els.infoYearHigh) els.infoYearHigh.innerText = fmt(yearHigh) + "ì›";

                        let yearPercent = 0;
                        if (yearHigh > yearLow) {
                            yearPercent = ((state.currentPrice - yearLow) / (yearHigh - yearLow)) * 100;
                        } else {
                            yearPercent = 100; // If yearHigh == 1
                        }
                        yearPercent = Math.max(0, Math.min(100, yearPercent));
                        els.priceBarYearDot.style.left = `${yearPercent}%`;
                    }
                }
            }

            function renderOrderBook() { 
                if(state.tab !== 'order') return; const asks = []; const bids = []; const gap = Math.max(1, Math.floor(state.currentPrice * 0.005)); 
                for(let i=5; i>=1; i--) { asks.push({ price: state.currentPrice + i * gap, vol: Math.floor(Math.random() * 50) + 1 }); } 
                for(let i=1; i<=5; i++) { bids.push({ price: state.currentPrice - i * gap, vol: Math.floor(Math.random() * 50) + 1 }); } 
                let html = ''; 
                asks.forEach(item => { html += `<div class="order-row bg-ask"><div class="order-cell cell-ask-vol text-ask">${item.vol}</div><div class="order-cell cell-price text-ask">${fmt(item.price)}</div><div class="order-cell cell-bid-vol"></div><div class="vol-bar vol-bar-ask" style="width:${Math.min(item.vol*2, 100)}%"></div></div>`; }); 
                bids.forEach(item => { html += `<div class="order-row bg-bid"><div class="order-cell cell-ask-vol"></div><div class="order-cell cell-price text-bid">${fmt(item.price)}</div><div class="order-cell cell-bid-vol text-bid">${item.vol}</div><div class="vol-bar vol-bar-bid" style="width:${Math.min(item.vol*2, 100)}%"></div></div>`; }); 
                els.orderList.innerHTML = html; 
            }

            // [ì¶”ê°€ë¨] ê´€ë¦¬ì ë° ëª¨ë‹¬ ê´€ë ¨ ëˆ„ë½ëœ í•¨ìˆ˜ ë³µêµ¬
            async function setMarketStatus(isPaused) {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'enjoy_ticker');
                try {
                    const updateData = { manualPause: isPaused };
                    // [ìˆ˜ì •] ì¥ ì¬ê°œ ì‹œ, ì¬ê°œ ì‹œê°„ì„ ê¸°ë¡í•˜ì—¬ í•˜ë£¨ ë™ì•ˆ íŒì—…ì´ ìœ ì§€ë˜ë„ë¡ í•¨
                    if (!isPaused) {
                        updateData.lastResumeTime = Date.now();
                    }
                    await window.updateDoc(docRef, updateData);
                    
                    // ê´€ë¦¬ìê°€ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì¦‰ì‹œ ë°˜ì‘í•˜ë„ë¡ í•¨ (DB ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬í•˜ì§€ë§Œ í”¼ë“œë°±ì„ ìœ„í•´)
                    if (isPaused) showToast("â¸ ì¥ì„ ì¼ì‹œì •ì§€í–ˆìŠµë‹ˆë‹¤.");
                    else showToast("ğŸ”” ì¥ì„ ì¬ê°œí–ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    console.error(e);
                    showToast("ì„¤ì • ë³€ê²½ ì‹¤íŒ¨");
                }
            }

            async function setAdminTrend(trend) {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'enjoy_ticker');
                try {
                    await window.updateDoc(docRef, {
                        adminTrend: trend,
                        adminTrendUntil: Date.now() + 30000 // 30ì´ˆ ìœ ì§€
                    });
                    showToast(trend === 'up' ? "ğŸ“ˆ 30ì´ˆ ìƒìŠ¹ ëª¨ë“œ ì‹¤í–‰" : "ğŸ“‰ 30ì´ˆ í•˜ë½ ëª¨ë“œ ì‹¤í–‰");
                } catch (e) { console.error(e); showToast("ëª…ë ¹ ì‹¤íŒ¨"); }
            }

            async function triggerSharpMove(type) {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'enjoy_ticker');
                try {
                    const snap = await window.getDoc(docRef);
                    if (!snap.exists()) return;
                    const current = snap.data().currentPrice;
                    const factor = 0.15 + (Math.random() * 0.05); // 15~20% ë³€ë™
                    let change = Math.floor(current * factor);
                    if (type === 'crash') change = -change;
                    
                    let next = current + change;
                    if (next < 1) next = 1;
                    
                    const history = snap.data().history || [];
                    history.push(next);
                    
                    await window.updateDoc(docRef, {
                        currentPrice: next,
                        history: history,
                        lastUpdated: Date.now(),
                        todayVolume: (snap.data().todayVolume || 0) + 10000,
                        todayTradeAmount: (snap.data().todayTradeAmount || 0) + (10000 * next)
                    });
                    showToast(type === 'surge' ? "ğŸš€ ê¸‰ë“± ì‹¤í–‰!" : "ğŸ“‰ ê¸‰ë½ ì‹¤í–‰!");
                } catch(e) { console.error(e); showToast("ì‹¤í–‰ ì‹¤íŒ¨"); }
            }

            function openTradeModal(type) {
                // ì¥ ë§ˆê° ì²´í¬ (ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ê±°ë˜ ë¶ˆê°€)
                if (!checkMarketStatus() && !state.isAdmin) {
                    showToast("ì§€ê¸ˆì€ ê±°ë˜ ê°€ëŠ¥ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
                    return;
                }
                const isBuy = type === 'buy';
                els.tradeTitle.innerText = isBuy ? 'ë§¤ìˆ˜í•˜ê¸°' : 'ë§¤ë„í•˜ê¸°';
                els.tradeTitle.style.color = isBuy ? '#f04452' : '#3182f6';
                els.btnTradeConfirm.style.backgroundColor = isBuy ? '#f04452' : '#3182f6';
                els.btnTradeConfirm.innerText = isBuy ? 'ë§¤ìˆ˜ ì£¼ë¬¸' : 'ë§¤ë„ ì£¼ë¬¸';
                els.inputPrice.value = state.currentPrice;
                els.inputQty.value = 1;
                updateTradeTotal();
                
                // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¬ì„¤ì • (í´ë¡œì € ë³€ìˆ˜ type ì‚¬ìš©ì„ ìœ„í•´)
                els.btnTradeConfirm.onclick = () => executeTrade(type);
                
                els.tradeModal.classList.remove('hidden');
                els.tradeModal.classList.add('flex');
            }

            function updateTradeTotal() {
                const p = parseInt(els.inputPrice.value) || 0;
                const q = parseInt(els.inputQty.value) || 0;
                els.tradeTotalAmount.innerText = fmt(p * q);
            }

            // ìˆ˜ëŸ‰/ê°€ê²© ì¡°ì ˆ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            els.btnPriceUp.onclick = () => { els.inputPrice.value = parseInt(els.inputPrice.value) + 10; updateTradeTotal(); };
            els.btnPriceDown.onclick = () => { els.inputPrice.value = Math.max(0, parseInt(els.inputPrice.value) - 10); updateTradeTotal(); };
            els.btnQtyUp.onclick = () => { els.inputQty.value = parseInt(els.inputQty.value) + 1; updateTradeTotal(); };
            els.btnQtyDown.onclick = () => { els.inputQty.value = Math.max(1, parseInt(els.inputQty.value) - 1); updateTradeTotal(); };
            els.inputPrice.oninput = updateTradeTotal;
            els.inputQty.oninput = updateTradeTotal;
            els.btnTradeClose.onclick = () => { els.tradeModal.classList.add('hidden'); els.tradeModal.classList.remove('flex'); };

            async function executeTrade(type) {
                const price = parseInt(els.inputPrice.value);
                const qty = parseInt(els.inputQty.value);
                if (price <= 0 || qty <= 0) { showToast("ê°€ê²©ê³¼ ìˆ˜ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”."); return; }

                // ë¡œì§: ì˜ˆì•½ ì£¼ë¬¸ìœ¼ë¡œ ì²˜ë¦¬ (ì‹¤ì‹œê°„ ì²´ê²° ì•„ë‹˜)
                const walletDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'shared_wallet');
                const newOrder = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    type: type,
                    price: price,
                    qty: qty,
                    time: Date.now()
                };

                try {
                    await window.runTransaction(window.db, async (transaction) => {
                        const doc = await transaction.get(walletDocRef);
                        if (!doc.exists()) throw "Wallet not found";
                        const data = doc.data();
                        const pending = data.pendingOrders || [];
                        pending.push(newOrder);
                        transaction.update(walletDocRef, { pendingOrders: pending });
                    });
                    
                    showToast("ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤ (ëŒ€ê¸°ì¤‘)");
                    els.tradeModal.classList.add('hidden');
                    // ì¦‰ì‹œ ì²´ê²° ì‹œë„ (ê°€ê²© ì¡°ê±´ ë§ì„ ê²½ìš°)
                    checkPendingOrders(state.currentPrice);
                } catch (e) {
                    console.error(e);
                    showToast("ì£¼ë¬¸ ì‹¤íŒ¨");
                }
            }

            // ---- MISSING FUNCTION RESTORED & IMPROVED ----
            function checkPendingOrders(currentPrice) {
                // Ensure checkPendingOrders only executes when market is OPEN
                if (!checkMarketStatus()) return;

                if (state.pendingOrders.length === 0) return;
                const executable = state.pendingOrders.filter(o => (o.type === 'buy' && currentPrice <= o.price) || (o.type === 'sell' && currentPrice >= o.price));
                if (executable.length === 0) return;
                const walletDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'shared_wallet');
                window.runTransaction(window.db, async (transaction) => {
                    const doc = await transaction.get(walletDocRef);
                    if (!doc.exists()) return;
                    const data = doc.data();
                    let cash = data.cash || 0;
                    let stocks = data.stocks || 0;
                    let avgPrice = data.avgPrice || 0;
                    let pending = data.pendingOrders || [];
                    const toExecute = [];
                    const remaining = [];
                    
                    pending.forEach(o => {
                        // Check execution condition again inside transaction
                        if ((o.type === 'buy' && state.currentPrice <= o.price) || (o.type === 'sell' && state.currentPrice >= o.price)) {
                            toExecute.push(o);
                        } else {
                            remaining.push(o);
                        }
                    });

                    if (toExecute.length === 0) return;

                    toExecute.forEach(o => {
                        if (o.type === 'buy') {
                            const totalValue = (stocks * avgPrice) + (o.price * o.qty);
                            stocks += o.qty;
                            avgPrice = totalValue / stocks;
                            addHistoryLog('buy', `ì˜ˆì•½ ë§¤ìˆ˜ ì²´ê²°: ${o.qty}ì£¼ (${fmt(o.price)}ì›)`);
                        } else {
                            cash += (o.price * o.qty);
                            if(stocks === 0) avgPrice = 0;
                            addHistoryLog('sell', `ì˜ˆì•½ ë§¤ë„ ì²´ê²°: ${o.qty}ì£¼ (${fmt(o.price)}ì›)`);
                        }
                    });

                    transaction.update(walletDocRef, { cash, stocks, avgPrice, pendingOrders: remaining });
                });
            }

            function startSync() {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'enjoy_ticker');
                window.onSnapshot(docRef, async (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        const currentPauseState = data.manualPause || false;
                        
                        // ğŸ”¹ [Notice Popup Logic - Modified]
                        // í˜„ì¬ ì‹œê°„ì´ ì¥ ìš´ì˜ ì‹œê°„ì¸ì§€ í™•ì¸ (08:00 ~ 23:30)
                        // [ìˆ˜ì •] ë³€ìˆ˜ëª… ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ snapshotTimeìœ¼ë¡œ ë³€ê²½í•˜ê³  ë‚´ë¶€ì—ì„œ ê³„ì‚°
                        const snapshotTime = new Date();
                        const t = snapshotTime.getHours() * 60 + snapshotTime.getMinutes();
                        const isMarketTime = t >= (8*60) && t < (23*60 + 30);

                        if (state.prevManualPause !== null) {
                            if (!state.prevManualPause && currentPauseState) {
                                // [ê´€ë¦¬ì] ì •ì§€ë¡œ ë³€ê²½ë¨ -> ì •ì§€ íŒì—…
                                document.getElementById('paused-startup-modal').classList.remove('hidden');
                            } else if (state.prevManualPause && !currentPauseState) {
                                // [ê´€ë¦¬ì] ì¬ê°œë¡œ ë³€ê²½ë¨ -> ì¬ê°œ íŒì—…
                                if (isMarketTime) {
                                    document.getElementById('resumed-startup-modal').classList.remove('hidden');
                                }
                            }
                        }
                        
                        // ğŸ”¹ [Initial Load Check for Paused State]
                        if (state.isFirstLoad && currentPauseState) {
                            document.getElementById('paused-startup-modal').classList.remove('hidden');
                        }

                        // ğŸ”¹ [ì¥ ì¬ê°œ ì•Œë¦¼ ë¡œì§]
                        const serverResumeTime = data.lastResumeTime || 0;
                        if (!currentPauseState && serverResumeTime > 0) {
                            const startOfToday = new Date(snapshotTime.getFullYear(), snapshotTime.getMonth(), snapshotTime.getDate()).getTime();
                            const isTodayResume = serverResumeTime > startOfToday;

                            if (isTodayResume && serverResumeTime > state.lastProcessedResumeTime) {
                                if (isMarketTime) {
                                    document.getElementById('resumed-startup-modal').classList.remove('hidden');
                                    state.lastProcessedResumeTime = serverResumeTime;
                                }
                            }
                        }

                        state.isFirstLoad = false;
                        state.prevManualPause = currentPauseState;
                        
                        // ğŸ”¹ [Smart Recovery System]
                        const dailyRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'daily_history');
                        let lastClose = 1885; 
                        
                        try {
                            const dailySnap = await window.getDoc(dailyRef);
                            if (dailySnap.exists() && dailySnap.data().history?.length > 0) {
                                lastClose = dailySnap.data().history[0].close;
                            }
                        } catch(e) { console.warn("Failed to fetch daily history"); }

                        if (data.basePrice === 1271 && lastClose !== 1271) {
                            console.log(`Auto-fixing base price: 1271 -> ${lastClose}`);
                            await window.updateDoc(docRef, { basePrice: lastClose, basePriceLabel: "ì–´ì œë³´ë‹¤", lastUpdated: Date.now() });
                        }

                        const marketStart = new Date();
                        marketStart.setHours(MARKET_START_HOUR, MARKET_START_MIN, 0, 0);
                        const lastDate = new Date(data.lastUpdated || 0);

                        let needReset = false;
                        if (lastDate.getTime() < marketStart.getTime() && snapshotTime.getTime() >= marketStart.getTime()) {
                             needReset = true;
                        }

                        if (needReset) {
                            const prevClose = lastClose || 1885;
                            state.basePrice = prevClose;
                            state.currentPrice = prevClose;
                            state.history = [prevClose];
                            state.lastUpdated = marketStart.getTime();
                            state.todayVolume = 0;
                            state.todayTradeAmount = 0;
                            state.investor = { individual: 0, foreigner: 0, institution: 0 };
                            
                            try {
                                await window.updateDoc(docRef, {
                                    basePrice: prevClose,
                                    basePriceLabel: "ì–´ì œë³´ë‹¤",
                                    history: [prevClose],
                                    lastUpdated: marketStart.getTime(),
                                    todayVolume: 0,
                                    todayTradeAmount: 0,
                                    currentPrice: prevClose,
                                    investor: state.investor
                                });
                            } catch(e) {}
                        } else {
                            state.currentPrice = data.currentPrice;
                            state.history = data.history || [];
                            state.lastUpdated = data.lastUpdated;
                            state.basePrice = data.basePrice;
                            state.todayVolume = data.todayVolume;
                            state.todayTradeAmount = data.todayTradeAmount;
                            state.investor = data.investor || { individual: 0, foreigner: 0, institution: 0 };
                        }

                        state.manualPause = currentPauseState;

                        if (!state.manualPause) {
                            // [ìˆ˜ì •] ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•´ simulateMissingDataë¥¼ ì•ˆì „í•˜ê²Œ í˜¸ì¶œ
                            if (!state.isUpdating) {
                                await simulateMissingData(docRef);
                            }
                        }

                        state.adminTrend = data.adminTrend || null; 
                        state.adminTrendUntil = data.adminTrendUntil || 0; 
                        
                        state.basePriceLabel = data.basePriceLabel || "ì‹œì‘ê°€ë³´ë‹¤";
                        state.marketMood = data.marketMood || 'neutral'; 
                        state.nextMoodChange = data.nextMoodChange || 0;

                        state.isConnected = true; 
                        els.syncStatus.classList.remove('bg-gray-300', 'bg-red-500'); 
                        els.syncStatus.classList.add('bg-green-500');
                        
                        updateUI(); drawChart(); updateWalletUI(); updateMoodUI(); 
                        checkPendingOrders(state.currentPrice);
                    } else initializeData(docRef);
                });
                
                setInterval(async () => {
                    if (!state.isConnected) return; 
                    const isMarketOpen = checkMarketStatus();
                    const now = new Date();
                    const currentTimeVal = now.getHours() * 60 + now.getMinutes();

                    if (currentTimeVal >= (MARKET_END_HOUR * 60 + MARKET_END_MIN)) {
                        const todayStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
                        const lastRecord = state.dailyHistory.length > 0 ? state.dailyHistory[0] : null;
                        if (!lastRecord || lastRecord.date !== todayStr) {
                            await recordDailyHistory(now, state.currentPrice, state.basePrice, state.todayVolume, state.todayTradeAmount);
                        }
                    }

                    if (isMarketOpen) {
                        // [ìˆ˜ì •] ì£¼ê°€ ìƒì„± ë¡œì§ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                        if (!state.isUpdating && Date.now() - state.lastUpdated > 600000) {
                            await generateNextTick(docRef);
                        }
                    }
                }, 1000);
                setInterval(() => { if (state.isAdmin) updateUI(); }, 500);
            }

            async function simulateMissingData(docRef) {
                if (state.manualPause || state.isUpdating) return;

                const now = new Date();
                const marketStart = new Date(now);
                marketStart.setHours(MARKET_START_HOUR, MARKET_START_MIN, 0, 0);
                const marketEnd = new Date(now);
                marketEnd.setHours(MARKET_END_HOUR, MARKET_END_MIN, 0, 0);

                if (now.getTime() < marketStart.getTime()) return;

                const timeCap = Math.min(now.getTime(), marketEnd.getTime());
                const diffMs = timeCap - marketStart.getTime();
                const expectedCount = Math.floor(diffMs / 600000) + 1;
                
                // ë¡œì»¬ ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ ë¨¼ì € ì²´í¬í•˜ì—¬ ë¶ˆí•„ìš”í•œ íŠ¸ëœì­ì…˜ ë°©ì§€
                if (state.history.length >= expectedCount) return;

                state.isUpdating = true; // ë½ ê±¸ê¸°

                try {
                    await window.runTransaction(window.db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) return;
                        
                        const data = sfDoc.data();
                        const currentHistory = data.history || [];
                        const currentPrice = data.currentPrice;
                        
                        // DB ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ë‹¤ì‹œ ì²´í¬ (Race Condition ë°©ì§€)
                        if (currentHistory.length >= expectedCount) return;

                        const missingTicks = expectedCount - currentHistory.length;
                        let simVol = data.todayVolume || 0;
                        let simAmt = data.todayTradeAmount || 0;
                        let simPrice = currentPrice;
                        let simHistory = [...currentHistory];
                        let simInvestor = data.investor || { individual: 0, foreigner: 0, institution: 0 };

                        for (let i = 0; i < missingTicks; i++) {
                            const change = calculatePriceChange(simPrice);
                            simPrice += change;
                            if (simPrice < 1) simPrice = 1;
                            simHistory.push(simPrice);
                            
                            const v = Math.floor(Math.random() * 2000) + 500;
                            simVol += v;
                            simAmt += (v * simPrice);
                            
                            simInvestor.individual += Math.floor(Math.random() * 200) - 100;
                            simInvestor.foreigner += Math.floor(Math.random() * 200) - 100;
                            simInvestor.institution += Math.floor(Math.random() * 200) - 100;
                        }

                        transaction.update(docRef, {
                            currentPrice: simPrice,
                            history: simHistory,
                            lastUpdated: marketStart.getTime() + ((simHistory.length - 1) * 600000), // ì‹œê°„ ë³´ì •
                            todayVolume: simVol,
                            todayTradeAmount: simAmt,
                            investor: simInvestor
                        });
                    });
                } catch (e) {
                    console.log("Simulate update skip/fail", e);
                } finally {
                    state.isUpdating = false; // ë½ í•´ì œ
                }
            }

            async function generateNextTick(docRef) {
                if (state.isUpdating) return;
                state.isUpdating = true; // ë½ ê±¸ê¸°

                try {
                    await window.runTransaction(window.db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        if (!sfDoc.exists()) return;

                        const data = sfDoc.data();
                        // íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì‹œê°„ ë‹¤ì‹œ í™•ì¸ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í•µì‹¬)
                        if (Date.now() - data.lastUpdated < 600000) return;

                        let currentPrice = data.currentPrice;
                        let change = calculatePriceChange(currentPrice);
                        let nextPrice = currentPrice + change; 
                        if(nextPrice < 1) nextPrice = 1; 
                        
                        const simVol = Math.floor(Math.random() * 2000) + 500;
                        const newVolume = (data.todayVolume || 0) + simVol; 
                        const newTradeAmt = (data.todayTradeAmount || 0) + (simVol * nextPrice); 
                        
                        const newHistory = [...(data.history || []), nextPrice]; 
                        
                        let currentMood = data.marketMood || 'neutral'; 
                        let nextChange = data.nextMoodChange || 0;
                        if (Date.now() > nextChange) { 
                            const candidates = ['bull', 'bear', 'neutral'].filter(m => m !== currentMood); 
                            currentMood = candidates[Math.floor(Math.random() * candidates.length)]; 
                            nextChange = Date.now() + (30 * 60 * 1000); 
                        }

                        let newTrend = data.adminTrend || null; 
                        let newTrendUntil = data.adminTrendUntil || 0; 
                        if (data.adminTrend && Date.now() > data.adminTrendUntil) { newTrend = null; }

                        const newInvestor = data.investor || { individual: 0, foreigner: 0, institution: 0 };
                        newInvestor.individual += Math.floor(Math.random() * 200) - 100;
                        newInvestor.foreigner += Math.floor(Math.random() * 200) - 100;
                        newInvestor.institution += Math.floor(Math.random() * 200) - 100;

                        transaction.update(docRef, { 
                            currentPrice: nextPrice, 
                            history: newHistory, 
                            lastUpdated: Date.now(), 
                            adminTrend: newTrend, 
                            adminTrendUntil: newTrendUntil, 
                            marketMood: currentMood, 
                            nextMoodChange: nextChange, 
                            todayVolume: newVolume, 
                            todayTradeAmount: newTradeAmt,
                            investor: newInvestor
                        }); 
                    });
                } catch (e) {
                    console.error("Tick gen failed", e);
                } finally {
                    state.isUpdating = false; // ë½ í•´ì œ
                }
            }

            async function initializeData(docRef) { 
                try { 
                    await window.setDoc(docRef, { 
                        currentPrice: 1885, history: [1885], lastUpdated: Date.now(), // Fixed initial value to 1885
                        adminTrend: null, adminTrendUntil: 0, manualPause: false, 
                        basePrice: 1885, basePriceLabel: "ì–´ì œë³´ë‹¤", marketMood: 'neutral', 
                        nextMoodChange: Date.now() + 300000, todayVolume: 0, todayTradeAmount: 0,
                        investor: { individual: 0, foreigner: 0, institution: 0 }
                    }); 
                } catch(e) {} 
            }
            
            // ğŸ”¹ 12ì›” 3ì¼ ë°ì´í„° ê°•ì œ ë³µêµ¬ ë¡œì§ (1271ì›)
            function startDailyHistorySync() { 
                const dailyRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'daily_history'); 
                window.onSnapshot(dailyRef, async (snapshot) => { 
                    if (snapshot.exists()) { 
                        let history = snapshot.data().history || [];
                        let needUpdate = false;
                        
                        // ğŸš¨ 12.03 ëˆ„ë½ ë°ì´í„° ê°•ì œ ì£¼ì…
                        if (!history.some(h => h.date === '2025.12.03')) {
                            history.push({
                                date: '2025.12.03',
                                close: 1271, 
                                diff: 29,    
                                rate: "2.33", 
                                vol: 12050,  
                                amt: 15315550 
                            });
                            needUpdate = true;
                        }

                        // ğŸš¨ 12.05 ë°ì´í„° ê°•ì œ ìˆ˜ì • (Fix logic)
                        const idx1205 = history.findIndex(h => h.date === '2025.12.05');
                        const correct1205 = {
                            date: '2025.12.05',
                            close: 1885, 
                            diff: 614,    
                            rate: "48.31", 
                            vol: 245000,  // Increased volume for realism
                            amt: 461825000 // 245000 * 1885
                        };

                        if (idx1205 !== -1) {
                            // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ê°’ í™•ì¸ í›„ ìˆ˜ì • (íŠ¹íˆ ê±°ë˜ëŸ‰ì´ ì‘ìœ¼ë©´ ìˆ˜ì •)
                            if (history[idx1205].close !== 1885 || history[idx1205].vol < 100000) {
                                history[idx1205] = correct1205;
                                needUpdate = true;
                            }
                        } else {
                            // ì—†ìœ¼ë©´ ì¶”ê°€
                            history.push(correct1205);
                            needUpdate = true;
                        }

                        if (needUpdate) {
                            history.sort((a,b) => new Date(b.date) - new Date(a.date));
                            await window.updateDoc(dailyRef, { history: history });
                        }

                        state.dailyHistory = history; 
                        renderDailyQuotes(); 
                    } else { 
                        window.setDoc(dailyRef, { history: [] }); 
                    } 
                }); 
            }

            function startWalletSync() { const walletDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'shared_wallet'); window.onSnapshot(walletDocRef, (snapshot) => { if (snapshot.exists()) { const data = snapshot.data(); state.walletCash = data.cash || 0; state.walletStocks = data.stocks || 0; state.walletAvgPrice = data.avgPrice || 0; state.pendingOrders = data.pendingOrders || []; updateWalletUI(); } else { window.setDoc(walletDocRef, { cash: 0, stocks: 0, avgPrice: 0, pendingOrders: [] }); } }); }
            function startHistorySync() { const histDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'trade_history'); window.onSnapshot(histDocRef, (snapshot) => { if (snapshot.exists()) { state.tradeLogs = snapshot.data().logs || []; renderHistory(); } else { window.setDoc(histDocRef, { logs: [] }); } }); }
            async function addHistoryLog(type, detail) { const histDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'trade_history'); const newLog = { type, detail, time: Date.now() }; const currentLogs = state.tradeLogs; const updatedLogs = [newLog, ...currentLogs].slice(0, 30); await window.updateDoc(histDocRef, { logs: updatedLogs }); }
            
            // [ë³µêµ¬ë¨] ì¼ë³„ ì‹œì„¸ ê¸°ë¡ í•¨ìˆ˜ (ëˆ„ë½ë˜ì–´ ìˆì–´ ê¸°ë¡ì´ ì•ˆ ë˜ë˜ ë¬¸ì œ ìˆ˜ì •)
            async function recordDailyHistory(dateObj, closePrice, basePrice, volume, amount) {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'daily_history');
                const todayStr = `${dateObj.getFullYear()}.${String(dateObj.getMonth()+1).padStart(2,'0')}.${String(dateObj.getDate()).padStart(2,'0')}`;
                
                try {
                    await window.runTransaction(window.db, async (transaction) => {
                        const sfDoc = await transaction.get(docRef);
                        let history = [];
                        if (sfDoc.exists()) {
                            history = sfDoc.data().history || [];
                        }

                        // ì´ë¯¸ ì˜¤ëŠ˜ ë‚ ì§œê°€ ê¸°ë¡ë˜ì–´ ìˆìœ¼ë©´ ì¤‘ë³µ ì €ì¥ ë°©ì§€
                        if (history.length > 0 && history[0].date === todayStr) return;

                        const diff = closePrice - basePrice;
                        const rate = ((diff / basePrice) * 100).toFixed(2);

                        const newRecord = {
                            date: todayStr,
                            close: closePrice,
                            diff: diff,
                            rate: rate,
                            vol: volume,
                            amt: amount
                        };

                        // ìµœì‹  ë‚ ì§œê°€ ë§¨ ìœ„ë¡œ ì˜¤ë„ë¡ ì¶”ê°€
                        const newHistory = [newRecord, ...history];
                        
                        // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ set, ìˆìœ¼ë©´ update (ì—¬ê¸°ì„œëŠ” update ì‚¬ìš©í•˜ë˜ history í•„ë“œë§Œ ê°±ì‹ )
                        if (!sfDoc.exists()) {
                            transaction.set(docRef, { history: newHistory });
                        } else {
                            transaction.update(docRef, { history: newHistory });
                        }
                    });
                    console.log("Daily history recorded:", todayStr, closePrice);
                } catch (e) {
                    console.error("Failed to record daily history:", e);
                }
            }

            // ---- Event Handlers Setup ----
            els.btnChartLine.onclick = () => { state.chartType = 'line'; els.btnChartLine.classList.add('active'); els.btnChartCandle.classList.remove('active'); drawChart(); };
            els.btnChartCandle.onclick = () => { state.chartType = 'candle'; els.btnChartCandle.classList.add('active'); els.btnChartLine.classList.remove('active'); drawChart(); };

            els.btnBuy.onclick = () => { 
                // Removed checkMarketStatus() check here to allow opening modal
                openTradeModal('buy'); 
            };
            els.btnSell.onclick = () => { 
                // Removed checkMarketStatus() check here to allow opening modal
                openTradeModal('sell'); 
            };
            els.btnAdminBasePrice.onclick = async () => { const price = parseInt(els.basePriceInput.value); if (isNaN(price) || price <= 0) { showToast("ì˜¬ë°”ë¥¸ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'enjoy_ticker'); try { await window.updateDoc(docRef, { basePrice: price, basePriceLabel: "ì–´ì œë³´ë‹¤", lastUpdated: Date.now() }); showToast(`ê¸°ì¤€ê°€ê°€ ${fmt(price)}ì›ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`); els.basePriceInput.value = ''; } catch(e) { console.error(e); showToast("ì„¤ì • ì‹¤íŒ¨"); } };
            els.btnHome.onclick = () => { window.location.href = 'index.html'; };
            els.btnProfile.onclick = () => { els.loginModal.classList.remove('hidden'); els.inputPw.value = ''; setTimeout(() => els.inputPw.focus(), 100); };
            els.btnLoginCancel.onclick = () => { els.loginModal.classList.add('hidden'); };
            els.btnLoginConfirm.onclick = () => { const pw = els.inputPw.value; if (pw === '0920') { state.isAdmin = true; els.loginModal.classList.add('hidden'); els.adminPanel.classList.remove('hidden'); showToast("ê´€ë¦¬ì ê¶Œí•œ íšë“ ğŸ”“"); updateUI(); } else { showToast("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜ âŒ"); els.inputPw.value = ''; els.inputPw.focus(); } };
            
            els.btnAdminSurge.onclick = () => triggerSharpMove('surge'); 
            els.btnAdminCrash.onclick = () => triggerSharpMove('crash');
            els.btnAdminUp.onclick = () => setAdminTrend('up'); 
            els.btnAdminDown.onclick = () => setAdminTrend('down'); 
            els.btnMarketResume.onclick = () => setMarketStatus(false); 
            els.btnMarketPause.onclick = () => setMarketStatus(true); 
            els.btnLogout.onclick = () => { state.isAdmin = false; els.adminPanel.classList.add('hidden'); showToast("ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ"); updateUI(); };
            els.btnAdminDeposit.onclick = async () => { const amount = parseInt(els.depositInput.value); if (isNaN(amount) || amount <= 0) { showToast("ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”."); return; } const walletDocRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'stock_data', 'shared_wallet'); try { const snapshot = await window.getDoc(walletDocRef); const currentCash = snapshot.exists() ? (snapshot.data().cash || 0) : 0; await window.updateDoc(walletDocRef, { cash: currentCash + amount }); addHistoryLog('deposit', `ë°°ë‹¹ê¸ˆ ì…ê¸ˆ ${fmt(amount)}ì›`); showToast(`${fmt(amount)}ì› ê³µìš© ì…ê¸ˆ ì™„ë£Œ!`); els.depositInput.value = ''; } catch(e) { console.error("Deposit Error", e); } };

            // [NEW] ì˜¤ëŠ˜ ì¢…ê°€ ê°•ì œ ê¸°ë¡ ë²„íŠ¼ ì´ë²¤íŠ¸
            els.btnAdminRecordDaily.onclick = async () => {
                if (!confirm("í˜„ì¬ ê°€ê²©ìœ¼ë¡œ ì˜¤ëŠ˜ ì‹œì„¸ë¥¼ ê°•ì œ ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ê¸°ë¡ëœ ê²½ìš° ë®ì–´ì“°ê±°ë‚˜ ë¬´ì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) return;
                await recordDailyHistory(new Date(), state.currentPrice, state.basePrice, state.todayVolume, state.todayTradeAmount);
                showToast("ì˜¤ëŠ˜ ì‹œì„¸ ê¸°ë¡ ìš”ì²­ ì™„ë£Œ ğŸ’¾");
            };

            // [ìˆ˜ì •ë¨] ì§€ë‚œ ë°°ë‹¹ ë³´ê¸° ë²„íŠ¼ ê¸°ëŠ¥ ì—°ê²°
            els.btnViewDividends.onclick = () => {
                const depositLogs = state.tradeLogs.filter(log => log.type === 'deposit');
                
                if (depositLogs.length === 0) {
                    els.dividendListContent.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">ì•„ì§ ë°°ë‹¹ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    els.dividendListContent.innerHTML = depositLogs.map(log => {
                        const date = new Date(log.time);
                        const dateStr = `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
                        return `
                            <div class="flex justify-between items-center py-4 border-b border-gray-100 last:border-0">
                                <div>
                                    <span class="block text-xs text-gray-400 mb-1">${dateStr}</span>
                                    <span class="block text-sm font-bold text-[#191f28]">${log.detail}</span>
                                </div>
                                <span class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">ì…ê¸ˆì™„ë£Œ</span>
                            </div>
                        `;
                    }).join('');
                }
                els.dividendModal.classList.remove('hidden');
            };

            els.btnDividendClose.onclick = () => {
                els.dividendModal.classList.add('hidden');
            };

            function switchTab(tabName) { 
                state.tab = tabName; 
                [els.tabChart, els.tabOrder, els.tabDaily, els.tabWallet, els.tabInfo, els.tabAccount, els.tabHours].forEach(btn => btn.classList.remove('active')); 
                if(tabName === 'chart') els.tabChart.classList.add('active'); 
                if(tabName === 'order') els.tabOrder.classList.add('active'); 
                if(tabName === 'daily') els.tabDaily.classList.add('active'); 
                if(tabName === 'account') els.tabAccount.classList.add('active'); 
                if(tabName === 'wallet') els.tabWallet.classList.add('active'); 
                if(tabName === 'info') els.tabInfo.classList.add('active');
                if(tabName === 'hours') els.tabHours.classList.add('active');
                
                [els.viewChart, els.viewOrder, els.viewDaily, els.viewAccount, els.viewWallet, els.viewInfo, els.viewHours].forEach(view => {
                    view.classList.add('hidden');
                    view.classList.remove('flex');
                });

                if(tabName === 'chart') { els.viewChart.classList.remove('hidden'); resize(); drawChart(); } 
                else if(tabName === 'order') { els.viewOrder.classList.remove('hidden'); els.viewOrder.classList.add('flex'); renderOrderBook(); } 
                else if(tabName === 'daily') { els.viewDaily.classList.remove('hidden'); els.viewDaily.classList.add('flex'); renderDailyQuotes(); } 
                else if(tabName === 'account') { els.viewAccount.classList.remove('hidden'); els.viewAccount.classList.add('flex'); } 
                else if(tabName === 'wallet') { els.viewWallet.classList.remove('hidden'); els.viewWallet.classList.add('flex'); } 
                else if(tabName === 'info') { els.viewInfo.classList.remove('hidden'); els.viewInfo.classList.add('flex'); }
                else { els.viewHours.classList.remove('hidden'); els.viewHours.classList.add('flex'); }
            }
            els.tabChart.onclick = () => switchTab('chart'); els.tabOrder.onclick = () => switchTab('order'); els.tabDaily.onclick = () => switchTab('daily'); els.tabAccount.onclick = () => switchTab('account'); els.tabWallet.onclick = () => switchTab('wallet'); els.tabInfo.onclick = () => switchTab('info'); els.tabHours.onclick = () => switchTab('hours');
            
            // ---- Auth Listener (Calls the above functions) ----
            const initAuth = async () => { try { await window.signInAnonymously(window.auth); } catch (e) { console.error(e); } };
            initAuth();
            window.onAuthStateChanged(window.auth, (user) => { 
                if (user) { 
                    startSync(); 
                    startWalletSync(); 
                    startHistorySync(); 
                    startDailyHistorySync(); 
                    els.loadingOverlay.style.opacity = '0'; 
                    setTimeout(() => els.loadingOverlay.style.display = 'none', 500); 
                    resize(); 
                } 
            });
        });
    </script>
</body>
</html>